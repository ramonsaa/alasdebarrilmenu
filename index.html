<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GastroApp Pro - A-LAS DE BARRIL</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Fuentes Retro de Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Agregamos Alfa Slab One para el look "Cuadrado" -->
    <link href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Old+Standard+TT:ital,wght@0,400;0,700;1,400&family=Special+Elite&family=Alfa+Slab+One&display=swap" rel="stylesheet">

    <style>
        /* --- ESTILO RETRO GLOBAL --- */
        :root {
            --retro-cream: #f8f1e5;
            --retro-dark: #2c1e16;
            --retro-brown: #5c4033;
            --retro-red: #a63e3e;
            --retro-green: #557b55;
            --retro-yellow: #d4a353;
            --retro-blue: #4a6fa5;
        }

        body { 
            font-family: 'Old Standard TT', serif;
            background-color: var(--retro-cream);
            color: var(--retro-dark);
            user-select: none; 
            background-image: 
                linear-gradient(to right, rgba(92, 64, 51, 0.05) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(92, 64, 51, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        /* Fuentes Espec√≠ficas */
        .font-slab { font-family: 'Alfa Slab One', cursive; letter-spacing: 0.05em; } /* Nueva fuente cuadrada */
        .font-fancy { font-family: 'Abril Fatface', cursive; letter-spacing: 0.05em; }
        .font-typewriter { font-family: 'Special Elite', cursive; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @media print {
            body * { visibility: hidden; }
            #receipt-area, #receipt-area * { visibility: visible; }
            #receipt-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; color: black; }
            @page { margin: 0; size: auto; }
        }
        
        /* Botones */
        .btn-retro {
            @apply py-3 rounded-sm font-bold text-white shadow-md uppercase tracking-wide border-2 border-[#2c1e16] transition-all cursor-pointer font-slab;
            box-shadow: 3px 3px 0 #2c1e16;
        }
        .btn-retro:active { box-shadow: 1px 1px 0 #2c1e16; transform: translate(2px, 2px); }
        .btn-retro-green { background-color: var(--retro-green); }
        .btn-retro-blue { background-color: var(--retro-blue); }
        .btn-retro-red { background-color: var(--retro-red); }
        .btn-retro-dark { background-color: var(--retro-brown); color: var(--retro-cream); }
        .btn-retro-neutral { background-color: #dcdcdc; color: var(--retro-dark); border-color: #999; box-shadow: 3px 3px 0 #999; }
        .btn-retro-yellow { background-color: var(--retro-yellow); color: var(--retro-dark); }

        /* Tarjetas */
        .card-retro {
            @apply rounded-sm shadow-sm p-3 border-2 border-[#5c4033] relative cursor-pointer transition bg-[#fffdf9];
            box-shadow: 4px 4px 0 rgba(92, 64, 51, 0.3);
        }
        .card-retro:active { box-shadow: 2px 2px 0 rgba(92, 64, 51, 0.3); transform: translate(2px, 2px); }
        .card-retro-vip { background-color: #fff0e6; border-color: #cba135; }

        /* Botones Selecci√≥n */
        .option-btn { @apply border-2 rounded-sm p-2 text-center cursor-pointer transition-all font-bold text-[#5c4033] bg-[#fffdf9] border-[#a89f91] text-sm shadow-[2px_2px_0_#a89f91]; }
        .option-btn.clara.selected { background-color: var(--retro-yellow); border-color: var(--retro-brown); color: var(--retro-dark); box-shadow: 2px 2px 0 var(--retro-brown); }
        .option-btn.oscura.selected { background-color: var(--retro-brown); border-color: var(--retro-dark); color: var(--retro-cream); box-shadow: 2px 2px 0 var(--retro-dark); }
        
        .prep-radio { @apply border-2 rounded-sm p-2 text-center cursor-pointer transition-all font-medium text-[#5c4033] bg-[#fffdf9] border-[#a89f91] text-xs shadow-[2px_2px_0_#a89f91]; }
        .prep-radio.selected { background-color: var(--retro-blue); border-color: var(--retro-brown); color: var(--retro-cream); font-weight: 800; box-shadow: 2px 2px 0 var(--retro-brown); }

        .mod-btn { transition: all 0.1s; border-width: 2px; font-weight: 600; box-shadow: 2px 2px 0 var(--retro-brown); border-style: solid; }
        .mod-btn.btn-red { color: var(--retro-red); background-color: #fce8e8; border-color: var(--retro-red); }
        .mod-btn.btn-red.selected { background-color: var(--retro-red); color: var(--retro-cream); border-color: var(--retro-brown); }
        .mod-btn.btn-green { color: var(--retro-green); background-color: #e8fce8; border-color: var(--retro-green); }
        .mod-btn.btn-green.selected { background-color: var(--retro-green); color: var(--retro-cream); border-color: var(--retro-brown); }
        .mod-btn.btn-neutral { color: var(--retro-brown); background-color: #fffdf9; border-color: var(--retro-brown); }
        .mod-btn.btn-neutral.selected { background-color: var(--retro-brown); color: var(--retro-cream); border-color: var(--retro-dark); }

        .cat-header { font-size: 1rem; font-family: 'Alfa Slab One', cursive; text-transform: uppercase; color: var(--retro-brown); margin-top: 1.5rem; margin-bottom: 0.8rem; letter-spacing: 0.05em; border-bottom: 3px double var(--retro-brown); padding-bottom: 4px; text-align: center; }

        /* Inputs Retro */
        input, select {
            @apply border-2 border-[#a89f91] p-3 rounded-sm text-lg font-bold outline-none bg-[#fffdf9] text-[#5c4033] shadow-[inset_2px_2px_4px_rgba(92,64,51,0.1)];
            font-family: 'Special Elite', cursive;
        }
        
        .modal-retro { @apply bg-[#fffdf9] rounded-sm shadow-2xl w-full max-w-md overflow-hidden max-h-[90vh] flex flex-col border-4 border-double border-[#5c4033] shadow-[8px_8px_0_rgba(44,30,22,0.4)]; }
    </style>
</head>
<body>

    <div id="app" class="h-screen w-full flex flex-col overflow-hidden relative font-serif">
        <!-- Header -->
        <header id="main-header" class="bg-[#2c1e16] text-[#f8f1e5] p-3 shadow-md flex justify-between items-center z-10 shrink-0 relative border-b-[6px] border-double border-[#5c4033]" style="box-shadow: 0 4px 0 rgba(92, 64, 51, 0.5);">
            <div class="flex items-center gap-3">
                <div class="bg-[#f8f1e5] p-1 rounded-full border-4 border-double border-[#cba135] overflow-hidden w-14 h-14 flex items-center justify-center shadow-sm" style="box-shadow: 2px 2px 0 #cba135;">
                    <img src="https://www.dropbox.com/scl/fi/htapbd4yf4m239y9zv2n1/Picture1.png?rlkey=o8je5uxe95avc9i9od6dmpbqh&raw=1" alt="Logo" class="w-full h-full object-contain sepia" onerror="this.src='https://placehold.co/100x100?text=AB'">
                </div>
                <h1 class="font-bold text-2xl tracking-widest font-slab" id="header-title" style="text-shadow: 2px 2px 0 #000;">A-LAS DE BARRIL</h1>
            </div>
            
            <div id="status-indicator" class="hidden absolute left-1/2 transform -translate-x-1/2 px-4 py-1 rounded-sm border-2 border-double border-[#2c1e16] text-xs font-bold shadow-[2px_2px_0_#2c1e16] animate-pulse flex items-center gap-2 top-14 md:top-auto bg-[#a63e3e] text-[#f8f1e5] font-typewriter">
                <span id="status-text"></span>
            </div>

            <button onclick="logoutToHome()" class="text-xs bg-[#5c4033] border-2 border-[#f8f1e5] px-3 py-1.5 rounded-sm hover:bg-[#4a3328] transition uppercase font-bold tracking-wider text-[#f8f1e5] font-slab shadow-[2px_2px_0_#f8f1e5]">
                <i class="fa-solid fa-right-from-bracket"></i> Salir
            </button>
        </header>

        <!-- Contenido -->
        <main id="content-area" class="flex-1 overflow-y-auto bg-[#f8f1e5] relative flex flex-col p-2" style="background-image: url('data:image/svg+xml,%3Csvg width=\'40\' height=\'40\' viewBox=\'0 0 40 40\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'%235c4033\' fill-opacity=\'0.05\' fill-rule=\'evenodd\'%3E%3Cpath d=\'M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41zM20 18.6l2.83-2.83 1.41 1.41L21.41 20l2.83 2.83-1.41 1.41L20 21.41l-2.83 2.83-1.41-1.41L18.59 20l-2.83-2.83 1.41-1.41L20 18.59z\'/%3E%3C/g%3E%3C/svg%3E');">
            <div class="flex flex-col justify-center items-center h-full text-[#5c4033] opacity-50 gap-4 font-typewriter">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl"></i>
                <p class="text-sm font-bold animate-pulse">Cargando sistema...</p>
            </div>
        </main>

        <div id="receipt-area" class="hidden bg-[#fffdf9] p-4 text-xs w-[300px] mx-auto font-mono border-4 double border-[#5c4033] text-[#2c1e16]"></div>
    </div>

    <!-- Modales -->
    <div id="modal-overlay" class="fixed inset-0 bg-[#2c1e16] bg-opacity-80 hidden z-50 flex justify-center items-center p-4 backdrop-blur-sm">
        <div id="modal-content" class="modal-retro"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp, enableIndexedDbPersistence, runTransaction } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBqrR3FQ7L7KCE5Wg8thRvyA6GpiUV2DPs",
            authDomain: "alasdebarrilwings.firebaseapp.com",
            projectId: "alasdebarrilwings",
            storageBucket: "alasdebarrilwings.firebasestorage.app",
            messagingSenderId: "826542576836",
            appId: "1:826542576836:web:dd1bc6f8bc4fd73d57a591"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app);
            enableIndexedDbPersistence(db).catch(err => console.warn("Offline persistence:", err.code));
        } catch (e) { showError("Error de Configuraci√≥n", e.message); }

        function updateStatusDisplay() {
            const ind = document.getElementById('status-indicator');
            const txt = document.getElementById('status-text');
            if (!navigator.onLine) {
                ind.classList.remove('hidden'); txt.innerHTML = '<i class="fa-solid fa-wifi"></i> MODO OFFLINE';
            } else { ind.classList.add('hidden'); }
        }
        window.addEventListener('online', updateStatusDisplay);
        window.addEventListener('offline', updateStatusDisplay);
        updateStatusDisplay();

        function showError(title, details) { document.getElementById('content-area').innerHTML = `<div class="flex flex-col justify-center items-center h-full p-6 text-center"><h2 class="font-bold text-2xl text-[#a63e3e] font-slab">${title}</h2><p class="text-[#5c4033] font-typewriter mt-2">${details}</p><button onclick="location.reload()" class="mt-6 btn-retro btn-retro-dark px-6 py-2">Reintentar</button></div>`; }

        let currentUser = null, ordersData = [], tablesData = [];
        let currentRole = null, currentTableId = null, showingDebts = false;

        const MODIFIERS = {
            burgers: ["Sin cebolla", "Sin jitomate", "Sin pi√±a", "Sin picante", "Sin catsup", "Sin mayonesa", "Sin queso", "Sin jam√≥n", "Sin carne"],
            hotdogs: ["Sin jitomate", "Sin cebolla", "Sin pi√±a", "Sin picante", "Sin catsup", "Sin mayonesa", "Sin salchicha", "Sin tocino"],
            salsas: ["Bbq", "Mango", "Habanero", "Tamarindo", "Jamaica", "Frutos rojos", "Pi√±a", "Chipotle", "B√∫falo", "Lemon pepper", "A la diabla"],
            snacks: ["Sin queso", "Sin crema", "Sin catsup", "Sin salsa", "Sin vegetales"],
            sodas: ["Coca", "Boing Mango", "Boing Guayaba", "Manzanita", "Jarrito", "Squirt"],
            coolers: ["Durazno", "Fresa", "Vino", "Manzana Kiwi"],
            general_kitchen: ["Para llevar", "Sin cubiertos"],
            general_bar: ["Poca az√∫car", "Sin popote"],
            package_options: ["Con Papas", "Con Aros de Cebolla", "Con Alitas", "Con Boneless", "Salsa BBQ", "Salsa Buffalo", "Salsa Mango", "Salsa Habanero"]
        };

        const MENU = [
            { id: 'b_md', name: 'Barril 1/2 Lt', price: 35, category: 'bar', isBeer: true, type: 'regular', icon: 'fa-beer-mug-empty' },
            { id: 'b_1l', name: 'Barril 1 Lt', price: 70, category: 'bar', isBeer: true, type: 'regular', icon: 'fa-beer-mug-empty' },
            { id: 'b_md_negra', name: 'Barril Negra 1/2 Lt', price: 45, category: 'bar', isBeer: true, type: 'dark', icon: 'fa-beer-mug-empty' },
            { id: 'b_1l_negra', name: 'Barril Negra 1 Lt', price: 90, category: 'bar', isBeer: true, type: 'dark', icon: 'fa-beer-mug-empty' },
            { id: 'b_emb', name: 'Cerveza Embotellada', price: 30, category: 'bar', isBeer: true, type: 'bottled', icon: 'fa-bottle-droplet' },
            { id: 'b_cig', name: 'Cigarro', price: 7, category: 'bar', modGroup: 'general_bar', icon: 'fa-smoking' },
            { id: 'b_ref', name: 'Refresco', price: 25, category: 'bar', modGroup: 'sodas', icon: 'fa-bottle-water' },
            { id: 'b_coo', name: 'Caribe Cooler', price: 30, category: 'bar', modGroup: 'coolers', icon: 'fa-wine-bottle' },
            { id: 'h1', name: 'Hamburguesa Sencilla', price: 55, category: 'kitchen', modGroup: 'burgers', icon: 'fa-burger' },
            { id: 'h2', name: 'Hamburguesa Especial', price: 70, category: 'kitchen', modGroup: 'burgers', icon: 'fa-burger' },
            { id: 'h3', name: 'Hamburguesa Arrachera', price: 90, category: 'kitchen', modGroup: 'burgers', icon: 'fa-burger' },
            { id: 'h4', name: 'Hamburguesa Camar√≥n', price: 80, category: 'kitchen', modGroup: 'burgers', icon: 'fa-shrimp' },
            { id: 'h5', name: 'Hamburguesa Pollo', price: 65, category: 'kitchen', modGroup: 'burgers', icon: 'fa-drumstick-bite' },
            { id: 'c1', name: 'Tenders de Pollo', price: 75, category: 'kitchen', modGroup: 'salsas', icon: 'fa-drumstick-bite' },
            { id: 'c2', name: 'Boneless', price: 70, category: 'kitchen', modGroup: 'salsas', icon: 'fa-drumstick-bite' },
            { id: 'c3', name: 'Alitas', price: 50, category: 'kitchen', modGroup: 'salsas', icon: 'fa-dove' },
            { id: 's1', name: 'Papas a la francesa', price: 40, category: 'kitchen', modGroup: 'snacks', icon: 'fa-utensils' },
            { id: 's2', name: 'Salchipapas', price: 50, category: 'kitchen', modGroup: 'snacks', icon: 'fa-bacon' },
            { id: 's3', name: 'Aros de Cebolla', price: 45, category: 'kitchen', modGroup: 'snacks', icon: 'fa-ring' },
            { id: 'hd1', name: 'Hot Dog Sencillo', price: 25, category: 'kitchen', modGroup: 'hotdogs', icon: 'fa-hotdog' },
            { id: 'hd2', name: 'Hot Dog Especial', price: 40, category: 'kitchen', modGroup: 'hotdogs', icon: 'fa-hotdog' },
            { id: 'p1', name: 'Paquete 1', price: 235, category: 'kitchen', isPackage: true, icon: 'fa-box-open' },
            { id: 'p2', name: 'Paquete 2', price: 255, category: 'kitchen', isPackage: true, icon: 'fa-box-open' },
            { id: 'p3', name: 'Paquete 3', price: 310, category: 'kitchen', isPackage: true, icon: 'fa-box-open' },
        ];

        async function initApp() { try { await signInAnonymously(auth); } catch (e) { console.error(e); showError("Auth Error", e.message); } }
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                onSnapshot(collection(db, 'tables'), s => { tablesData = s.docs.map(d=>({id:d.id, ...d.data()})); refreshCurrentView(); });
                onSnapshot(collection(db, 'orders'), s => { ordersData = s.docs.map(d=>({id:d.id, ...d.data()})); refreshCurrentView(); });
                renderHome();
            }
        });

        function refreshCurrentView() {
            if(!currentRole) return;
            if(currentRole === 'waiter') currentTableId ? renderTableDetail(currentTableId) : renderWaiterDashboard();
            else if(currentRole === 'kitchen') renderBoard('kitchen');
            else if(currentRole === 'bar') renderBoard('bar');
        }

        window.renderHome = () => {
            currentRole = null;
            document.getElementById('header-title').innerText = 'A-LAS DE BARRIL';
            document.getElementById('content-area').innerHTML = `
                <div class="p-6 flex flex-col gap-6 h-full justify-center items-center max-w-md mx-auto">
                    <div class="p-2 bg-[#fffdf9] border-4 border-double border-[#cba135] rounded-full shadow-[4px_4px_0_#5c4033]">
                        <img src="https://www.dropbox.com/scl/fi/jymn0kvgyx9ioqjojwbfw/Picture2.png?rlkey=u4k3ppl3f7vohb07au7bt8tw4&raw=1" class="w-48 rounded-full sepia" alt="Logo" onerror="this.src='https://placehold.co/200x200?text=LOGO'">
                    </div>
                    <h2 class="text-3xl font-bold text-[#5c4033] mb-4 pb-2 border-b-[3px] double border-[#cba135] uppercase tracking-widest font-slab" style="text-shadow: 1px 1px 0 #f8f1e5;">Selecciona Perfil</h2>
                    <button onclick="setRole('waiter')" class="w-full btn-retro btn-retro-yellow p-6 text-2xl flex gap-4 items-center"><div class="bg-[#5c4033] p-3 rounded-full text-[#f8f1e5] border-2 border-[#f8f1e5]"><i class="fa-solid fa-mobile-screen"></i></div><span>Mesero</span></button>
                    <button onclick="setRole('bar')" class="w-full btn-retro btn-retro-dark p-6 text-2xl flex gap-4 items-center"><div class="bg-[#cba135] p-3 rounded-full text-[#2c1e16] border-2 border-[#2c1e16]"><i class="fa-solid fa-beer-mug-empty"></i></div><span>Barra</span></button>
                    <button onclick="setRole('kitchen')" class="w-full btn-retro btn-retro-red p-6 text-2xl flex gap-4 items-center"><div class="bg-[#2c1e16] p-3 rounded-full text-[#f8f1e5] border-2 border-[#f8f1e5]"><i class="fa-solid fa-fire-burner"></i></div><span>Cocina</span></button>
                </div>`;
        }
        window.setRole = (r) => { currentRole = r; refreshCurrentView(); }

        window.renderWaiterDashboard = () => {
            currentTableId = null;
            document.getElementById('header-title').innerText = 'Control de Mesas';
            const now = Date.now();
            const eightDaysMs = 8 * 24 * 60 * 60 * 1000;
            const openTables = tablesData.filter(t => t.status === 'open').sort((a,b) => (b.openedAt?.seconds||0) - (a.openedAt?.seconds||0));
            const debtTables = tablesData.filter(t => t.status === 'debt').sort((a,b) => (b.debtDate?.seconds||0) - (a.debtDate?.seconds||0));
            const closedTables = tablesData.filter(t => {
                if (t.status !== 'closed') return false;
                const closedDate = t.closedAt?.seconds * 1000 || 0;
                return (now - closedDate) < eightDaysMs;
            }).sort((a,b) => (b.closedAt?.seconds||0) - (a.closedAt?.seconds||0));
            
            const btnClass = showingDebts ? 'btn-retro-red' : 'btn-retro-dark';
            const sectionTitle = showingDebts ? 'Deudas Pendientes' : 'Mesas Abiertas';

            let html = `
                <div class="p-4 flex flex-col gap-6 pb-24">
                    <div class="flex gap-2 bg-[#fffdf9] p-2 rounded-sm shadow-[2px_2px_0_#5c4033] border-2 border-[#5c4033]">
                        <input type="number" id="search-ticket-id" placeholder="Buscar Ticket #" class="flex-1 border-0 p-2 bg-transparent outline-none text-[#5c4033] placeholder-[#a89f91] font-typewriter font-bold" style="box-shadow: none;">
                        <button onclick="searchTicket()" class="bg-[#5c4033] text-[#f8f1e5] px-4 rounded-sm hover:bg-[#4a3328] border-2 border-[#2c1e16]" style="font-family: 'Abril Fatface', cursive;"><i class="fa-solid fa-search"></i></button>
                    </div>
                    <div class="flex gap-3"><button onclick="toggleDebtView()" class="flex-1 btn-retro ${btnClass} py-3 text-sm">${showingDebts ? '‚¨Ö Ver Mesas Activas' : 'üìÇ Ver Deudas / Fiado'}</button></div>
                    <div>
                        <div class="flex justify-between items-end mb-3 border-b-[3px] double border-[#5c4033] pb-1">
                            <h3 class="font-black text-[#5c4033] text-xl uppercase tracking-wider font-slab">${sectionTitle}</h3>
                            ${!showingDebts ? `<button onclick="openNewTableModal()" class="btn-retro btn-retro-green text-xs px-3 py-2 flex items-center gap-1"><i class="fa-solid fa-plus"></i> NUEVA</button>` : ''}
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            ${!showingDebts && openTables.length === 0 ? '<p class="col-span-2 text-[#a89f91] text-sm text-center italic py-4 bg-[#fffdf9] rounded-sm border-2 border-dashed border-[#a89f91] font-typewriter">No hay mesas abiertas</p>' : ''}
                            ${showingDebts && debtTables.length === 0 ? '<p class="col-span-2 text-[#a89f91] text-sm text-center italic py-4 bg-[#fffdf9] rounded-sm border-2 border-dashed border-[#a89f91] font-typewriter">No hay deudas</p>' : ''}
                            ${!showingDebts ? openTables.map(t => createTableCard(t)).join('') : debtTables.map(t => createTableCard(t)).join('')}
                        </div>
                    </div>
                    ${!showingDebts ? `<div class="mt-6 opacity-80"><h3 class="font-bold text-[#5c4033] text-lg uppercase mb-3 border-b-[3px] double border-[#5c4033] pb-1 font-slab">Cerradas (8 d√≠as)</h3><div class="grid grid-cols-2 gap-4">${closedTables.length ? closedTables.map(t => createTableCard(t)).join('') : '<p class="col-span-2 text-[#a89f91] text-xs text-center font-typewriter">Historial vac√≠o</p>'}</div></div>` : ''}
                </div>`;
            document.getElementById('content-area').innerHTML = html;
        }

        function createTableCard(t) {
            const ords = ordersData.filter(o => o.tableId === t.id && o.status !== 'cancelled');
            const total = ords.reduce((a,c) => a + (c.price * c.quantity), 0);
            const deposit = t.deposit || 0;
            const remaining = total - deposit;
            let cardBgClass = '', borderColor = 'border-[#5c4033]', badge = '', statusIconColor = 'text-[#5c4033]';
            
            if (t.isVip) { cardBgClass = 'card-retro-vip'; borderColor = 'border-[#cba135]'; }
            if (t.status === 'open') {
                const pending = ords.some(o => o.status !== 'delivered');
                borderColor = pending ? 'border-[#d4a353]' : 'border-[#557b55]';
                statusIconColor = pending ? 'text-[#d4a353]' : 'text-[#557b55]';
                badge = pending ? `<i class="fa-solid fa-clock animate-pulse ${statusIconColor}"></i>` : `<i class="fa-solid fa-check ${statusIconColor}"></i>`;
            } else if (t.status === 'debt') { borderColor = 'border-[#a63e3e]'; cardBgClass = 'bg-[#fce8e8]'; statusIconColor = 'text-[#a63e3e]'; badge = `<i class="fa-solid fa-file-invoice-dollar ${statusIconColor}"></i>`;
            } else { cardBgClass = 'bg-[#e0d8c8]'; statusIconColor = 'text-[#a89f91]'; badge = `<i class="fa-solid fa-lock ${statusIconColor}"></i>`; }
            
            let vipBadge = t.isVip ? `<span class="absolute -top-3 -left-3 bg-[#cba135] text-[#2c1e16] text-[10px] px-3 py-1 rounded-sm font-bold shadow-[2px_2px_0_#2c1e16] border-2 border-[#2c1e16]" style="font-family: 'Abril Fatface', cursive;"><i class="fa-solid fa-crown"></i> VIP</span>` : '';
            let priceDisplay = `$${total}`; if (deposit > 0) priceDisplay = `<span class="text-xs text-[#a63e3e] line-through mr-1 font-mono">$${total}</span> $${remaining}`;
            const dateStr = t.openedAt ? new Date(t.openedAt.seconds * 1000).toLocaleString('es-MX', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }).replace(',', '') : '';

            // --- CORRECCI√ìN: APODO GRANDE, MESA PEQUE√ëA ---
            return `<div onclick="renderTableDetail('${t.id}')" class="card-retro ${cardBgClass} ${borderColor}">
                    ${vipBadge}
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[11px] font-mono font-bold text-[#5c4033] bg-[#e0d8c8] px-2 py-0.5 rounded-sm border-2 border-[#a89f91] shadow-[1px_1px_0_#a89f91]">#${t.uniqueId || '---'}</span>
                        <div class="flex flex-col items-end">
                             <span class="text-[10px] text-[#5c4033] font-mono mb-0.5 font-bold">${dateStr}</span>
                             <div class="bg-[#fffdf9] border-2 border-[#a89f91] rounded-full p-1 shadow-[1px_1px_0_#a89f91]">${badge}</div>
                        </div>
                    </div>
                    <div class="text-3xl font-black text-[#2c1e16] leading-tight mb-1 text-center font-slab" style="text-shadow: 1px 1px 0 #cba135; overflow-wrap: break-word;">${t.nickname}</div>
                    <div class="text-xs text-[#5c4033] font-bold mb-3 uppercase tracking-wider text-center font-typewriter border-b-2 border-dashed border-[#a89f91] pb-1">Mesa #${t.number}</div>
                    <div class="text-xl font-bold text-[#2c1e16] text-right pt-1 font-typewriter">${priceDisplay}</div>
                </div>`;
        }

        window.toggleDebtView = () => { showingDebts = !showingDebts; renderWaiterDashboard(); }
        window.searchTicket = async () => { const id=parseInt(document.getElementById('search-ticket-id').value); if(!id)return; const found=tablesData.find(t=>t.uniqueId===id); if(found)renderTableDetail(found.id); else alert("No encontrado"); }

        // --- FUNCI√ìN DE BORRADO INTELIGENTE ---
        window.deleteOrder = async (orderId, currentQty, itemName) => {
            event.stopPropagation(); 
            if (currentQty > 1) {
                openDeleteQuantityModal(orderId, currentQty, itemName);
            } else {
                if(confirm(`¬øBorrar "${itemName}" de la cuenta?`)) {
                    try { await deleteDoc(doc(db, 'orders', orderId)); } catch(e) { alert("Error: " + e.message); }
                }
            }
        }

        window.openDeleteQuantityModal = (orderId, currentQty, itemName) => {
             document.getElementById('modal-content').innerHTML = `
                <div class="p-6 text-center bg-[#f8f1e5] modal-retro border-0 shadow-none">
                    <h3 class="font-black text-xl mb-4 text-[#a63e3e] font-slab border-b-2 border-[#a63e3e] pb-2 inline-block">BORRAR ART√çCULO</h3>
                    <p class="mb-2 text-[#5c4033] text-sm font-typewriter">Hay <strong>${currentQty}</strong> ordenados de:<br><span class="text-[#2c1e16] font-bold text-lg font-fancy">${itemName}</span></p>
                    <p class="mb-4 text-[#a89f91] text-xs uppercase tracking-widest font-bold">¬øCu√°ntos eliminar?</p>
                    
                    <div class="flex justify-center items-center gap-6 mb-6 bg-[#fffdf9] p-3 rounded-sm border-2 border-[#a89f91] shadow-inner">
                         <button onclick="adjDelQty(-1)" class="w-12 h-12 rounded-full bg-[#e0d8c8] text-[#5c4033] font-bold text-2xl border-2 border-[#a89f91] shadow-[2px_2px_0_#a89f91] active:translate-y-1 active:shadow-none transition">-</button>
                         <span id="del-qty-val" class="text-4xl font-black text-[#a63e3e] font-typewriter">1</span>
                         <button onclick="adjDelQty(1, ${currentQty})" class="w-12 h-12 rounded-full bg-[#a63e3e] text-[#f8f1e5] font-bold text-2xl border-2 border-[#2c1e16] shadow-[2px_2px_0_#2c1e16] active:translate-y-1 active:shadow-none transition">+</button>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="closeModal()" class="flex-1 btn-retro btn-retro-neutral py-3 text-[#5c4033]">Cancelar</button>
                        <button onclick="confirmDelete('${orderId}', ${currentQty})" class="flex-1 btn-retro btn-retro-red py-3">Eliminar</button>
                    </div>
                </div>`;
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        window.adjDelQty = (delta, max) => {
            const el = document.getElementById('del-qty-val');
            let val = parseInt(el.innerText) + delta;
            if (val < 1) val = 1;
            if (max && val > max) val = max;
            el.innerText = val;
        }

        window.confirmDelete = async (orderId, currentQty) => {
            const qtyToDelete = parseInt(document.getElementById('del-qty-val').innerText);
            if (qtyToDelete >= currentQty) {
                await deleteDoc(doc(db, 'orders', orderId));
            } else {
                await updateDoc(doc(db, 'orders', orderId), { quantity: currentQty - qtyToDelete });
            }
            closeModal();
        }

        window.renderTableDetail = (tid) => {
            currentTableId = tid;
            const t = tablesData.find(x => x.id === tid);
            if(!t) return renderWaiterDashboard();
            const uniqueDisplay = t.uniqueId ? `#${t.uniqueId}` : '';
            const ords = ordersData.filter(o => o.tableId === tid && o.status !== 'cancelled').sort((a,b) => b.timestamp?.seconds - a.timestamp?.seconds);
            const total = ords.reduce((a,c) => a + (c.price * c.quantity), 0);
            const deposit = t.deposit || 0;
            const remaining = total - deposit;

            const isClosed = t.status === 'closed';
            let closeBtnText = t.status === 'debt' ? "Liquidar Deuda" : "Cerrar Cuenta";
            let closeBtnColorClass = t.status === 'debt' ? "btn-retro-blue" : "btn-retro-green";
            
            let totalDisplay = `<div class="flex justify-between mb-3 font-black text-2xl text-[#2c1e16] px-2" style="font-family: 'Special Elite', cursive;"><span style="font-family: 'Abril Fatface', cursive;">Total</span><span>$${total}</span></div>`;
            if (deposit > 0) totalDisplay = `<div class="flex justify-between text-sm text-[#5c4033] font-mono"><span>Subtotal</span><span>$${total}</span></div><div class="flex justify-between text-sm text-[#a63e3e] font-mono"><span>A cuenta</span><span>-$${deposit}</span></div><div class="flex justify-between font-black text-2xl text-[#2c1e16] border-t-4 double border-[#5c4033] pt-2 mt-2" style="font-family: 'Special Elite', cursive;"><span style="font-family: 'Abril Fatface', cursive;">Restante</span><span>$${remaining}</span></div>`;
            
            let footerHtml = isClosed ? `<div id="order-footer" class="fixed bottom-0 w-full bg-[#e0d8c8] p-4 shadow-[0_-4px_0_rgba(92,64,51,0.8)] z-30 border-t-[3px] double border-[#5c4033]"><div class="flex justify-between mb-3 font-bold text-2xl text-[#2c1e16] px-2" style="font-family: 'Special Elite', cursive;"><span style="font-family: 'Abril Fatface', cursive;">Total Final</span><span>$${total}</span></div><div class="flex gap-3"><button onclick="printR('${tid}')" class="flex-1 btn-retro btn-retro-dark py-3"><i class="fa-solid fa-print"></i> Ticket</button><button onclick="downloadPDF('${tid}')" class="flex-1 btn-retro btn-retro-red py-3"><i class="fa-solid fa-file-pdf"></i> PDF</button></div><div class="text-center text-xs text-[#a63e3e] mt-3 font-bold uppercase tracking-[0.2em] font-mono border-t-2 border-dashed border-[#a63e3e] pt-2">MESA CERRADA - ARCHIVO</div></div>` : 
            `<div id="order-footer" class="fixed bottom-0 w-full bg-[#fffdf9] p-4 shadow-[0_-4px_0_rgba(92,64,51,0.3)] z-30 border-t-[3px] double border-[#cba135]">${totalDisplay}<button onclick="openCloseAccountModal('${tid}', ${total})" class="w-full btn-retro ${closeBtnColorClass} py-4 text-lg mt-2">${closeBtnText}</button></div>`;
            
            const pageBgClass = t.isVip ? 'bg-[#fff0e6]' : 'bg-[#fffdf9]';
            const vipHeader = t.isVip ? `<span class="ml-3 bg-[#cba135] text-[#2c1e16] text-[11px] px-3 py-1 rounded-sm font-bold shadow-[2px_2px_0_#2c1e16] border-2 border-[#2c1e16]" style="font-family: 'Abril Fatface', cursive;"><i class="fa-solid fa-crown"></i> VIP</span>` : '';

            let html = `<div class="flex flex-col h-full ${pageBgClass}">
                <div class="bg-[#2c1e16] text-[#f8f1e5] p-3 flex items-center justify-between shadow-[0_4px_0_rgba(92,64,51,0.5)] shrink-0 border-b-[4px] double border-[#cba135]">
                    <button onclick="renderWaiterDashboard()" class="text-[#f8f1e5] font-bold text-sm flex items-center gap-2 hover:text-[#cba135] transition" style="font-family: 'Abril Fatface', cursive;"><i class="fa-solid fa-chevron-left"></i> Volver</button>
                    <div class="text-center"><div class="font-black text-xl leading-none flex items-center justify-center tracking-wider" style="font-family: 'Abril Fatface', cursive; text-shadow: 1px 1px 0 #cba135;">MESA ${t.number} ${vipHeader}</div><div class="text-[11px] font-mono text-[#cba135] opacity-90 mt-1 font-bold">Ticket ${uniqueDisplay}</div></div><div class="w-14"></div>
                </div>
                <div class="bg-[#fffdf9] shadow-[0_2px_0_#a89f91] flex border-b-2 border-[#a89f91] shrink-0">
                    <button onclick="switchTab('menu')" id="tab-btn-menu" class="flex-1 py-3 text-[#2c1e16] border-b-4 border-[#cba135] bg-[#fff0e6] font-bold tracking-wide font-fancy">MEN√ö</button>
                    <button onclick="switchTab('orders')" id="tab-btn-orders" class="flex-1 py-3 text-[#a89f91] font-bold hover:bg-[#fff0e6] transition tracking-wide font-fancy">CUENTA</button>
                </div>
                <div id="tab-menu" class="flex-1 overflow-y-auto p-4 pb-32 ${isClosed ? 'hidden' : ''} bg-[#f8f1e5]"><h3 class="cat-header">Cocina</h3><div class="grid gap-3 mb-8">${renderMenuSection('kitchen')}</div><h3 class="cat-header">Barra</h3><div class="grid gap-3">${renderMenuSection('bar')}</div></div>
                <div id="tab-orders" class="${isClosed ? '' : 'hidden'} flex-1 overflow-y-auto p-4 pb-52 ${t.isVip ? 'bg-[#fff0e6]' : 'bg-[#fffdf9]'}">
                    ${ords.length === 0 ? '<div class="text-center py-10 text-[#a89f91] italic font-mono border-2 border-dashed border-[#a89f91] p-4 rounded-sm m-4 bg-[#fffdf9]">Mesa vac√≠a - Sin pedidos</div>' : ''}
                    ${ords.map(o => {
                        let stClass = "bg-[#e0d8c8] text-[#5c4033] border-[#a89f91]", stIcon = "fa-clock";
                        if(o.status === 'preparing') { stClass = "bg-[#fff9c4] text-[#d4a353] border-[#d4a353]"; stIcon = "fa-fire"; }
                        if(o.status === 'ready') { stClass = "bg-[#e8fce8] text-[#557b55] border-[#557b55]"; stIcon = "fa-bell"; }
                        if(o.status === 'delivered') { stClass = "bg-[#d0e0ff] text-[#4a6fa5] border-[#4a6fa5]"; stIcon = "fa-thumbs-up"; }
                        const itemBgClass = t.isVip ? 'bg-[#fff5ee] border-[#cba135]' : 'bg-[#fffdf9] border-[#a89f91]';
                        
                        return `<div class="${itemBgClass} p-3 rounded-sm shadow-[2px_2px_0_#a89f91] mb-3 border-2 relative overflow-hidden">
                        ${t.isVip ? '<div class="absolute top-0 right-0 w-0 h-0 border-t-[30px] border-r-[30px] border-t-transparent border-r-[#cba135]/30"></div>' : ''}
                        <div class="flex justify-between items-start relative z-10">
                            <div><div class="font-bold text-[#2c1e16] text-xl leading-tight flex items-center gap-2" style="font-family: 'Abril Fatface', cursive;">
                                <span class="text-[#a63e3e]">${o.quantity}x</span> ${o.itemName}
                                ${!isClosed ? `<button onclick="event.stopPropagation(); deleteOrder('${o.id}', ${o.quantity}, '${o.itemName}')" class="text-[#a63e3e] hover:text-red-700 ml-1 bg-transparent border-none cursor-pointer"><i class="fa-solid fa-trash-can"></i></button>` : ''}
                            </div>
                                ${o.modifiers&&o.modifiers.length?`<div class="text-[11px] text-[#a63e3e] font-bold mt-2 bg-[#fce8e8] p-1.5 rounded-sm inline-block border-2 border-[#a63e3e] font-mono shadow-[1px_1px_0_#a63e3e]"><i class="fa-solid fa-pen-to-square mr-1"></i> ${o.modifiers.join(', ')}</div>`:''}
                                <div class="text-[10px] text-[#a89f91] mt-1 font-mono font-bold flex items-center gap-1"><i class="fa-regular fa-clock"></i> ${new Date(o.timestamp?.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div></div>
                            <div class="text-right flex flex-col items-end gap-2">
                                <div class="font-black text-[#5c4033] text-xl" style="font-family: 'Special Elite', cursive;">$${o.price*o.quantity}</div>
                                <span class="text-[10px] font-bold px-2 py-1 rounded-sm flex items-center gap-1 justify-end border-2 uppercase tracking-wider shadow-[1px_1px_0_rgba(0,0,0,0.2)] ${stClass}" style="font-family: 'Abril Fatface', cursive;"><i class="fa-solid ${stIcon}"></i> ${o.status}</span>
                            </div>
                        </div></div>`;
                    }).join('')}
                </div>
                ${footerHtml}</div>`;
            document.getElementById('content-area').innerHTML = html;
        }

        // ... Resto de funciones (renderMenuSection, openCustomizeModal, submitOrder, etc. IGUAL QUE ANTES)
        // Se mantienen exactamente igual para ahorrar espacio, solo se actualiz√≥ createTableCard y renderTableDetail

        function renderMenuSection(cat) {
            return MENU.filter(i => i.category === cat).map(i => `
                <button onclick="openCustomizeModal('${i.id}')" class="bg-[#fffdf9] p-3 rounded-sm shadow-[2px_2px_0_#a89f91] flex justify-between items-center text-left active:bg-[#fff0e6] border-2 border-[#a89f91] active:border-[#cba135] transition group relative overflow-hidden active:translate-x-[1px] active:translate-y-[1px] active:shadow-[1px_1px_0_#a89f91]">
                    <div class="flex items-center gap-4 relative z-10">
                        <div class="w-12 h-12 bg-[#e0d8c8] rounded-full flex items-center justify-center text-[#5c4033] group-active:scale-110 transition border-2 border-[#a89f91] shadow-[1px_1px_0_#a89f91] text-xl"><i class="fa-solid ${i.icon}"></i></div>
                        <div><div class="font-bold text-lg text-[#2c1e16] group-active:text-[#a63e3e]" style="font-family: 'Abril Fatface', cursive;">${i.name}</div><div class="text-sm text-[#5c4033] font-mono font-bold">$${i.price}</div></div>
                    </div>
                    <div class="bg-[#cba135] text-[#2c1e16] w-10 h-10 rounded-full flex items-center justify-center font-bold shadow-[2px_2px_0_#2c1e16] group-active:bg-[#2c1e16] group-active:text-[#cba135] transition border-2 border-[#2c1e16] text-lg relative z-10"><i class="fa-solid fa-plus"></i></div>
                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-transparent to-[#fff0e6]/50 opacity-0 group-active:opacity-100 transition"></div>
                </button>`).join('');
        }
        // (Las dem√°s funciones openCustomizeModal, submitOrder, etc. son las mismas de la respuesta anterior, solo se actualiza el HTML visual del detalle)

        initApp();
    </script>
</body>
</html>


