<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GastroApp Pro - A-LAS DE BARRIL</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* Tipograf√≠a y Fondo R√∫stico */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #fffbeb; 
            color: #451a03; 
            user-select: none; 
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @media print {
            body * { visibility: hidden; }
            #receipt-area, #receipt-area * { visibility: visible; }
            #receipt-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; color: black; }
            @page { margin: 0; size: auto; }
        }
        
        /* ESTILOS PERSONALIZADOS */
        .option-btn { @apply border-2 rounded-lg p-2 text-center cursor-pointer transition-all font-bold text-stone-600 bg-white border-stone-300 text-sm; }
        .option-btn.clara.selected { background-color: #fef9c3; border-color: #facc15; color: #854d0e; }
        .option-btn.oscura.selected { background-color: #451a03; border-color: #78350f; color: #fef3c7; }
        
        .prep-radio { @apply border-2 rounded-lg p-2 text-center cursor-pointer transition-all font-medium text-stone-500 bg-white border-stone-300 text-xs; }
        .prep-radio.selected { background-color: #e0f2fe; border-color: #0284c7; color: #0c4a6e; font-weight: 800; }

        .mod-btn { transition: all 0.2s; border-width: 1px; font-weight: 600; }
        .mod-btn.btn-red { color: #991b1b; background-color: #fef2f2; border-color: #fca5a5; }
        .mod-btn.btn-red.selected { background-color: #b91c1c; color: white; border-color: #7f1d1d; }
        .mod-btn.btn-green { color: #166534; background-color: #f0fdf4; border-color: #86efac; }
        .mod-btn.btn-green.selected { background-color: #15803d; color: white; border-color: #14532d; }
        .mod-btn.btn-neutral { color: #57534e; background-color: white; border-color: #d6d3d1; }
        .mod-btn.btn-neutral.selected { background-color: #a8a29e; color: white; border-color: #57534e; }
        
        .cat-header { font-size: 0.85rem; font-weight: 900; text-transform: uppercase; color: #78350f; margin-top: 1.5rem; margin-bottom: 0.5rem; letter-spacing: 0.05em; border-bottom: 2px solid #d6d3d1; padding-bottom: 2px; }
        .wood-shadow { box-shadow: 2px 4px 6px rgba(69, 26, 3, 0.15); }

        /* Estilo para secciones de paquete */
        .pkg-section { @apply mb-4 border border-stone-300 rounded-lg p-3 bg-white; }
        .pkg-title { @apply font-bold text-amber-900 mb-2 border-b border-stone-200 pb-1 text-sm uppercase; }
    </style>
</head>
<body>

    <div id="app" class="h-screen w-full flex flex-col overflow-hidden relative">
        <!-- Header R√∫stico (Madera Oscura) -->
        <header id="main-header" class="bg-amber-950 text-amber-50 p-3 shadow-md flex justify-between items-center z-10 shrink-0 relative border-b-4 border-amber-700">
            <div class="flex items-center gap-3">
                <!-- LOGO EN HEADER -->
                <div class="bg-white p-1 rounded-full border-2 border-amber-600 overflow-hidden w-12 h-12 flex items-center justify-center shadow-sm">
                    <img src="https://www.dropbox.com/scl/fi/htapbd4yf4m239y9zv2n1/Picture1.png?rlkey=o8je5uxe95avc9i9od6dmpbqh&raw=1" alt="Logo" class="w-full h-full object-contain" onerror="this.src='https://placehold.co/100x100?text=AB'">
                </div>
                <h1 class="font-bold text-xl tracking-wide" id="header-title" style="font-family: 'Courier New', Courier, monospace;">A-LAS DE BARRIL</h1>
            </div>
            
            <div id="status-indicator" class="hidden absolute left-1/2 transform -translate-x-1/2 px-4 py-1 rounded-sm border text-xs font-bold shadow-lg flex items-center gap-2 top-14 md:top-auto">
                <span id="status-text"></span>
            </div>

            <button onclick="logoutToHome()" class="text-xs bg-amber-900 border border-amber-700 px-3 py-1.5 rounded hover:bg-amber-800 transition uppercase font-bold tracking-wider text-amber-100">
                <i class="fa-solid fa-right-from-bracket"></i> Salir
            </button>
        </header>

        <!-- Contenido (Fondo Crema) -->
        <main id="content-area" class="flex-1 overflow-y-auto bg-amber-50 relative flex flex-col p-1">
            <div class="flex flex-col justify-center items-center h-full text-amber-800 opacity-50 gap-4">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl"></i>
                <p class="text-sm font-bold animate-pulse">Cargando sistema...</p>
            </div>
        </main>

        <!-- √Årea Ticket (Oculto para impresi√≥n nativa) -->
        <div id="receipt-area" class="hidden bg-white p-4 text-xs w-[300px] mx-auto font-mono"></div>
    </div>

    <!-- Modales -->
    <div id="modal-overlay" class="fixed inset-0 bg-stone-900 bg-opacity-70 hidden z-50 flex justify-center items-center p-4 backdrop-blur-sm">
        <div id="modal-content" class="bg-[#fffbeb] rounded-xl shadow-2xl w-full max-w-md overflow-hidden max-h-[90vh] flex flex-col border-4 border-amber-900/10"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, query, orderBy, serverTimestamp, enableIndexedDbPersistence, runTransaction } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBqrR3FQ7L7KCE5Wg8thRvyA6GpiUV2DPs",
            authDomain: "alasdebarrilwings.firebaseapp.com",
            projectId: "alasdebarrilwings",
            storageBucket: "alasdebarrilwings.firebasestorage.app",
            messagingSenderId: "826542576836",
            appId: "1:826542576836:web:dd1bc6f8bc4fd73d57a591"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app);
            enableIndexedDbPersistence(db).catch(err => console.warn("Offline persistence:", err.code));
        } catch (e) { showError("Error de Configuraci√≥n", e.message); }

        function updateStatusDisplay() {
            const ind = document.getElementById('status-indicator');
            const txt = document.getElementById('status-text');
            if (!navigator.onLine) {
                ind.className = "absolute left-1/2 transform -translate-x-1/2 bg-red-700 px-4 py-1 rounded-sm border border-red-900 text-xs font-bold shadow-lg animate-pulse flex items-center gap-2 text-white top-14 md:top-auto";
                ind.classList.remove('hidden'); txt.innerHTML = '<i class="fa-solid fa-wifi"></i> MODO OFFLINE';
            } else { ind.classList.add('hidden'); }
        }
        window.addEventListener('online', updateStatusDisplay);
        window.addEventListener('offline', updateStatusDisplay);
        updateStatusDisplay();

        function showError(title, details) { document.getElementById('content-area').innerHTML = `<div class="flex flex-col justify-center items-center h-full p-6 text-center"><h2 class="font-bold">${title}</h2><p>${details}</p><button onclick="location.reload()" class="mt-4 bg-amber-700 text-white px-4 py-2 rounded">Reintentar</button></div>`; }

        let currentUser = null, ordersData = [], tablesData = [];
        let currentRole = null, currentTableId = null, showingDebts = false;

        const MODIFIERS = {
            burgers: ["Sin cebolla", "Sin jitomate", "Sin pi√±a", "Sin picante", "Sin catsup", "Sin mayonesa", "Sin queso", "Sin jam√≥n", "Sin carne"],
            hotdogs: ["Sin jitomate", "Sin cebolla", "Sin pi√±a", "Sin picante", "Sin catsup", "Sin mayonesa", "Sin salchicha", "Sin tocino"],
            salsas: ["Bbq", "Mango", "Habanero", "Tamarindo", "Jamaica", "Frutos rojos", "Pi√±a", "Chipotle", "B√∫falo", "Lemon pepper", "A la diabla"],
            snacks: ["Sin queso", "Sin crema", "Sin catsup", "Sin salsa", "Sin vegetales"],
            sodas: ["Coca", "Boing Mango", "Boing Guayaba", "Manzanita", "Jarrito", "Squirt"],
            coolers: ["Durazno", "Fresa", "Vino", "Manzana Kiwi"],
            general_kitchen: ["Para llevar", "Sin cubiertos"],
            general_bar: ["Poca az√∫car", "Sin popote"],
            package_options: ["Con Papas", "Con Aros de Cebolla", "Con Alitas", "Con Boneless", "Salsa BBQ", "Salsa Buffalo", "Salsa Mango", "Salsa Habanero"]
        };

        const MENU = [
            { id: 'b_md', name: 'Barril 1/2 Lt', price: 35, category: 'bar', isBeer: true, type: 'regular', icon: 'fa-beer-mug-empty' },
            { id: 'b_1l', name: 'Barril 1 Lt', price: 70, category: 'bar', isBeer: true, type: 'regular', icon: 'fa-beer-mug-empty' },
            { id: 'b_md_negra', name: 'Barril Negra 1/2 Lt', price: 45, category: 'bar', isBeer: true, type: 'dark', icon: 'fa-beer-mug-empty' },
            { id: 'b_1l_negra', name: 'Barril Negra 1 Lt', price: 90, category: 'bar', isBeer: true, type: 'dark', icon: 'fa-beer-mug-empty' },
            { id: 'b_emb', name: 'Cerveza Embotellada', price: 30, category: 'bar', isBeer: true, type: 'bottled', icon: 'fa-bottle-droplet' },
            { id: 'b_cig', name: 'Cigarro', price: 7, category: 'bar', modGroup: 'general_bar', icon: 'fa-smoking' },
            { id: 'b_ref', name: 'Refresco', price: 25, category: 'bar', modGroup: 'sodas', icon: 'fa-bottle-water' },
            { id: 'b_coo', name: 'Caribe Cooler', price: 30, category: 'bar', modGroup: 'coolers', icon: 'fa-wine-bottle' },
            { id: 'h1', name: 'Hamburguesa Sencilla', price: 55, category: 'kitchen', modGroup: 'burgers', icon: 'fa-burger' },
            { id: 'h2', name: 'Hamburguesa Especial', price: 70, category: 'kitchen', modGroup: 'burgers', icon: 'fa-burger' },
            { id: 'h3', name: 'Hamburguesa Arrachera', price: 90, category: 'kitchen', modGroup: 'burgers', icon: 'fa-burger' },
            { id: 'h4', name: 'Hamburguesa Camar√≥n', price: 80, category: 'kitchen', modGroup: 'burgers', icon: 'fa-shrimp' },
            { id: 'h5', name: 'Hamburguesa Pollo', price: 65, category: 'kitchen', modGroup: 'burgers', icon: 'fa-drumstick-bite' },
            { id: 'c1', name: 'Tenders de Pollo', price: 75, category: 'kitchen', modGroup: 'salsas', icon: 'fa-drumstick-bite' },
            { id: 'c2', name: 'Boneless', price: 70, category: 'kitchen', modGroup: 'salsas', icon: 'fa-drumstick-bite' },
            { id: 'c3', name: 'Alitas', price: 50, category: 'kitchen', modGroup: 'salsas', icon: 'fa-dove' },
            { id: 's1', name: 'Papas a la francesa', price: 40, category: 'kitchen', modGroup: 'snacks', icon: 'fa-utensils' },
            { id: 's2', name: 'Salchipapas', price: 50, category: 'kitchen', modGroup: 'snacks', icon: 'fa-bacon' },
            { id: 's3', name: 'Aros de Cebolla', price: 45, category: 'kitchen', modGroup: 'snacks', icon: 'fa-ring' },
            { id: 'hd1', name: 'Hot Dog Sencillo', price: 25, category: 'kitchen', modGroup: 'hotdogs', icon: 'fa-hotdog' },
            { id: 'hd2', name: 'Hot Dog Especial', price: 40, category: 'kitchen', modGroup: 'hotdogs', icon: 'fa-hotdog' },
            { id: 'p1', name: 'Paquete 1', price: 235, category: 'kitchen', isPackage: true, icon: 'fa-box-open' },
            { id: 'p2', name: 'Paquete 2', price: 255, category: 'kitchen', isPackage: true, icon: 'fa-box-open' },
            { id: 'p3', name: 'Paquete 3', price: 310, category: 'kitchen', isPackage: true, icon: 'fa-box-open' },
        ];

        async function initApp() { try { await signInAnonymously(auth); } catch (e) { console.error(e); showError("Auth Error", e.message); } }
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                onSnapshot(collection(db, 'tables'), s => { tablesData = s.docs.map(d=>({id:d.id, ...d.data()})); refreshCurrentView(); });
                onSnapshot(collection(db, 'orders'), s => { ordersData = s.docs.map(d=>({id:d.id, ...d.data()})); refreshCurrentView(); });
                renderHome();
            }
        });

        function refreshCurrentView() {
            if(!currentRole) return;
            if(currentRole === 'waiter') currentTableId ? renderTableDetail(currentTableId) : renderWaiterDashboard();
            else if(currentRole === 'kitchen') renderBoard('kitchen');
            else if(currentRole === 'bar') renderBoard('bar');
        }

        window.renderHome = () => {
            currentRole = null;
            document.getElementById('header-title').innerText = 'A-LAS DE BARRIL';
            document.getElementById('content-area').innerHTML = `
                <div class="p-6 flex flex-col gap-6 h-full justify-center items-center max-w-md mx-auto">
                    <img src="https://www.dropbox.com/scl/fi/jymn0kvgyx9ioqjojwbfw/Picture2.png?rlkey=u4k3ppl3f7vohb07au7bt8tw4&raw=1" class="w-48 mb-2 rounded-xl shadow-lg border-4 border-amber-900/10" alt="Logo" onerror="this.src='https://placehold.co/200x200?text=LOGO'">
                    <h2 class="text-2xl font-bold text-amber-900 mb-2 border-b-4 border-amber-500 pb-2">SELECCIONA PERFIL</h2>
                    <button onclick="setRole('waiter')" class="w-full bg-yellow-700 hover:bg-yellow-800 text-white p-6 rounded-xl text-xl font-bold flex gap-4 items-center wood-shadow transition transform active:scale-95 border-2 border-yellow-900"><div class="bg-yellow-900 p-3 rounded-full text-yellow-100"><i class="fa-solid fa-mobile-screen"></i></div><span>Mesero</span></button>
                    <button onclick="setRole('bar')" class="w-full bg-amber-800 hover:bg-amber-900 text-white p-6 rounded-xl text-xl font-bold flex gap-4 items-center wood-shadow transition transform active:scale-95 border-2 border-amber-950"><div class="bg-amber-950 p-3 rounded-full text-amber-100"><i class="fa-solid fa-beer-mug-empty"></i></div><span>Barra</span></button>
                    <button onclick="setRole('kitchen')" class="w-full bg-orange-800 hover:bg-orange-900 text-white p-6 rounded-xl text-xl font-bold flex gap-4 items-center wood-shadow transition transform active:scale-95 border-2 border-orange-950"><div class="bg-orange-950 p-3 rounded-full text-orange-100"><i class="fa-solid fa-fire-burner"></i></div><span>Cocina</span></button>
                </div>`;
        }
        window.setRole = (r) => { currentRole = r; refreshCurrentView(); }

        window.renderWaiterDashboard = () => {
            currentTableId = null;
            document.getElementById('header-title').innerText = 'Control de Mesas';
            const now = Date.now();
            const eightDaysMs = 8 * 24 * 60 * 60 * 1000;
            const openTables = tablesData.filter(t => t.status === 'open').sort((a,b) => (b.openedAt?.seconds||0) - (a.openedAt?.seconds||0));
            const debtTables = tablesData.filter(t => t.status === 'debt').sort((a,b) => (b.debtDate?.seconds||0) - (a.debtDate?.seconds||0));
            const closedTables = tablesData.filter(t => {
                if (t.status !== 'closed') return false;
                const closedDate = t.closedAt?.seconds * 1000 || 0;
                return (now - closedDate) < eightDaysMs;
            }).sort((a,b) => (b.closedAt?.seconds||0) - (a.closedAt?.seconds||0));
            const btnClass = showingDebts ? 'bg-amber-700 text-amber-50' : 'bg-stone-600 text-stone-200';

            let html = `
                <div class="p-4 flex flex-col gap-6 pb-24">
                    <div class="flex gap-2 bg-white p-2 rounded-lg shadow-sm border border-amber-200">
                        <input type="number" id="search-ticket-id" placeholder="Buscar Ticket #" class="flex-1 p-2 rounded bg-transparent outline-none text-stone-700 placeholder-stone-400 font-mono font-bold">
                        <button onclick="searchTicket()" class="bg-stone-700 text-white px-4 rounded hover:bg-stone-800"><i class="fa-solid fa-search"></i></button>
                    </div>
                    <div class="flex gap-3"><button onclick="toggleDebtView()" class="flex-1 ${btnClass} py-3 rounded-lg font-bold shadow-md border-b-4 border-black/20 text-sm">${showingDebts ? '‚¨Ö Ver Mesas Activas' : 'üìÇ Ver Deudas / Fiado'}</button></div>
                    <div>
                        <div class="flex justify-between items-end mb-3 border-b-2 border-amber-200 pb-1">
                            <h3 class="font-black text-amber-900 text-lg uppercase tracking-wider">${showingDebts ? 'Deudas Pendientes' : 'Mesas Abiertas'}</h3>
                            ${!showingDebts ? `<button onclick="openNewTableModal()" class="bg-green-700 hover:bg-green-800 text-white text-xs font-bold px-3 py-1.5 rounded shadow flex items-center gap-1 border border-green-900"><i class="fa-solid fa-plus"></i> NUEVA</button>` : ''}
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            ${!showingDebts && openTables.length === 0 ? '<p class="col-span-2 text-stone-400 text-sm text-center italic py-4 bg-stone-100 rounded border border-dashed border-stone-300">No hay mesas abiertas</p>' : ''}
                            ${showingDebts && debtTables.length === 0 ? '<p class="col-span-2 text-stone-400 text-sm text-center italic py-4 bg-stone-100 rounded border border-dashed border-stone-300">No hay deudas</p>' : ''}
                            ${!showingDebts ? openTables.map(t => createTableCard(t)).join('') : debtTables.map(t => createTableCard(t)).join('')}
                        </div>
                    </div>
                    ${!showingDebts ? `<div class="mt-4 opacity-75"><h3 class="font-bold text-stone-500 text-sm uppercase mb-2 border-b border-stone-300 pb-1">Cerradas (8 d√≠as)</h3><div class="grid grid-cols-2 gap-3">${closedTables.length ? closedTables.map(t => createTableCard(t)).join('') : '<p class="col-span-2 text-stone-400 text-xs text-center">Historial vac√≠o</p>'}</div></div>` : ''}
                </div>`;
            document.getElementById('content-area').innerHTML = html;
        }

        function createTableCard(t) {
            const ords = ordersData.filter(o => o.tableId === t.id && o.status !== 'cancelled');
            const total = ords.reduce((a,c) => a + (c.price * c.quantity), 0);
            
            // Si tiene dep√≥sito (anticipo), restarlo del total visual
            const deposit = t.deposit || 0;
            const remaining = total - deposit;

            let cardBg = 'bg-white', borderColor = 'border-stone-300', badge = '';
            
            // CLIENTE DISTINGUIDO STYLING
            if (t.isVip) {
                cardBg = 'bg-pink-50'; // Slight pink tint
            } else if (t.status === 'open') {
                cardBg = 'bg-[#fffef0]';
            }

            if (t.status === 'open') {
                const pending = ords.some(o => o.status !== 'delivered');
                borderColor = pending ? 'border-yellow-500' : 'border-green-600';
                badge = pending ? '<i class="fa-solid fa-clock text-yellow-600 animate-pulse"></i>' : '<i class="fa-solid fa-check text-green-600"></i>';
            } else if (t.status === 'debt') { borderColor = 'border-red-500'; cardBg = 'bg-red-50'; badge = '<i class="fa-solid fa-file-invoice-dollar text-red-600"></i>';
            } else { cardBg = 'bg-stone-200'; badge = '<i class="fa-solid fa-lock text-stone-400"></i>'; }
            
            // Add VIP badge if applicable
            let vipBadge = t.isVip ? '<span class="absolute -top-2 -left-2 bg-pink-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold shadow-sm border border-white"><i class="fa-solid fa-crown"></i> VIP</span>' : '';
            
            let priceDisplay = `$${total}`; if (deposit > 0) priceDisplay = `<span class="text-xs text-stone-400 line-through mr-1">$${total}</span> $${remaining}`;
            
            // DATE FORMATTING
            const dateStr = t.openedAt ? new Date(t.openedAt.seconds * 1000).toLocaleString('es-MX', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }).replace(',', '') : '';

            return `<div onclick="renderTableDetail('${t.id}')" class="${cardBg} rounded-lg shadow-sm p-3 border-b-4 ${borderColor} relative cursor-pointer active:scale-95 transition border-l border-r border-t">
                    ${vipBadge}
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[10px] font-mono font-bold text-stone-400 bg-stone-100 px-1 rounded border border-stone-200">#${t.uniqueId || '---'}</span>
                        <div class="flex flex-col items-end">
                             <span class="text-[10px] text-stone-400 font-mono mb-0.5">${dateStr}</span>
                             ${badge}
                        </div>
                    </div>
                    <div class="text-2xl font-black text-stone-800 leading-none mb-1">${t.number}</div>
                    <div class="text-xs text-stone-500 truncate font-semibold mb-2 uppercase tracking-wide">${t.nickname}</div>
                    <div class="text-lg font-bold text-amber-800 text-right border-t border-dashed border-stone-300 pt-1">${priceDisplay}</div>
                </div>`;
        }

        window.toggleDebtView = () => { showingDebts = !showingDebts; renderWaiterDashboard(); }
        window.searchTicket = async () => { const id=parseInt(document.getElementById('search-ticket-id').value); if(!id)return; const found=tablesData.find(t=>t.uniqueId===id); if(found)renderTableDetail(found.id); else alert("No encontrado"); }

        window.renderTableDetail = (tid) => {
            currentTableId = tid;
            const t = tablesData.find(x => x.id === tid);
            if(!t) return renderWaiterDashboard();
            const uniqueDisplay = t.uniqueId ? `#${t.uniqueId}` : '';
            const ords = ordersData.filter(o => o.tableId === tid && o.status !== 'cancelled').sort((a,b) => b.timestamp?.seconds - a.timestamp?.seconds);
            const total = ords.reduce((a,c) => a + (c.price * c.quantity), 0);
            const deposit = t.deposit || 0;
            const remaining = total - deposit;

            const isClosed = t.status === 'closed';
            let closeBtnText = t.status === 'debt' ? "Liquidar Deuda" : "Cerrar Cuenta";
            let closeBtnColor = t.status === 'debt' ? "bg-blue-700" : "bg-green-700";
            let totalDisplay = `<span>Total</span><span>$${total}</span>`;
            if (deposit > 0) totalDisplay = `<div class="flex justify-between text-xs text-stone-500"><span>Subtotal</span><span>$${total}</span></div><div class="flex justify-between text-xs text-red-500"><span>A cuenta</span><span>-$${deposit}</span></div><div class="flex justify-between font-black text-xl text-amber-900 border-t border-stone-300 pt-1 mt-1"><span>Restante</span><span>$${remaining}</span></div>`;
            else totalDisplay = `<div class="flex justify-between mb-3 font-black text-xl text-amber-900 px-2"><span>Total</span><span>$${total}</span></div>`;
            
            // --- MODIFICACI√ìN PARA MESA CERRADA ---
            // Ahora mostramos botones de impresi√≥n incluso si la mesa est√° cerrada
            let footerHtml = '';
            
            if (isClosed) {
                // Footer para mesas cerradas: Solo botones de impresi√≥n y total final
                 footerHtml = `
                <div id="order-footer" class="fixed bottom-0 w-full bg-stone-100 p-3 shadow-[0_-4px_10px_rgba(0,0,0,0.1)] z-30 border-t border-stone-300">
                     <div class="flex justify-between mb-2 font-bold text-xl text-stone-700 px-2"><span>Total Final</span><span>$${total}</span></div>
                     <div class="flex gap-2">
                        <button onclick="printR('${tid}')" class="flex-1 bg-stone-700 text-white py-3 rounded-lg font-bold shadow-md hover:bg-stone-800"><i class="fa-solid fa-print"></i> Ticket</button>
                        <button onclick="downloadPDF('${tid}')" class="flex-1 bg-red-700 text-white py-3 rounded-lg font-bold shadow-md hover:bg-red-800"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                     </div>
                     <div class="text-center text-[10px] text-stone-400 mt-2 font-bold uppercase tracking-widest">MESA CERRADA</div>
                </div>`;
            } else {
                // Footer para mesas abiertas (normal)
                footerHtml = `<div id="order-footer" class="fixed bottom-0 w-full bg-[#fffbeb] p-3 shadow-[0_-4px_10px_rgba(0,0,0,0.1)] z-30 border-t border-amber-200">${totalDisplay}<button onclick="openCloseAccountModal('${tid}', ${total})" class="w-full ${closeBtnColor} text-white py-3.5 rounded-lg font-bold shadow-lg border-b-4 border-black/20 active:border-b-0 active:translate-y-1 transition uppercase tracking-wide">${closeBtnText}</button></div>`;
            }
            
            const pageBg = t.isVip ? 'bg-pink-50' : 'bg-white';
            const vipHeader = t.isVip ? '<span class="ml-2 bg-pink-500 text-white text-[10px] px-2 py-0.5 rounded font-bold shadow"><i class="fa-solid fa-crown"></i> VIP</span>' : '';

            let html = `<div class="flex flex-col h-full ${pageBg}">
                <div class="bg-amber-900 text-white p-3 flex items-center justify-between shadow-md shrink-0">
                    <button onclick="renderWaiterDashboard()" class="text-amber-100 font-bold text-sm flex items-center gap-2"><i class="fa-solid fa-chevron-left"></i> Volver</button>
                    <div class="text-center"><div class="font-black text-lg leading-none flex items-center justify-center">MESA ${t.number} ${vipHeader}</div><div class="text-[10px] font-mono text-amber-300 opacity-80">Ticket ${uniqueDisplay}</div></div><div class="w-10"></div>
                </div>
                <div class="bg-white shadow-sm flex border-b border-stone-200 shrink-0">
                    <button onclick="switchTab('menu')" id="tab-btn-menu" class="flex-1 py-3 text-amber-800 border-b-4 border-amber-600 bg-amber-50 font-bold">MEN√ö</button>
                    <button onclick="switchTab('orders')" id="tab-btn-orders" class="flex-1 py-3 text-stone-400 font-bold hover:bg-stone-50 transition">CUENTA</button>
                </div>
                <div id="tab-menu" class="flex-1 overflow-y-auto p-4 pb-24 ${isClosed ? 'hidden' : ''} bg-stone-50">
                    <h3 class="cat-header">Cocina</h3><div class="grid gap-3 mb-6">${renderMenuSection('kitchen')}</div>
                    <h3 class="cat-header">Barra</h3><div class="grid gap-3">${renderMenuSection('bar')}</div>
                </div>
                <div id="tab-orders" class="${isClosed ? '' : 'hidden'} flex-1 overflow-y-auto p-4 pb-48 ${t.isVip ? 'bg-pink-50' : 'bg-stone-100'}">
                    ${ords.length === 0 ? '<div class="text-center py-10 text-stone-400 italic">Mesa vac√≠a</div>' : ''}
                    ${ords.map(o => {
                        let stClass = "bg-stone-200 text-stone-500", stIcon = "fa-clock";
                        if(o.status === 'preparing') { stClass = "bg-yellow-100 text-yellow-700 border border-yellow-300"; stIcon = "fa-fire"; }
                        if(o.status === 'ready') { stClass = "bg-green-100 text-green-700 border border-green-300"; stIcon = "fa-check"; }
                        if(o.status === 'delivered') { stClass = "bg-blue-50 text-blue-700 border border-blue-200"; stIcon = "fa-thumbs-up"; }
                        
                        // VIP items highlight slightly
                        const itemBg = t.isVip ? 'bg-pink-100/50 border-pink-200' : 'bg-white border-stone-200';
                        
                        return `<div class="${itemBg} p-3 rounded-lg shadow-sm mb-3 border">
                        <div class="flex justify-between items-start">
                            <div><div class="font-bold text-stone-800 text-lg leading-tight">${o.quantity}x ${o.itemName}</div>
                                ${o.modifiers&&o.modifiers.length?`<div class="text-xs text-red-600 font-semibold mt-1 bg-red-50 p-1 rounded inline-block border border-red-100"><i class="fa-solid fa-pen-to-square"></i> ${o.modifiers.join(', ')}</div>`:''}
                                <div class="text-[10px] text-stone-400 mt-1 font-mono">${new Date(o.timestamp?.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div></div>
                            <div class="text-right"><div class="font-bold text-amber-800 text-lg">$${o.price*o.quantity}</div><span class="text-[10px] font-bold px-2 py-0.5 rounded-full flex items-center gap-1 justify-end ${stClass}"><i class="fa-solid ${stIcon}"></i> ${o.status}</span></div>
                        </div></div>`;
                    }).join('')}
                </div>
                ${footerHtml}</div>`;
            document.getElementById('content-area').innerHTML = html;
        }

        function renderMenuSection(cat) {
            return MENU.filter(i => i.category === cat).map(i => `
                <button onclick="openCustomizeModal('${i.id}')" class="bg-white p-3 rounded-lg shadow-sm flex justify-between items-center text-left active:bg-amber-50 border border-stone-200 active:border-amber-300 transition group">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-amber-50 rounded-full flex items-center justify-center text-amber-700 group-active:scale-110 transition border border-amber-100"><i class="fa-solid ${i.icon}"></i></div>
                        <div><div class="font-bold text-stone-700 group-active:text-amber-900">${i.name}</div><div class="text-xs text-stone-500 font-mono">$${i.price}</div></div>
                    </div>
                    <div class="bg-amber-100 text-amber-700 w-8 h-8 rounded-full flex items-center justify-center font-bold shadow-sm group-active:bg-amber-500 group-active:text-white transition"><i class="fa-solid fa-plus"></i></div>
                </button>`).join('');
        }

        window.openCustomizeModal = function(itemId) {
            const item = MENU.find(i => i.id === itemId);
            if (item.isPackage) { openPackageModal(item); return; }
            const modal = document.getElementById('modal-content');
            
            if (item.isBeer && item.category === 'bar') {
                const isGeneric = item.type === 'regular'; 
                modal.innerHTML = `<div class="flex-1 flex flex-col h-full max-h-[85vh] bg-[#fffbeb]">
                        <div class="p-4 border-b border-amber-200 bg-amber-50 flex justify-between items-center"><div><h3 class="font-black text-xl text-amber-900 uppercase">${item.name}</h3><p class="text-stone-500 font-bold">$${item.price}</p></div><button onclick="closeModal()" class="text-stone-400 text-xl"><i class="fa-solid fa-times"></i></button></div>
                        <div class="p-5 overflow-y-auto flex-1 space-y-5">
                            <div class="flex justify-center items-center gap-6 bg-white p-3 rounded-xl shadow-inner border border-stone-200"><button onclick="adjQty(-1)" class="w-12 h-12 rounded-full bg-stone-200 text-stone-600 text-2xl font-bold">-</button><span id="modal-qty" class="text-4xl font-black text-amber-900">1</span><button onclick="adjQty(1)" class="w-12 h-12 rounded-full bg-amber-600 text-white text-2xl font-bold">+</button></div>
                            ${isGeneric ? `<div><h4 class="text-xs font-bold text-stone-400 uppercase mb-2">Tipo</h4><div class="grid grid-cols-2 gap-3" id="beer-type-group"><div onclick="selectBeerType(this)" class="option-btn clara selected" data-val="Clara">CLARA</div><div onclick="selectBeerType(this)" class="option-btn oscura" data-val="Oscura">OSCURA</div></div></div>` : ''}
                            <div><h4 class="text-xs font-bold text-stone-400 uppercase mb-2">Escarchado</h4><div class="grid grid-cols-1 gap-2" id="beer-prep-group"><div onclick="selectBeerPrep(this)" class="prep-radio" data-val="Escarchado Sal">Escarchado Sal</div><div onclick="selectBeerPrep(this)" class="prep-radio selected" data-val="Escarchado Chamoy">Escarchado Chamoy</div><div onclick="selectBeerPrep(this)" class="prep-radio" data-val="Sin Escarchar">Sin Escarchar</div></div></div>
                            <div class="flex gap-2"><button onclick="toggleMod(this)" class="mod-btn btn-red flex-1 py-3 rounded-lg font-bold shadow-sm" id="btn-sin-limon">SIN LIM√ìN</button><button onclick="toggleMod(this)" class="mod-btn btn-red flex-1 py-3 rounded-lg font-bold shadow-sm hidden" id="btn-sin-ajonjoli">SIN AJONJOL√ç</button></div>
                            <div onclick="toggleMod(this)" class="mod-btn btn-green p-3 rounded-lg flex justify-between items-center cursor-pointer mt-2 shadow-sm border-2" id="btn-clamato"><span class="font-bold flex items-center gap-2"><i class="fa-solid fa-droplet"></i> EXTRA CLAMATO</span><span class="font-black bg-green-700 text-white px-2 py-0.5 rounded text-xs">+$5</span></div>
                            <input type="text" id="manual-note" placeholder="Nota extra..." class="w-full border-2 border-stone-300 rounded-lg p-3 text-sm focus:border-amber-500 outline-none bg-white mt-2">
                        </div>
                        <div class="p-4 border-t border-amber-200 bg-white flex gap-3"><button onclick="closeModal()" class="flex-1 py-3.5 rounded-lg border-2 border-stone-300 text-stone-500 font-bold hover:bg-stone-50">CANCELAR</button><button onclick="submitBeerOrder('${item.id}')" class="flex-1 py-3.5 rounded-lg bg-amber-600 text-white font-bold shadow-lg border-b-4 border-amber-800 active:border-b-0 active:translate-y-1 transition">AGREGAR</button></div>
                    </div>`;
                checkChamoy();
            } else {
                // UI GENERAL Y PAQUETES
                let mods = item.modGroup ? MODIFIERS[item.modGroup] : (MODIFIERS['general_' + item.category] || []);
                modal.innerHTML = `
                    <div class="flex-1 flex flex-col h-full max-h-[85vh] bg-[#fffbeb]">
                        <div class="p-4 border-b border-amber-200 bg-amber-50 flex justify-between items-center"><div><h3 class="font-black text-xl text-amber-900 uppercase">${item.name}</h3><p class="text-stone-500 font-bold">$${item.price}</p></div><button onclick="closeModal()" class="text-stone-400 text-xl"><i class="fa-solid fa-times"></i></button></div>
                        <div class="p-5 overflow-y-auto flex-1">
                            <div class="flex justify-center items-center gap-6 mb-6 bg-white p-3 rounded-xl shadow-inner border border-stone-200"><button onclick="adjQty(-1)" class="w-12 h-12 rounded-full bg-stone-200 text-stone-600 text-2xl font-bold">-</button><span id="modal-qty" class="text-4xl font-black text-amber-900">1</span><button onclick="adjQty(1)" class="w-12 h-12 rounded-full bg-amber-600 text-white text-2xl font-bold">+</button></div>
                            ${mods.length > 0 ? `<div class="flex flex-wrap gap-2 mb-4">${mods.map(m => {
                                let cls = m.startsWith("Sin") ? "btn-red" : (m.startsWith("Con")||m.includes("+") ? "btn-green" : "btn-neutral");
                                return `<button onclick="toggleMod(this)" class="mod-btn px-3 py-2 rounded-lg text-sm shadow-sm ${cls}">${m}</button>`;
                            }).join('')}</div>` : ''}
                            <input type="text" id="manual-note" placeholder="Nota..." class="w-full border-2 border-stone-300 rounded-lg p-3 text-sm focus:border-amber-500 outline-none bg-white">
                        </div>
                        <div class="p-4 border-t border-amber-200 bg-white flex gap-3"><button onclick="closeModal()" class="flex-1 py-3.5 rounded-lg border-2 border-stone-300 text-stone-500 font-bold hover:bg-stone-50">CANCELAR</button><button onclick="submitGeneralOrder('${item.id}')" class="flex-1 py-3.5 rounded-lg bg-amber-600 text-white font-bold shadow-lg border-b-4 border-amber-800 active:border-b-0 active:translate-y-1 transition">AGREGAR</button></div>
                    </div>`;
            }
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        // --- CONSTRUCTOR DE PAQUETES ---
        window.openPackageModal = function(item) {
            const modal = document.getElementById('modal-content');
            let content = '';
            
            const salsaSection = (title, name) => `
                <div class="pkg-section">
                    <h4 class="pkg-title">${title}</h4>
                    <div class="grid grid-cols-3 gap-2">
                        ${MODIFIERS.salsas.map(s => `<label class="flex items-center gap-1 text-xs border p-2 rounded cursor-pointer hover:bg-stone-100"><input type="radio" name="${name}" value="${s}" class="accent-amber-600"> ${s}</label>`).join('')}
                    </div>
                </div>`;

            const beerSection = (num) => `
                <div class="pkg-section">
                    <h4 class="pkg-title">Tarro ${num} (¬Ω Litro)</h4>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <select id="p_beer_type_${num}" class="border p-2 rounded text-sm w-full"><option value="Clara">Clara</option><option value="Oscura">Oscura</option></select>
                        <select id="p_beer_prep_${num}" class="border p-2 rounded text-sm w-full"><option value="Escarchado Chamoy">Chamoy</option><option value="Escarchado Sal">Sal</option><option value="Sin Escarchar">Sin Escarchar</option></select>
                    </div>
                    <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="p_beer_nolimon_${num}"> Sin Lim√≥n</label>
                </div>`;

            if(item.id === 'p1') {
                content = `
                    ${salsaSection('Salsa Alitas', 'p1_salsa_alitas')}
                    ${salsaSection('Salsa Boneless', 'p1_salsa_boneless')}
                    <div class="pkg-section"><h4 class="pkg-title">Guarnici√≥n</h4><div class="flex gap-4"><label><input type="radio" name="p1_side" value="Media Papas" checked> ¬Ω Papas</label><label><input type="radio" name="p1_side" value="Media Aros"> ¬Ω Aros</label></div></div>
                    ${beerSection(1)} ${beerSection(2)}
                `;
            } else if(item.id === 'p2') {
                content = `
                    <div class="pkg-section"><h4 class="pkg-title">Elecci√≥n Principal</h4><div class="flex gap-4 mb-2"><label><input type="radio" name="p2_main" value="Alitas" checked> Alitas</label><label><input type="radio" name="p2_main" value="Boneless"> Boneless</label></div>${salsaSection('Salsa (Para elecci√≥n)', 'p2_salsa_main').replace('<div class="pkg-section">','<div>')}</div>
                    <div class="pkg-section"><h4 class="pkg-title">Hamburguesa 1</h4><div class="grid grid-cols-3 gap-2">${MODIFIERS.burgers.map(m=>`<label class="text-xs"><input type="checkbox" class="p2_h1_mod" value="${m}"> ${m}</label>`).join('')}</div></div>
                    <div class="pkg-section"><h4 class="pkg-title">Hamburguesa 2</h4><div class="grid grid-cols-3 gap-2">${MODIFIERS.burgers.map(m=>`<label class="text-xs"><input type="checkbox" class="p2_h2_mod" value="${m}"> ${m}</label>`).join('')}</div></div>
                    <div class="pkg-section"><h4 class="pkg-title">Guarnici√≥n</h4><div class="flex gap-4 mb-2"><label><input type="radio" name="p2_side" value="Media Papas" checked> ¬Ω Papas</label><label><input type="radio" name="p2_side" value="Media Aros"> ¬Ω Aros</label></div><div class="grid grid-cols-3 gap-2">${MODIFIERS.snacks.map(m=>`<label class="text-xs"><input type="checkbox" class="p2_side_mod" value="${m}"> ${m}</label>`).join('')}</div></div>
                    ${beerSection(1)} ${beerSection(2)}
                `;
            } else if(item.id === 'p3') {
                content = `
                    ${salsaSection('Salsa Alitas', 'p3_salsa_alitas')}
                    ${salsaSection('Salsa Boneless', 'p3_salsa_boneless')}
                    <div class="pkg-section"><h4 class="pkg-title">Aros de Cebolla (Orden Completa)</h4><div class="grid grid-cols-3 gap-2">${MODIFIERS.snacks.map(m=>`<label class="text-xs"><input type="checkbox" class="p3_aros_mod" value="${m}"> ${m}</label>`).join('')}</div></div>
                    <div class="pkg-section"><h4 class="pkg-title">3 Hot Dogs (Iguales)</h4><div class="grid grid-cols-3 gap-2">${MODIFIERS.hotdogs.map(m=>`<label class="text-xs"><input type="checkbox" class="p3_hd_mod" value="${m}"> ${m}</label>`).join('')}</div></div>
                    <div class="pkg-section"><h4 class="pkg-title">3 Tarros Peque√±os (Iguales)</h4><div class="grid grid-cols-2 gap-2 mb-2"><select id="p3_beer_type" class="border p-2 w-full"><option>Clara</option><option>Oscura</option></select><select id="p3_beer_prep" class="border p-2 w-full"><option>Chamoy</option><option>Sal</option><option>Sin</option></select></div><label><input type="checkbox" id="p3_beer_nolimon"> Sin Lim√≥n</label></div>
                `;
            }

            modal.innerHTML = `
                <div class="flex-1 flex flex-col h-full max-h-[90vh] bg-[#fffbeb]">
                    <div class="p-4 border-b border-amber-200 bg-amber-50 flex justify-between items-center"><div><h3 class="font-black text-xl text-amber-900 uppercase">${item.name}</h3><p class="text-stone-500 font-bold">$${item.price}</p></div><button onclick="closeModal()" class="text-stone-400 text-xl"><i class="fa-solid fa-times"></i></button></div>
                    <div class="p-4 overflow-y-auto flex-1">${content}</div>
                    <div class="p-4 border-t border-amber-200 bg-white flex gap-3"><button onclick="closeModal()" class="flex-1 py-3.5 rounded-lg border-2 border-stone-300 font-bold">Cancelar</button><button onclick="submitPackageOrder('${item.id}')" class="flex-1 py-3.5 rounded-lg bg-amber-600 text-white font-bold shadow-lg">AGREGAR PAQUETE</button></div>
                </div>`;
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        window.submitPackageOrder = async (itemId) => {
            const item = MENU.find(i => i.id === itemId);
            let kitchenMods = [];
            let barMods = [];

            const getRadio = (name) => document.querySelector(`input[name="${name}"]:checked`)?.value || 'Sin elecci√≥n';
            const getChecks = (cls) => Array.from(document.querySelectorAll(`.${cls}:checked`)).map(c => c.value).join(', ');
            const getBeer = (n) => `T${n}: ${document.getElementById(`p_beer_type_${n}`).value}, ${document.getElementById(`p_beer_prep_${n}`).value}` + (document.getElementById(`p_beer_nolimon_${n}`).checked ? ' (Sin Lim√≥n)' : '');

            if(itemId === 'p1') {
                kitchenMods.push(`Alitas: ${getRadio('p1_salsa_alitas')}`);
                kitchenMods.push(`Boneless: ${getRadio('p1_salsa_boneless')}`);
                kitchenMods.push(`Guarnici√≥n: ${getRadio('p1_side')}`);
                barMods.push(getBeer(1));
                barMods.push(getBeer(2));
            } else if(itemId === 'p2') {
                kitchenMods.push(`Principal: ${getRadio('p2_main')} (${getRadio('p2_salsa_main')})`);
                kitchenMods.push(`Burg 1: ${getChecks('p2_h1_mod') || 'Sencilla'}`);
                kitchenMods.push(`Burg 2: ${getChecks('p2_h2_mod') || 'Sencilla'}`);
                kitchenMods.push(`Guarnici√≥n: ${getRadio('p2_side')} (${getChecks('p2_side_mod')})`);
                barMods.push(getBeer(1));
                barMods.push(getBeer(2));
            } else if(itemId === 'p3') {
                kitchenMods.push(`Alitas: ${getRadio('p3_salsa_alitas')}`);
                kitchenMods.push(`Boneless: ${getRadio('p3_salsa_boneless')}`);
                kitchenMods.push(`Aros: ${getChecks('p3_aros_mod')}`);
                kitchenMods.push(`3 HotDogs: ${getChecks('p3_hd_mod')}`);
                barMods.push(`3 Tarros: ${document.getElementById('p3_beer_type').value}, ${document.getElementById('p3_beer_prep').value}` + (document.getElementById('p3_beer_nolimon').checked ? ' (Sin Lim√≥n)' : ''));
            }

            await addDoc(collection(db, 'orders'), {
                tableId: currentTableId, itemId: item.id, itemName: `${item.name} (Cocina)`, category: 'kitchen',
                price: item.price, quantity: 1, modifiers: kitchenMods, status: 'ordered', timestamp: serverTimestamp()
            });
            await addDoc(collection(db, 'orders'), {
                tableId: currentTableId, itemId: item.id, itemName: `${item.name} (Barra)`, category: 'bar',
                price: 0, quantity: 1, modifiers: barMods, status: 'ordered', timestamp: serverTimestamp()
            });

            closeModal();
            switchTab('orders');
        }

        window.selectRadio = (el, groupId) => { const group = document.getElementById(groupId); if(group) { group.querySelectorAll('.beer-radio, .prep-radio').forEach(d => d.classList.remove('selected')); el.classList.add('selected'); } }
        window.selectBeerType = (el) => { document.querySelectorAll('#beer-type-group .option-btn').forEach(d => d.classList.remove('selected')); el.classList.add('selected'); }
        window.selectBeerPrep = (el) => { document.querySelectorAll('#beer-prep-group .prep-radio').forEach(d => d.classList.remove('selected')); el.classList.add('selected'); checkChamoy(); }
        window.checkChamoy = () => { const sel = document.querySelector('#beer-prep-group .prep-radio.selected')?.dataset.val; const btn = document.getElementById('btn-sin-ajonjoli'); if (btn) { if(sel === 'Escarchado Chamoy') btn.classList.remove('hidden'); else { btn.classList.add('hidden'); btn.classList.remove('selected'); } } }

        window.submitBeerOrder = async (itemId) => {
            const item = MENU.find(i => i.id === itemId);
            const qty = parseInt(document.getElementById('modal-qty').innerText);
            let finalPrice = item.price;
            let mods = [];
            const typeEl = document.querySelector('#beer-type-group .option-btn.selected'); if(typeEl) mods.push(typeEl.dataset.val);
            const prepEl = document.querySelector('#beer-prep-group .prep-radio.selected'); if(prepEl) mods.push(prepEl.dataset.val);
            if(document.getElementById('btn-sin-limon').classList.contains('selected')) mods.push("Sin Lim√≥n");
            if(document.getElementById('btn-sin-ajonjoli') && document.getElementById('btn-sin-ajonjoli').classList.contains('selected')) mods.push("Sin Ajonjol√≠");
            if(document.getElementById('btn-clamato').classList.contains('selected')) { mods.push("Extra Clamato"); finalPrice += 5; }
            const note = document.getElementById('manual-note').value.trim(); if(note) mods.push(note);
            await addOrderToDb(item, finalPrice, qty, mods);
        }

        window.submitGeneralOrder = async (itemId) => {
            const item = MENU.find(i => i.id === itemId);
            const qty = parseInt(document.getElementById('modal-qty').innerText);
            const mods = Array.from(document.querySelectorAll('.mod-btn.selected')).map(el => el.innerText);
            const note = document.getElementById('manual-note').value.trim();
            if(note) mods.push(note);
            await addOrderToDb(item, item.price, qty, mods);
        }

        async function addOrderToDb(item, price, qty, mods) {
            await addDoc(collection(db, 'orders'), {
                tableId: currentTableId, itemId: item.id, itemName: item.name, category: item.category,
                price: price, quantity: qty, modifiers: mods, status: 'ordered', timestamp: serverTimestamp()
            });
            closeModal();
            switchTab('orders');
        }

        window.openNewTableModal = () => { document.getElementById('modal-content').innerHTML = `<div class="p-6 bg-[#fffbeb]"><h3 class="font-black text-xl mb-4 text-amber-900">ABRIR NUEVA MESA</h3><input type="number" id="ntn" placeholder="N√∫mero de Mesa" class="w-full border-2 border-stone-300 p-3 rounded-lg mb-3 text-lg font-bold outline-none focus:border-amber-500"><input type="text" id="ntnm" placeholder="Apodo / Referencia" class="w-full border-2 border-stone-300 p-3 rounded-lg mb-4 outline-none focus:border-amber-500"><label class="flex items-center gap-2 mb-6 p-2 border border-pink-200 bg-pink-50 rounded-lg cursor-pointer"><input type="checkbox" id="ntvip" class="w-5 h-5 accent-pink-500"> <span class="font-bold text-pink-700"><i class="fa-solid fa-crown"></i> Cliente Distinguido (VIP)</span></label><div class="flex gap-3"><button onclick="closeModal()" class="flex-1 bg-stone-200 py-3 rounded-lg font-bold text-stone-600 hover:bg-stone-300">CANCELAR</button><button onclick="subNT()" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-bold shadow-lg border-b-4 border-green-800 active:border-b-0 active:translate-y-1 transition">ABRIR</button></div></div>`; document.getElementById('modal-overlay').classList.remove('hidden'); }
        window.subNT = async () => {
            const num = document.getElementById('ntn').value;
            const nick = document.getElementById('ntnm').value || 'Cliente';
            const isVip = document.getElementById('ntvip').checked;
            if(!num) return;
            try {
                await runTransaction(db, async (transaction) => {
                    const counterRef = doc(db, 'config', 'counters_tables');
                    const counterDoc = await transaction.get(counterRef);
                    let newId = 1000;
                    if (counterDoc.exists()) newId = counterDoc.data().current + 1;
                    transaction.set(counterRef, { current: newId });
                    const newTableRef = doc(collection(db, 'tables'));
                    transaction.set(newTableRef, { number: num, nickname: nick, status: 'open', openedAt: serverTimestamp(), uniqueId: newId, isVip: isVip });
                });
                closeModal();
            } catch (e) { alert("Error al crear mesa."); console.error(e); }
        }

        window.adjQty = (d) => { const el=document.getElementById('modal-qty'); let v=parseInt(el.innerText)+d; if(v<1)v=1; el.innerText=v; }
        window.toggleMod = (b) => b.classList.toggle('selected');
        window.switchTab = (t) => {
            if(t==='menu'){ 
                document.getElementById('tab-menu').classList.remove('hidden'); document.getElementById('tab-orders').classList.add('hidden'); document.getElementById('order-footer').classList.add('hidden'); 
                document.getElementById('tab-btn-menu').className="flex-1 py-3 text-amber-800 border-b-4 border-amber-600 bg-amber-50 font-bold";
                document.getElementById('tab-btn-orders').className="flex-1 py-3 text-stone-400 font-bold hover:bg-stone-50 transition";
            } else { 
                document.getElementById('tab-menu').classList.add('hidden'); document.getElementById('tab-orders').classList.remove('hidden'); document.getElementById('order-footer').classList.remove('hidden');
                document.getElementById('tab-btn-orders').className="flex-1 py-3 text-amber-800 border-b-4 border-amber-600 bg-amber-50 font-bold";
                document.getElementById('tab-btn-menu').className="flex-1 py-3 text-stone-400 font-bold hover:bg-stone-50 transition";
            }
        }
        window.closeModal = () => document.getElementById('modal-overlay').classList.add('hidden');
        window.logoutToHome = () => renderHome();

        function renderBoard(cat) {
            document.getElementById('header-title').innerText = cat === 'kitchen' ? 'COCINA' : 'BARRA';
            const active = ordersData.filter(o => o.category === cat && ['ordered','preparing'].includes(o.status)).sort((a,b) => {
                const ta = a.timestamp?.seconds || Date.now()/1000;
                const tb = b.timestamp?.seconds || Date.now()/1000;
                return ta - tb; 
            });
            const ready = ordersData.filter(o => o.category === cat && o.status === 'ready');
            let html = `<div class="flex h-full p-2 gap-3 overflow-x-auto bg-stone-200">`;
            html += `<div class="flex-1 min-w-[300px] bg-white rounded-xl shadow-md p-3 flex flex-col border-t-8 border-red-500"><h3 class="font-black text-stone-700 mb-3 text-lg flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div> PENDIENTES (${active.filter(o=>o.status==='ordered').length})</h3><div class="flex-1 overflow-y-auto space-y-3 p-1">${active.filter(o=>o.status==='ordered').map(o=>card(o,'ordered')).join('')}</div></div>`;
            if(cat==='kitchen') html += `<div class="flex-1 min-w-[300px] bg-white rounded-xl shadow-md p-3 flex flex-col border-t-8 border-yellow-400"><h3 class="font-black text-stone-700 mb-3 text-lg flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-yellow-400"></div> COCINANDO (${active.filter(o=>o.status==='preparing').length})</h3><div class="flex-1 overflow-y-auto space-y-3 p-1">${active.filter(o=>o.status==='preparing').map(o=>card(o,'preparing')).join('')}</div></div>`;
            html += `<div class="flex-1 min-w-[300px] bg-white rounded-xl shadow-md p-3 flex flex-col border-t-8 border-green-600"><h3 class="font-black text-stone-700 mb-3 text-lg flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-green-600"></div> LISTOS (${ready.length})</h3><div class="flex-1 overflow-y-auto space-y-3 p-1">${ready.map(o=>card(o,'ready')).join('')}</div></div>`;
            document.getElementById('content-area').innerHTML = html + `</div>`;
        }
        
        function card(o,s) {
            const t = tablesData.find(x=>x.id===o.tableId);
            const timeAgo = Math.floor((new Date()-new Date(o.timestamp?.seconds*1000))/60000);
            let btnClass = "bg-stone-500", btnText = "Acci√≥n";
            if(s==='ordered') { if(o.category==='bar') { btnText="Terminar"; btnClass="bg-green-600 hover:bg-green-700"; } else { btnText="Cocinar"; btnClass="bg-yellow-600 hover:bg-yellow-700"; } }
            else if(s==='preparing') { btnText="Terminar"; btnClass="bg-green-600 hover:bg-green-700"; } 
            else { btnText="Entregar"; btnClass="bg-blue-600 hover:bg-blue-700"; }
            let nextSt = s==='ordered' ? (o.category==='bar'?'ready':'preparing') : (s==='preparing'?'ready':'delivered');
            
            const isVip = t?.isVip;
            const cardBg = isVip ? "bg-pink-50 border-pink-300" : "bg-stone-50 border-stone-200";
            const vipBadge = isVip ? '<span class="bg-pink-500 text-white text-[10px] px-1 py-0.5 rounded ml-1"><i class="fa-solid fa-crown"></i></span>' : '';
            
            return `<div class="${cardBg} p-4 rounded-lg shadow border"><div class="flex justify-between font-bold text-lg mb-2"><span class="bg-stone-800 text-white px-2 py-0.5 rounded text-sm flex items-center">MESA ${t?t.number:'?'}${vipBadge}</span><span class="text-xs font-normal text-stone-500 bg-white border px-2 py-1 rounded flex items-center gap-1"><i class="fa-regular fa-clock"></i> ${timeAgo} min</span></div><div class="text-xl leading-tight text-stone-800 mb-2"><span class="font-black bg-amber-200 px-2 rounded-md mr-1">${o.quantity}</span> ${o.itemName}</div>${o.modifiers&&o.modifiers.length?`<div class="text-xs text-red-700 font-bold bg-red-50 p-2 rounded border border-red-100 mb-2 flex flex-col gap-1 items-start"><span>${o.modifiers.join(', ')}</span></div>`:''}<button onclick="upd('${o.id}','${nextSt}')" class="w-full ${btnClass} text-white py-3 mt-1 rounded-lg font-bold shadow-md active:translate-y-0.5 transition uppercase tracking-wide">${btnText}</button></div>`;
        }
        window.upd = async(id,s) => await updateDoc(doc(db,'orders',id),{status:s});

        window.openCloseAccountModal = (tid, total) => {
            const t = tablesData.find(x => x.id === tid);
            document.getElementById('modal-content').innerHTML = `
                <div class="p-6 text-center bg-[#fffbeb]">
                    <h3 class="font-black text-2xl text-amber-900 mb-1">MESA ${t.number}</h3>
                    <p class="text-stone-500 font-mono text-sm mb-4">Ticket #${t.uniqueId || '---'}</p>
                    
                    <!-- PAYMENT TOGGLE -->
                    <label class="flex items-center justify-center gap-2 mb-4 cursor-pointer bg-white p-3 rounded-lg shadow-sm border border-stone-200 hover:bg-stone-50 transition">
                        <input type="checkbox" id="close-card-check" onchange="calcCloseTotal(${total})" class="w-5 h-5 accent-blue-600">
                        <span class="font-bold text-stone-700 flex items-center gap-2"><i class="fa-solid fa-credit-card text-blue-600"></i> Pago con Tarjeta (+4%)</span>
                    </label>

                    <div class="bg-white p-4 rounded-xl shadow-inner border border-stone-200 mb-6">
                         <div id="close-breakdown" class="hidden text-sm mb-2 space-y-1 text-stone-500">
                            <div class="flex justify-between"><span>Subtotal:</span><span>$${total}</span></div>
                            <div class="flex justify-between text-red-600 font-bold"><span>Comisi√≥n (4%):</span><span id="close-comm-val">$0</span></div>
                            <div class="border-t border-stone-200 my-2"></div>
                        </div>
                        <span class="block text-stone-400 text-xs uppercase font-bold tracking-widest">Total a Pagar</span>
                        <span class="block text-5xl font-black text-stone-800" id="close-total-val">$${total}</span>
                    </div>
                    
                    <div class="flex flex-col gap-3">
                        <button onclick="openDebtModal('${tid}')" class="bg-blue-600 text-white py-3.5 rounded-lg font-bold shadow-md hover:bg-blue-700">Dejar en Deuda / Fiado</button>
                        <div class="flex gap-2"><button onclick="printR('${tid}')" class="flex-1 bg-stone-700 text-white py-3.5 rounded-lg font-bold shadow-md hover:bg-stone-800"><i class="fa-solid fa-print"></i> Ticket</button><button onclick="downloadPDF('${tid}')" class="flex-1 bg-red-700 text-white py-3.5 rounded-lg font-bold shadow-md hover:bg-red-800"><i class="fa-solid fa-file-pdf"></i> PDF</button></div>
                        <button onclick="closeFinal('${tid}')" class="bg-green-600 text-white py-3.5 rounded-lg font-bold shadow-lg border-b-4 border-green-800 active:border-b-0 active:translate-y-1 transition text-lg">COBRAR Y CERRAR</button>
                        <button onclick="closeModal()" class="text-stone-400 font-bold py-3 hover:text-stone-600 uppercase text-sm mt-2">Volver</button>
                    </div>
                </div>`;
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        window.calcCloseTotal = (total) => {
            const checked = document.getElementById('close-card-check').checked;
            const breakdown = document.getElementById('close-breakdown');
            const commEl = document.getElementById('close-comm-val');
            const finalEl = document.getElementById('close-total-val');

            if (checked) {
                const comm = total * 0.04;
                const final = total + comm;
                commEl.innerText = `$${comm.toFixed(2)}`;
                finalEl.innerText = `$${final.toFixed(2)}`;
                breakdown.classList.remove('hidden');
            } else {
                finalEl.innerText = `$${total}`;
                breakdown.classList.add('hidden');
            }
        }

        window.openDebtModal = (tid) => {
            document.getElementById('modal-content').innerHTML = `
                <div class="p-6 text-center bg-[#fffbeb]">
                    <h3 class="font-black text-xl mb-4 text-amber-900">DEJAR EN DEUDA</h3>
                    <p class="mb-2 text-stone-600 text-sm">¬øDejaron dinero a cuenta?</p>
                    
                    <input type="number" id="debt-deposit" value="0" oninput="calcDebtTotal()" class="w-full p-3 text-center text-2xl border-2 border-stone-300 rounded-lg font-bold mb-4 outline-none focus:border-blue-500 transition">
                    
                    <label class="flex items-center justify-center gap-2 mb-4 cursor-pointer bg-white p-2 rounded shadow-sm border border-stone-200">
                        <input type="checkbox" id="debt-card-check" onchange="calcDebtTotal()" class="w-5 h-5 accent-blue-600">
                        <span class="font-bold text-stone-600 text-sm">Pago con Tarjeta (+4%)</span>
                    </label>

                    <div id="debt-breakdown" class="hidden bg-stone-100 p-3 rounded mb-4 text-sm">
                        <div class="flex justify-between text-stone-500"><span>Monto a Cuenta:</span><span id="debt-base-val">$0</span></div>
                        <div class="flex justify-between text-red-500"><span>Comisi√≥n (4%):</span><span id="debt-comm-val">$0</span></div>
                        <div class="border-t border-stone-300 my-1"></div>
                        <div class="flex justify-between font-bold text-lg text-stone-800"><span>Total a Cobrar:</span><span id="debt-total-val">$0</span></div>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="openCloseAccountModal('${tid}', 0)" class="flex-1 py-3 text-stone-500 font-bold">Cancelar</button>
                        <button onclick="confirmDebt('${tid}')" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-bold shadow">Confirmar</button>
                    </div>
                </div>`;
        }

        window.calcDebtTotal = () => {
            const val = parseFloat(document.getElementById('debt-deposit').value) || 0;
            const checked = document.getElementById('debt-card-check').checked;
            const breakdown = document.getElementById('debt-breakdown');
            
            if (val > 0 && checked) {
                const comm = val * 0.04;
                const total = val + comm;
                document.getElementById('debt-base-val').innerText = `$${val}`;
                document.getElementById('debt-comm-val').innerText = `$${comm.toFixed(2)}`;
                document.getElementById('debt-total-val').innerText = `$${total.toFixed(2)}`;
                breakdown.classList.remove('hidden');
            } else {
                breakdown.classList.add('hidden');
            }
        }

        window.confirmDebt = async(id) => {
            const deposit = parseFloat(document.getElementById('debt-deposit').value) || 0;
            await updateDoc(doc(db,'tables',id), { status:'debt', debtDate: serverTimestamp(), deposit: deposit });
            closeModal();
            renderWaiterDashboard();
        }

        window.closeFinal = async(id)=>{ if(confirm("¬øCerrar Mesa?")) { await updateDoc(doc(db,'tables',id),{status:'closed', closedAt:serverTimestamp()}); closeModal(); renderWaiterDashboard(); } }
        
        window.printR = (tid) => {
            const t = tablesData.find(x=>x.id===tid);
            const ords = ordersData.filter(x=>x.tableId===tid && x.status!=='cancelled');
            const total = ords.reduce((acc,c)=>acc+(c.price*c.quantity),0);
            const deposit = t.deposit || 0;
            const remaining = total - deposit;
            const date = new Date().toLocaleString();
            const grouped = {};
            ords.forEach(o => { const key = o.itemName + (o.modifiers ? o.modifiers.join('') : ''); if(!grouped[key]) grouped[key] = { ...o, qty: 0, total: 0 }; grouped[key].qty += o.quantity; grouped[key].total += (o.price * o.quantity); });
            const itemsHtml = Object.values(grouped).map(o => `<div style="margin-bottom:6px; font-size:12px;"><div style="display:flex; justify-content:space-between; font-weight:bold;"><span>${o.qty} x ${o.itemName}</span><span>$${o.total}</span></div>${o.modifiers&&o.modifiers.length?`<div style="font-size:10px; font-style:italic; margin-left:10px;">- ${o.modifiers.join(', ')}</div>`:''}</div>`).join('');
            
            let totalHtml = `<div style="border-top:1px dashed #000; margin-top:15px; padding-top:10px; display:flex; justify-content:space-between; font-weight:bold; font-size:16px;"><span>TOTAL</span><span>$${total}</span></div>`;
            if (deposit > 0) {
                totalHtml = `
                    <div style="border-top:1px dashed #000; margin-top:10px; padding-top:5px; display:flex; justify-content:space-between; font-size:12px;"><span>Subtotal</span><span>$${total}</span></div>
                    <div style="display:flex; justify-content:space-between; font-size:12px;"><span>A Cuenta</span><span>-$${deposit}</span></div>
                    <div style="margin-top:5px; padding-top:5px; border-top:1px solid #000; display:flex; justify-content:space-between; font-weight:bold; font-size:16px;"><span>RESTANTE</span><span>$${remaining}</span></div>
                `;
            }

            document.getElementById('receipt-area').innerHTML = `<div style="text-align:center; margin-bottom:15px; font-family: monospace;"><img src="https://www.dropbox.com/scl/fi/htapbd4yf4m239y9zv2n1/Picture1.png?rlkey=o8je5uxe95avc9i9od6dmpbqh&raw=1" style="width: 60%; max-width: 150px; display: block; margin: 0 auto 10px auto;" onerror="this.style.display='none'"><h2 style="font-weight:bold; font-size:18px; margin:0;">A-LAS DE BARRIL</h2><p style="margin:0; font-size:10px;">--- COPIA CLIENTE ---</p><br><p style="margin:0; font-size:12px;">Ticket #${t.uniqueId||'---'}</p><p style="margin:0; font-size:12px;">${date}</p></div><div style="border-bottom:1px dashed #000; margin-bottom:10px;"></div><div style="font-weight:bold; margin-bottom:10px; font-size:14px;">Mesa: ${t.number}</div>${itemsHtml}${totalHtml}<div style="text-align:center; margin-top:30px; font-size:10px;"><p>¬°Gracias por su visita!</p><p>Wifi: AlasInvitado</p></div>`;
            window.print();
        }

        window.downloadPDF = (tid) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: [80, 200] }); 
            const t = tablesData.find(x=>x.id===tid);
            const ords = ordersData.filter(x=>x.tableId===tid && x.status!=='cancelled');
            const total = ords.reduce((acc,c)=>acc+(c.price*c.quantity),0);
            const deposit = t.deposit || 0;
            const remaining = total - deposit;
            doc.setFontSize(14); doc.text("A-LAS DE BARRIL", 40, 10, { align: "center" });
            doc.setFontSize(10); doc.text("Ticket #" + (t.uniqueId || '---'), 40, 18, { align: "center" });
            doc.text(new Date().toLocaleString(), 40, 23, { align: "center" });
            doc.line(5, 26, 75, 26); doc.text(`Mesa: ${t.number}`, 5, 32);
            let y = 38; doc.setFontSize(9);
            ords.forEach(o => {
                doc.text(`${o.quantity}x ${o.itemName}`, 5, y);
                doc.text(`$${o.price * o.quantity}`, 75, y, { align: "right" });
                y += 5;
                if(o.modifiers && o.modifiers.length) { doc.setFontSize(7); doc.text(`(${o.modifiers.join(', ')})`, 10, y); doc.setFontSize(9); y += 4; }
            });
            doc.line(5, y, 75, y); y += 5;
            if (deposit > 0) {
                doc.text("Subtotal:", 5, y); doc.text(`$${total}`, 75, y, { align: "right" }); y += 5;
                doc.text("A Cuenta:", 5, y); doc.text(`-$${deposit}`, 75, y, { align: "right" }); y += 5;
                doc.setFontSize(12); doc.text("RESTANTE:", 5, y); doc.text(`$${remaining}`, 75, y, { align: "right" });
            } else { doc.setFontSize(12); doc.text("TOTAL:", 5, y); doc.text(`$${total}`, 75, y, { align: "right" }); }
            y += 10; doc.setFontSize(8); doc.text("¬°Gracias por su visita!", 40, y, { align: "center" });
            doc.save(`Ticket_Mesa_${t.number}.pdf`);
        }

        initApp();
    </script>
</body>
