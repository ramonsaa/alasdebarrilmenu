<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GastroApp Pro - Alas de Barril</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Tipograf√≠a y Fondo R√∫stico */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #fffbeb; /* amber-50 */
            color: #451a03; /* amber-950 text */
            user-select: none; 
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @media print {
            body * { visibility: hidden; }
            #receipt-area, #receipt-area * { visibility: visible; }
            #receipt-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; color: black; }
            @page { margin: 0; size: auto; }
        }
        
        /* --- ESTILOS PERSONALIZADOS R√öSTICOS --- */
        
        /* Botones de Opci√≥n (Cervezas) */
        .option-btn { 
            @apply border-2 rounded-lg p-3 text-center cursor-pointer transition-all font-bold text-stone-600 bg-white border-stone-300; 
        }
        
        /* Cerveza Clara (Dorado) */
        .option-btn.clara.selected { 
            background-color: #fef9c3; /* yellow-200 */
            border-color: #eab308; /* yellow-500 */
            color: #854d0e; /* yellow-900 */
            box-shadow: inset 0 0 10px rgba(234, 179, 8, 0.2);
        }
        /* Cerveza Oscura (Caf√© Intenso) */
        .option-btn.oscura.selected { 
            background-color: #451a03; /* amber-950 */
            border-color: #78350f; /* amber-900 */
            color: #fef3c7; /* amber-100 */
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        
        /* Escarchados (Azul Intenso para contrastar con el amarillo/caf√©) */
        .prep-radio { 
            @apply border-2 rounded-lg p-3 text-center cursor-pointer transition-all font-medium text-stone-500 bg-white border-stone-300; 
        }
        .prep-radio.selected { 
            background-color: #e0f2fe; /* sky-100 */
            border-color: #0284c7; /* sky-600 */
            color: #0c4a6e; /* sky-900 */
            font-weight: 800; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Botones Modificadores Generales */
        .mod-btn { transition: all 0.2s; border-width: 1px; font-weight: 600; }
        
        /* Rojo (Quitar) - Tono Ladrillo */
        .mod-btn.btn-red { color: #991b1b; background-color: #fef2f2; border-color: #fca5a5; }
        .mod-btn.btn-red.selected { background-color: #b91c1c; color: white; border-color: #7f1d1d; }
        
        /* Verde (Agregar) - Tono Bosque */
        .mod-btn.btn-green { color: #166534; background-color: #f0fdf4; border-color: #86efac; }
        .mod-btn.btn-green.selected { background-color: #15803d; color: white; border-color: #14532d; }
        
        /* Neutro - Piedra */
        .mod-btn.btn-neutral { color: #57534e; background-color: white; border-color: #d6d3d1; }
        .mod-btn.btn-neutral.selected { background-color: #a8a29e; color: white; border-color: #57534e; }
        
        .cat-header { font-size: 0.85rem; font-weight: 900; text-transform: uppercase; color: #78350f; margin-top: 1.5rem; margin-bottom: 0.5rem; letter-spacing: 0.05em; border-bottom: 2px solid #d6d3d1; padding-bottom: 2px; }
        
        /* Sombras estilo madera */
        .wood-shadow { box-shadow: 2px 4px 6px rgba(69, 26, 3, 0.15); }
    </style>
</head>
<body>

    <div id="app" class="h-screen w-full flex flex-col overflow-hidden relative">
        <!-- Header R√∫stico (Madera Oscura) -->
        <header id="main-header" class="bg-amber-950 text-amber-50 p-3 shadow-md flex justify-between items-center z-10 shrink-0 relative border-b-4 border-amber-700">
            <div class="flex items-center gap-3">
                <!-- LOGO EN HEADER (Peque√±o, B&N) - Usando Picture1 -->
                <div class="bg-white p-1 rounded-full border-2 border-amber-600 overflow-hidden w-12 h-12 flex items-center justify-center shadow-sm">
                    <img src="https://www.dropbox.com/scl/fi/htapbd4yf4m239y9zv2n1/Picture1.png?rlkey=o8je5uxe95avc9i9od6dmpbqh&raw=1" alt="Logo" class="w-full h-full object-contain" onerror="this.src='https://placehold.co/100x100?text=AB'">
                </div>
                <h1 class="font-bold text-xl tracking-wide" id="header-title" style="font-family: 'Courier New', Courier, monospace;">ALAS DE BARRIL</h1>
            </div>
            
            <div id="status-indicator" class="hidden absolute left-1/2 transform -translate-x-1/2 px-4 py-1 rounded-sm border text-xs font-bold shadow-lg flex items-center gap-2 top-14 md:top-auto">
                <span id="status-text"></span>
            </div>

            <button onclick="logoutToHome()" class="text-xs bg-amber-900 border border-amber-700 px-3 py-1.5 rounded hover:bg-amber-800 transition uppercase font-bold tracking-wider text-amber-100">
                <i class="fa-solid fa-right-from-bracket"></i> Salir
            </button>
        </header>

        <!-- Contenido (Fondo Crema) -->
        <main id="content-area" class="flex-1 overflow-y-auto bg-amber-50 relative flex flex-col p-1">
            <div class="flex flex-col justify-center items-center h-full text-amber-800 opacity-50 gap-4">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl"></i>
                <p class="text-sm font-bold animate-pulse">Cargando sistema...</p>
            </div>
        </main>

        <!-- √Årea Ticket (Oculto) -->
        <div id="receipt-area" class="hidden bg-white p-4 text-xs w-[300px] mx-auto font-mono"></div>
    </div>

    <!-- Modales -->
    <div id="modal-overlay" class="fixed inset-0 bg-stone-900 bg-opacity-70 hidden z-50 flex justify-center items-center p-4 backdrop-blur-sm">
        <div id="modal-content" class="bg-[#fffbeb] rounded-xl shadow-2xl w-full max-w-md overflow-hidden max-h-[90vh] flex flex-col border-4 border-amber-900/10"></div>
    </div>

    <script type="module">
        // Usamos una versi√≥n estable 10.13.1 para asegurar compatibilidad
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, query, orderBy, serverTimestamp, enableIndexedDbPersistence, runTransaction } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        // --- CONFIGURACI√ìN DE PRODUCCI√ìN ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqrR3FQ7L7KCE5Wg8thRvyA6GpiUV2DPs",
            authDomain: "alasdebarrilwings.firebaseapp.com",
            projectId: "alasdebarrilwings",
            storageBucket: "alasdebarrilwings.firebasestorage.app",
            messagingSenderId: "826542576836",
            appId: "1:826542576836:web:dd1bc6f8bc4fd73d57a591"
        };

        let app, auth, db;

        // --- INICIALIZACI√ìN ROBUSTA ---
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            // Intentar persistencia offline, pero no bloquear si falla
            enableIndexedDbPersistence(db).catch(err => {
                console.warn("Persistencia offline no disponible:", err.code);
            });
        } catch (e) {
            console.error("Error cr√≠tico inicializando Firebase:", e);
            showError("Error de Configuraci√≥n", e.message);
        }

        // --- GESTI√ìN DE ESTADO ONLINE/OFFLINE ---
        function updateStatusDisplay() {
            const ind = document.getElementById('status-indicator');
            const txt = document.getElementById('status-text');
            
            if (!navigator.onLine) {
                ind.className = "absolute left-1/2 transform -translate-x-1/2 bg-red-700 px-4 py-1 rounded-sm border border-red-900 text-xs font-bold shadow-lg animate-pulse flex items-center gap-2 text-white top-14 md:top-auto";
                ind.classList.remove('hidden');
                txt.innerHTML = '<i class="fa-solid fa-wifi"></i> MODO OFFLINE';
            } else {
                ind.classList.add('hidden');
            }
        }
        window.addEventListener('online', updateStatusDisplay);
        window.addEventListener('offline', updateStatusDisplay);
        updateStatusDisplay();

        // Funci√≥n para mostrar errores de configuraci√≥n amigables
        function showError(title, details) {
            document.getElementById('content-area').innerHTML = `
                <div class="flex flex-col justify-center items-center h-full p-6 text-center max-w-lg mx-auto">
                    <div class="bg-white p-6 rounded-xl shadow-xl border-l-8 border-red-600">
                        <i class="fa-solid fa-circle-exclamation text-red-600 text-5xl mb-4"></i>
                        <h2 class="text-xl font-bold text-stone-800 mb-2">${title}</h2>
                        <p class="text-stone-600 mb-4 text-sm">${details}</p>
                        <div class="text-left bg-stone-100 p-3 rounded text-xs text-stone-500 font-mono mb-4">
                            1. Ve a Firebase Console > Authentication<br>
                            2. Pesta√±a "Sign-in method"<br>
                            3. Habilita "Anonymous" (An√≥nimo)<br>
                            4. Ve a Settings > Authorized Domains<br>
                            5. Agrega este dominio si no es localhost.
                        </div>
                        <button onclick="location.reload()" class="bg-amber-700 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-amber-800 transition">Reintentar Conexi√≥n</button>
                    </div>
                </div>`;
        }

        let currentUser = null, ordersData = [], tablesData = [];
        let currentRole = null, currentTableId = null, showingDebts = false;

        // --- DATOS MAESTROS ---
        const MODIFIERS = {
            burgers: ["Sin cebolla", "Sin jitomate", "Sin pi√±a", "Sin picante", "Sin catsup", "Sin mayonesa", "Sin queso", "Sin jam√≥n", "Sin carne"],
            hotdogs: ["Sin jitomate", "Sin cebolla", "Sin pi√±a", "Sin picante", "Sin catsup", "Sin mayonesa", "Sin salchicha", "Sin tocino"],
            salsas: ["Bbq", "Mango", "Habanero", "Tamarindo", "Jamaica", "Frutos rojos", "Pi√±a", "Chipotle", "B√∫falo", "Lemon pepper", "A la diabla"],
            snacks: ["Sin queso", "Sin crema", "Sin catsup", "Sin salsa", "Sin vegetales"],
            sodas: ["Coca", "Boing Mango", "Boing Guayaba", "Manzanita", "Jarrito", "Squirt"],
            coolers: ["Durazno", "Fresa", "Vino", "Manzana Kiwi"],
            general_kitchen: ["Para llevar", "Sin cubiertos"],
            general_bar: ["Poca az√∫car", "Sin popote"]
        };

        const MENU = [
            // BARRA
            { id: 'b_md', name: 'Barril 1/2 Lt', price: 35, category: 'bar', isBeer: true, type: 'regular', icon: 'fa-beer-mug-empty' },
            { id: 'b_1l', name: 'Barril 1 Lt', price: 70, category: 'bar', isBeer: true, type: 'regular', icon: 'fa-beer-mug-empty' },
            { id: 'b_md_negra', name: 'Barril Negra 1/2 Lt', price: 45, category: 'bar', isBeer: true, type: 'dark', icon: 'fa-beer-mug-empty' },
            { id: 'b_1l_negra', name: 'Barril Negra 1 Lt', price: 90, category: 'bar', isBeer: true, type: 'dark', icon: 'fa-beer-mug-empty' },
            { id: 'b_emb', name: 'Cerveza Embotellada', price: 30, category: 'bar', isBeer: true, type: 'bottled', icon: 'fa-bottle-droplet' },
            { id: 'b_cig', name: 'Cigarro', price: 7, category: 'bar', modGroup: 'general_bar', icon: 'fa-smoking' },
            { id: 'b_ref', name: 'Refresco', price: 25, category: 'bar', modGroup: 'sodas', icon: 'fa-bottle-water' },
            { id: 'b_coo', name: 'Caribe Cooler', price: 30, category: 'bar', modGroup: 'coolers', icon: 'fa-wine-bottle' },
            // COCINA
            { id: 'h1', name: 'Hamburguesa Sencilla', price: 55, category: 'kitchen', modGroup: 'burgers', icon: 'fa-burger' },
            { id: 'h2', name: 'Hamburguesa Especial', price: 70, category: 'kitchen', modGroup: 'burgers', icon: 'fa-burger' },
            { id: 'h3', name: 'Hamburguesa Arrachera', price: 90, category: 'kitchen', modGroup: 'burgers', icon: 'fa-burger' },
            { id: 'h4', name: 'Hamburguesa Camar√≥n', price: 80, category: 'kitchen', modGroup: 'burgers', icon: 'fa-shrimp' },
            { id: 'h5', name: 'Hamburguesa Pollo', price: 65, category: 'kitchen', modGroup: 'burgers', icon: 'fa-drumstick-bite' },
            { id: 'c1', name: 'Tenders de Pollo', price: 75, category: 'kitchen', modGroup: 'salsas', icon: 'fa-drumstick-bite' },
            { id: 'c2', name: 'Boneless', price: 70, category: 'kitchen', modGroup: 'salsas', icon: 'fa-drumstick-bite' },
            { id: 'c3', name: 'Alitas', price: 50, category: 'kitchen', modGroup: 'salsas', icon: 'fa-dove' },
            { id: 's1', name: 'Papas a la francesa', price: 40, category: 'kitchen', modGroup: 'snacks', icon: 'fa-utensils' },
            { id: 's2', name: 'Salchipapas', price: 50, category: 'kitchen', modGroup: 'snacks', icon: 'fa-bacon' },
            { id: 's3', name: 'Aros de Cebolla', price: 45, category: 'kitchen', modGroup: 'snacks', icon: 'fa-ring' },
            { id: 'hd1', name: 'Hot Dog Sencillo', price: 25, category: 'kitchen', modGroup: 'hotdogs', icon: 'fa-hotdog' },
            { id: 'hd2', name: 'Hot Dog Especial', price: 40, category: 'kitchen', modGroup: 'hotdogs', icon: 'fa-hotdog' },
            { id: 'p1', name: 'Paquete 1 (Alitas/Boneless/Papas/2 Tarros)', price: 235, category: 'kitchen', modGroup: 'salsas', icon: 'fa-box-open' },
            { id: 'p2', name: 'Paquete 2 (Alitas/2 Burg/Papas/2 Tarros)', price: 255, category: 'kitchen', modGroup: 'salsas', icon: 'fa-box-open' },
            { id: 'p3', name: 'Paquete 3 (Alitas/Boneless/Aros/3HD/3Cerv)', price: 310, category: 'kitchen', modGroup: 'salsas', icon: 'fa-box-open' },
        ];

        // --- AUTH & INIT ---
        async function initApp() {
            try {
                // Intentar login an√≥nimo
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Auth error detallado:", error);
                
                let msg = "No se pudo conectar a la base de datos.";
                if (error.code === 'auth/configuration-not-found') {
                    msg = "Falta habilitar el inicio de sesi√≥n 'An√≥nimo' en Firebase Console.";
                } else if (error.code === 'auth/operation-not-allowed') {
                    msg = "El inicio de sesi√≥n 'An√≥nimo' est√° deshabilitado en Firebase.";
                } else if (error.code === 'auth/network-request-failed') {
                    msg = "Error de red. Verifica tu conexi√≥n a internet.";
                } else if (error.code === 'auth/unauthorized-domain') {
                    msg = "Este dominio no est√° autorizado en Firebase Console.";
                }
                
                // Mostrar UI de error pero permitir intentar usar la app en modo visual (sin datos)
                showError("Error de Autenticaci√≥n", msg);
            }
        }
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                // ESCUCHADORES EN TIEMPO REAL (Rutas simplificadas para producci√≥n)
                // Usamos manejo de errores en onSnapshot para no romper la app si fallan los permisos
                onSnapshot(collection(db, 'tables'), 
                    (s) => { 
                        tablesData = s.docs.map(d=>({id:d.id, ...d.data()})); 
                        refreshCurrentView(); 
                    },
                    (error) => {
                        console.error("Error leyendo tablas (posiblemente permisos):", error);
                        // Si falla la lectura, no bloqueamos la UI, solo no mostramos datos
                    }
                );
                
                onSnapshot(collection(db, 'orders'), 
                    (s) => { 
                        ordersData = s.docs.map(d=>({id:d.id, ...d.data()})); 
                        refreshCurrentView(); 
                    },
                    (error) => console.error("Error leyendo √≥rdenes:", error)
                );
                
                // Si todo va bien, renderizamos
                renderHome();
            }
        });

        // --- VISTAS ---
        function refreshCurrentView() {
            if(!currentRole) return;
            if(currentRole === 'waiter') currentTableId ? renderTableDetail(currentTableId) : renderWaiterDashboard();
            else if(currentRole === 'kitchen') renderBoard('kitchen');
            else if(currentRole === 'bar') renderBoard('bar');
        }

        window.renderHome = () => {
            currentRole = null;
            document.getElementById('header-title').innerText = 'Alas de Barril';
            document.getElementById('content-area').innerHTML = `
                <div class="p-6 flex flex-col gap-6 h-full justify-center items-center max-w-md mx-auto">
                    <!-- LOGO A COLOR GRANDE - Usando Picture2 -->
                    <img src="https://www.dropbox.com/scl/fi/jymn0kvgyx9ioqjojwbfw/Picture2.png?rlkey=u4k3ppl3f7vohb07au7bt8tw4&raw=1" class="w-48 mb-2 rounded-xl shadow-lg border-4 border-amber-900/10" alt="Alas de Barril Logo" onerror="this.src='https://placehold.co/200x200?text=LOGO'">
                    
                    <h2 class="text-2xl font-bold text-amber-900 mb-2 border-b-4 border-amber-500 pb-2">SELECCIONA PERFIL</h2>
                    
                    <button onclick="setRole('waiter')" class="w-full bg-yellow-700 hover:bg-yellow-800 text-white p-6 rounded-xl text-xl font-bold flex gap-4 items-center wood-shadow transition transform active:scale-95 border-2 border-yellow-900">
                        <div class="bg-yellow-900 p-3 rounded-full text-yellow-100"><i class="fa-solid fa-mobile-screen"></i></div>
                        <span>Mesero</span>
                    </button>
                    
                    <button onclick="setRole('bar')" class="w-full bg-amber-800 hover:bg-amber-900 text-white p-6 rounded-xl text-xl font-bold flex gap-4 items-center wood-shadow transition transform active:scale-95 border-2 border-amber-950">
                        <div class="bg-amber-950 p-3 rounded-full text-amber-100"><i class="fa-solid fa-beer-mug-empty"></i></div>
                        <span>Barra</span>
                    </button>
                    
                    <button onclick="setRole('kitchen')" class="w-full bg-orange-800 hover:bg-orange-900 text-white p-6 rounded-xl text-xl font-bold flex gap-4 items-center wood-shadow transition transform active:scale-95 border-2 border-orange-950">
                        <div class="bg-orange-950 p-3 rounded-full text-orange-100"><i class="fa-solid fa-fire-burner"></i></div>
                        <span>Cocina</span>
                    </button>
                </div>`;
        }
        window.setRole = (r) => { currentRole = r; refreshCurrentView(); }

        // --- DASHBOARD MESERO ---
        window.renderWaiterDashboard = () => {
            currentTableId = null;
            document.getElementById('header-title').innerText = 'Control de Mesas';
            
            const now = Date.now();
            const eightDaysMs = 8 * 24 * 60 * 60 * 1000;

            const openTables = tablesData.filter(t => t.status === 'open').sort((a,b) => (b.openedAt?.seconds||0) - (a.openedAt?.seconds||0));
            const debtTables = tablesData.filter(t => t.status === 'debt').sort((a,b) => (b.debtDate?.seconds||0) - (a.debtDate?.seconds||0));
            const closedTables = tablesData.filter(t => {
                if (t.status !== 'closed') return false;
                const closedDate = t.closedAt?.seconds * 1000 || 0;
                return (now - closedDate) < eightDaysMs;
            }).sort((a,b) => (b.closedAt?.seconds||0) - (a.closedAt?.seconds||0));

            const btnClass = showingDebts ? 'bg-amber-700 text-amber-50' : 'bg-stone-600 text-stone-200';

            let html = `
                <div class="p-4 flex flex-col gap-6 pb-24">
                    <!-- BUSCADOR -->
                    <div class="flex gap-2 bg-white p-2 rounded-lg shadow-sm border border-amber-200">
                        <input type="number" id="search-ticket-id" placeholder="Buscar Ticket #" class="flex-1 p-2 rounded bg-transparent outline-none text-stone-700 placeholder-stone-400 font-mono font-bold">
                        <button onclick="searchTicket()" class="bg-stone-700 text-white px-4 rounded hover:bg-stone-800"><i class="fa-solid fa-search"></i></button>
                    </div>

                    <!-- BOTONERA SUPERIOR -->
                    <div class="flex gap-3">
                         <button onclick="toggleDebtView()" class="flex-1 ${btnClass} py-3 rounded-lg font-bold shadow-md border-b-4 border-black/20 text-sm">
                            ${showingDebts ? '‚¨Ö Ver Mesas Activas' : 'üìÇ Ver Deudas / Fiado'}
                         </button>
                    </div>

                    <!-- SECCIONES -->
                    <div>
                        <div class="flex justify-between items-end mb-3 border-b-2 border-amber-200 pb-1">
                            <h3 class="font-black text-amber-900 text-lg uppercase tracking-wider">
                                ${showingDebts ? 'Deudas Pendientes' : 'Mesas Abiertas'}
                            </h3>
                            ${!showingDebts ? `<button onclick="openNewTableModal()" class="bg-green-700 hover:bg-green-800 text-white text-xs font-bold px-3 py-1.5 rounded shadow flex items-center gap-1 border border-green-900"><i class="fa-solid fa-plus"></i> NUEVA</button>` : ''}
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            ${!showingDebts && openTables.length === 0 ? '<p class="col-span-2 text-stone-400 text-sm text-center italic py-4 bg-stone-100 rounded border border-dashed border-stone-300">No hay mesas abiertas</p>' : ''}
                            ${showingDebts && debtTables.length === 0 ? '<p class="col-span-2 text-stone-400 text-sm text-center italic py-4 bg-stone-100 rounded border border-dashed border-stone-300">No hay deudas</p>' : ''}
                            
                            ${!showingDebts ? openTables.map(t => createTableCard(t)).join('') : debtTables.map(t => createTableCard(t)).join('')}
                        </div>
                    </div>

                    <!-- HISTORIAL (Solo visible en modo normal) -->
                    ${!showingDebts ? `
                    <div class="mt-4 opacity-75">
                        <h3 class="font-bold text-stone-500 text-sm uppercase mb-2 border-b border-stone-300 pb-1">Cerradas (8 d√≠as)</h3>
                        <div class="grid grid-cols-2 gap-3">
                            ${closedTables.length ? closedTables.map(t => createTableCard(t)).join('') : '<p class="col-span-2 text-stone-400 text-xs text-center">Historial vac√≠o</p>'}
                        </div>
                    </div>` : ''}
                </div>`;
            document.getElementById('content-area').innerHTML = html;
        }

        function createTableCard(t) {
            const ords = ordersData.filter(o => o.tableId === t.id && o.status !== 'cancelled');
            const total = ords.reduce((a,c) => a + (c.price * c.quantity), 0);
            
            let cardBg = 'bg-white';
            let borderColor = 'border-stone-300';
            let badge = '';
            
            if (t.status === 'open') {
                const pending = ords.some(o => o.status !== 'delivered');
                borderColor = pending ? 'border-yellow-500' : 'border-green-600';
                // Efecto madera clara si est√° abierta
                cardBg = 'bg-[#fffef0]'; 
                badge = pending ? '<i class="fa-solid fa-clock text-yellow-600 animate-pulse"></i>' : '<i class="fa-solid fa-check text-green-600"></i>';
            } else if (t.status === 'debt') {
                borderColor = 'border-red-500';
                cardBg = 'bg-red-50';
                badge = '<i class="fa-solid fa-file-invoice-dollar text-red-600"></i>';
            } else {
                cardBg = 'bg-stone-200';
                badge = '<i class="fa-solid fa-lock text-stone-400"></i>';
            }

            return `
                <div onclick="renderTableDetail('${t.id}')" class="${cardBg} rounded-lg shadow-sm p-3 border-b-4 ${borderColor} relative cursor-pointer active:scale-95 transition border-l border-r border-t">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[10px] font-mono font-bold text-stone-400 bg-stone-100 px-1 rounded border border-stone-200">#${t.uniqueId || '---'}</span>
                        ${badge}
                    </div>
                    <div class="text-2xl font-black text-stone-800 leading-none mb-1">${t.number}</div>
                    <div class="text-xs text-stone-500 truncate font-semibold mb-2 uppercase tracking-wide">${t.nickname}</div>
                    <div class="text-lg font-bold text-amber-800 text-right border-t border-dashed border-stone-300 pt-1">$${total}</div>
                </div>`;
        }

        window.toggleDebtView = () => { showingDebts = !showingDebts; renderWaiterDashboard(); }

        window.searchTicket = async () => {
            const ticketId = parseInt(document.getElementById('search-ticket-id').value);
            if (!ticketId) return;
            let found = tablesData.find(t => t.uniqueId === ticketId);
            if(found) renderTableDetail(found.id);
            else alert("Ticket no encontrado en el historial reciente.");
        }

        // --- DETALLE MESA ---
        window.renderTableDetail = (tid) => {
            currentTableId = tid;
            const t = tablesData.find(x => x.id === tid);
            if(!t) return renderWaiterDashboard();
            
            const uniqueDisplay = t.uniqueId ? `#${t.uniqueId}` : '';
            const ords = ordersData.filter(o => o.tableId === tid && o.status !== 'cancelled').sort((a,b) => b.timestamp?.seconds - a.timestamp?.seconds);
            const total = ords.reduce((a,c) => a + (c.price * c.quantity), 0);
            const isClosed = t.status === 'closed';
            
            // Texto din√°mico bot√≥n cerrar
            let closeBtnText = "Cerrar Cuenta";
            let closeBtnColor = "bg-green-700";
            if (t.status === 'debt') { closeBtnText = "Liquidar Deuda"; closeBtnColor = "bg-blue-700"; }

            const footerHtml = isClosed ? 
                `<div class="text-center font-bold text-stone-500 p-4 bg-stone-200 border-t border-stone-300">Mesa Cerrada - Solo Lectura</div>` :
                `<div id="order-footer" class="fixed bottom-0 w-full bg-[#fffbeb] p-3 shadow-[0_-4px_10px_rgba(0,0,0,0.1)] z-30 border-t border-amber-200">
                     <div class="flex justify-between mb-3 font-black text-xl text-amber-900 px-2"><span>Total</span><span>$${total}</span></div>
                     <button onclick="openCloseAccountModal('${tid}', ${total})" class="w-full ${closeBtnColor} text-white py-3.5 rounded-lg font-bold shadow-lg border-b-4 border-black/20 active:border-b-0 active:translate-y-1 transition uppercase tracking-wide">${closeBtnText}</button>
                </div>`;

            // TABS ESTILIZADOS
            const activeTabClass = "flex-1 py-3 text-amber-800 border-b-4 border-amber-600 bg-amber-50 font-bold";
            const inactiveTabClass = "flex-1 py-3 text-stone-400 font-bold hover:bg-stone-50 transition";

            let html = `<div class="flex flex-col h-full bg-white">
                <!-- Barra Sup -->
                <div class="bg-amber-900 text-white p-3 flex items-center justify-between shadow-md shrink-0">
                    <button onclick="renderWaiterDashboard()" class="text-amber-100 font-bold text-sm flex items-center gap-2"><i class="fa-solid fa-chevron-left"></i> Volver</button>
                    <div class="text-center">
                        <div class="font-black text-lg leading-none">MESA ${t.number}</div>
                        <div class="text-[10px] font-mono text-amber-300 opacity-80">Ticket ${uniqueDisplay}</div>
                    </div>
                    <div class="w-10"></div> <!-- Spacer -->
                </div>

                <!-- TABS -->
                <div class="bg-white shadow-sm flex border-b border-stone-200 shrink-0">
                    <button onclick="switchTab('menu')" id="tab-btn-menu" class="${activeTabClass}">MEN√ö</button>
                    <button onclick="switchTab('orders')" id="tab-btn-orders" class="${inactiveTabClass}">CUENTA ($${total})</button>
                </div>
                
                <!-- MENU -->
                <div id="tab-menu" class="flex-1 overflow-y-auto p-4 pb-24 ${isClosed ? 'hidden' : ''} bg-stone-50">
                    <h3 class="cat-header">Cocina</h3><div class="grid gap-3 mb-6">${renderMenuSection('kitchen')}</div>
                    <h3 class="cat-header">Barra</h3><div class="grid gap-3">${renderMenuSection('bar')}</div>
                </div>
                
                <!-- CUENTA -->
                <div id="tab-orders" class="${isClosed ? '' : 'hidden'} flex-1 overflow-y-auto p-4 pb-32 bg-stone-100">
                    ${ords.length === 0 ? '<div class="text-center py-10 text-stone-400 italic">Mesa vac√≠a</div>' : ''}
                    ${ords.map(o => {
                        // Estado visual del pedido
                        let stClass = "bg-stone-200 text-stone-500";
                        let stIcon = "fa-clock";
                        if(o.status === 'preparing') { stClass = "bg-yellow-100 text-yellow-700 border border-yellow-300"; stIcon = "fa-fire"; }
                        if(o.status === 'ready') { stClass = "bg-green-100 text-green-700 border border-green-300"; stIcon = "fa-check"; }
                        if(o.status === 'delivered') { stClass = "bg-blue-50 text-blue-700 border border-blue-200"; stIcon = "fa-thumbs-up"; }

                        return `<div class="bg-white p-3 rounded-lg shadow-sm mb-3 border border-stone-200">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-bold text-stone-800 text-lg leading-tight">${o.quantity}x ${o.itemName}</div>
                                ${o.modifiers&&o.modifiers.length?`<div class="text-xs text-red-600 font-semibold mt-1 bg-red-50 p-1 rounded inline-block border border-red-100"><i class="fa-solid fa-pen-to-square"></i> ${o.modifiers.join(', ')}</div>`:''}
                                <div class="text-[10px] text-stone-400 mt-1 font-mono">${new Date(o.timestamp?.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-amber-800 text-lg">$${o.price*o.quantity}</div>
                                <span class="text-[10px] font-bold px-2 py-0.5 rounded-full flex items-center gap-1 justify-end ${stClass}"><i class="fa-solid ${stIcon}"></i> ${o.status}</span>
                            </div>
                        </div></div>`;
                    }).join('')}
                </div>
                ${footerHtml}</div>`;
            document.getElementById('content-area').innerHTML = html;
        }

        function renderMenuSection(cat) {
            return MENU.filter(i => i.category === cat).map(i => `
                <button onclick="openCustomizeModal('${i.id}')" class="bg-white p-3 rounded-lg shadow-sm flex justify-between items-center text-left active:bg-amber-50 border border-stone-200 active:border-amber-300 transition group">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-amber-50 rounded-full flex items-center justify-center text-amber-700 group-active:scale-110 transition border border-amber-100"><i class="fa-solid ${i.icon}"></i></div>
                        <div><div class="font-bold text-stone-700 group-active:text-amber-900">${i.name}</div><div class="text-xs text-stone-500 font-mono">$${i.price}</div></div>
                    </div>
                    <div class="bg-amber-100 text-amber-700 w-8 h-8 rounded-full flex items-center justify-center font-bold shadow-sm group-active:bg-amber-500 group-active:text-white transition"><i class="fa-solid fa-plus"></i></div>
                </button>`).join('');
        }

        // --- MODAL DE PERSONALIZACI√ìN ---
        window.openCustomizeModal = function(itemId) {
            const item = MENU.find(i => i.id === itemId);
            const modal = document.getElementById('modal-content');
            
            if (item.isBeer && item.category === 'bar') {
                const isGeneric = item.type === 'regular'; 
                modal.innerHTML = `
                    <div class="flex-1 flex flex-col h-full max-h-[85vh] bg-[#fffbeb]">
                        <div class="p-4 border-b border-amber-200 bg-amber-50 flex justify-between items-center">
                            <div><h3 class="font-black text-xl text-amber-900 uppercase">${item.name}</h3><p class="text-stone-500 font-bold">$${item.price}</p></div>
                            <button onclick="closeModal()" class="text-stone-400 text-xl"><i class="fa-solid fa-times"></i></button>
                        </div>
                        <div class="p-5 overflow-y-auto flex-1 space-y-5">
                            
                            <!-- Cantidad -->
                            <div class="flex justify-center items-center gap-6 bg-white p-3 rounded-xl shadow-inner border border-stone-200">
                                <button onclick="adjQty(-1)" class="w-12 h-12 rounded-full bg-stone-200 text-stone-600 text-2xl font-bold hover:bg-stone-300">-</button>
                                <span id="modal-qty" class="text-4xl font-black text-amber-900">1</span>
                                <button onclick="adjQty(1)" class="w-12 h-12 rounded-full bg-amber-600 text-white text-2xl font-bold hover:bg-amber-700 shadow-lg border-b-4 border-amber-800 active:border-b-0 active:translate-y-1 transition">+</button>
                            </div>

                            ${isGeneric ? `
                            <div>
                                <h4 class="text-xs font-bold text-stone-400 uppercase mb-2">Tipo de Cerveza (Selecciona 1)</h4>
                                <div class="grid grid-cols-2 gap-3" id="beer-type-group">
                                    <div onclick="selectBeerType(this)" class="option-btn clara selected" data-val="Clara">CLARA</div>
                                    <div onclick="selectBeerType(this)" class="option-btn oscura" data-val="Oscura">OSCURA</div>
                                </div>
                            </div>` : ''}

                            <div>
                                <h4 class="text-xs font-bold text-stone-400 uppercase mb-2">Preparaci√≥n (Selecciona 1)</h4>
                                <div class="grid grid-cols-1 gap-2" id="beer-prep-group">
                                    <div onclick="selectBeerPrep(this)" class="prep-radio" data-val="Escarchado Sal">Escarchado Sal</div>
                                    <div onclick="selectBeerPrep(this)" class="prep-radio selected" data-val="Escarchado Chamoy">Escarchado Chamoy</div>
                                    <div onclick="selectBeerPrep(this)" class="prep-radio" data-val="Sin Escarchar">Sin Escarchar</div>
                                </div>
                            </div>
                            
                            <!-- Toggles -->
                            <div class="flex gap-2">
                                <button onclick="toggleMod(this)" class="mod-btn btn-red flex-1 py-3 rounded-lg font-bold shadow-sm" id="btn-sin-limon">SIN LIM√ìN</button>
                                <button onclick="toggleMod(this)" class="mod-btn btn-red flex-1 py-3 rounded-lg font-bold shadow-sm hidden" id="btn-sin-ajonjoli">SIN AJONJOL√ç</button>
                            </div>

                            <!-- Extras -->
                            <div onclick="toggleMod(this)" class="mod-btn btn-green p-3 rounded-lg flex justify-between items-center cursor-pointer mt-2 shadow-sm border-2" id="btn-clamato">
                                <span class="font-bold flex items-center gap-2"><i class="fa-solid fa-droplet"></i> EXTRA CLAMATO</span>
                                <span class="font-black bg-green-700 text-white px-2 py-0.5 rounded text-xs">+$5</span>
                            </div>

                            <input type="text" id="manual-note" placeholder="Nota extra para barra..." class="w-full border-2 border-stone-300 rounded-lg p-3 text-sm focus:border-amber-500 outline-none bg-white">
                        </div>
                        <div class="p-4 border-t border-amber-200 bg-white flex gap-3">
                            <button onclick="closeModal()" class="flex-1 py-3.5 rounded-lg border-2 border-stone-300 text-stone-500 font-bold hover:bg-stone-50">CANCELAR</button>
                            <button onclick="submitBeerOrder('${item.id}')" class="flex-1 py-3.5 rounded-lg bg-amber-600 text-white font-bold shadow-lg border-b-4 border-amber-800 active:border-b-0 active:translate-y-1 transition">AGREGAR</button>
                        </div>
                    </div>`;
                checkChamoy();
            } else {
                let mods = item.modGroup ? MODIFIERS[item.modGroup] : (MODIFIERS['general_' + item.category] || []);
                modal.innerHTML = `
                    <div class="flex-1 flex flex-col h-full max-h-[85vh] bg-[#fffbeb]">
                        <div class="p-4 border-b border-amber-200 bg-amber-50 flex justify-between items-center">
                            <div><h3 class="font-black text-xl text-amber-900 uppercase">${item.name}</h3><p class="text-stone-500 font-bold">$${item.price}</p></div>
                            <button onclick="closeModal()" class="text-stone-400 text-xl"><i class="fa-solid fa-times"></i></button>
                        </div>
                        <div class="p-5 overflow-y-auto flex-1">
                            <div class="flex justify-center items-center gap-6 mb-6 bg-white p-3 rounded-xl shadow-inner border border-stone-200">
                                <button onclick="adjQty(-1)" class="w-12 h-12 rounded-full bg-stone-200 text-stone-600 text-2xl font-bold hover:bg-stone-300">-</button>
                                <span id="modal-qty" class="text-4xl font-black text-amber-900">1</span>
                                <button onclick="adjQty(1)" class="w-12 h-12 rounded-full bg-amber-600 text-white text-2xl font-bold hover:bg-amber-700 shadow-lg border-b-4 border-amber-800 active:border-b-0 active:translate-y-1 transition">+</button>
                            </div>
                            ${mods.length > 0 ? `<div class="flex flex-wrap gap-2 mb-4">${mods.map(m => {
                                let cls = m.startsWith("Sin") ? "btn-red" : (m.startsWith("Con")||m.includes("+") ? "btn-green" : "btn-neutral");
                                return `<button onclick="toggleMod(this)" class="mod-btn px-3 py-2 rounded-lg text-sm shadow-sm ${cls}">${m}</button>`;
                            }).join('')}</div>` : ''}
                            <input type="text" id="manual-note" placeholder="Nota de cocina..." class="w-full border-2 border-stone-300 rounded-lg p-3 text-sm focus:border-amber-500 outline-none bg-white">
                        </div>
                        <div class="p-4 border-t border-amber-200 bg-white flex gap-3">
                            <button onclick="closeModal()" class="flex-1 py-3.5 rounded-lg border-2 border-stone-300 text-stone-500 font-bold hover:bg-stone-50">CANCELAR</button>
                            <button onclick="submitGeneralOrder('${item.id}')" class="flex-1 py-3.5 rounded-lg bg-amber-600 text-white font-bold shadow-lg border-b-4 border-amber-800 active:border-b-0 active:translate-y-1 transition">AGREGAR</button>
                        </div>
                    </div>`;
            }
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        // --- FUNCIONES UI ---
        window.selectBeerType = (el) => { document.querySelectorAll('#beer-type-group .option-btn').forEach(d => d.classList.remove('selected')); el.classList.add('selected'); }
        window.selectBeerPrep = (el) => { document.querySelectorAll('#beer-prep-group .prep-radio').forEach(d => d.classList.remove('selected')); el.classList.add('selected'); checkChamoy(); }
        window.checkChamoy = () => {
            const sel = document.querySelector('#beer-prep-group .prep-radio.selected')?.dataset.val;
            const btn = document.getElementById('btn-sin-ajonjoli');
            if (btn) { if(sel === 'Escarchado Chamoy') btn.classList.remove('hidden'); else { btn.classList.add('hidden'); btn.classList.remove('selected'); } }
        }

        // --- SUBMIT ---
        window.submitBeerOrder = async (itemId) => {
            const item = MENU.find(i => i.id === itemId);
            const qty = parseInt(document.getElementById('modal-qty').innerText);
            let finalPrice = item.price;
            let mods = [];
            
            const typeEl = document.querySelector('#beer-type-group .option-btn.selected');
            if(typeEl) mods.push(typeEl.dataset.val);
            
            const prepEl = document.querySelector('#beer-prep-group .prep-radio.selected');
            if(prepEl) mods.push(prepEl.dataset.val);
            
            if(document.getElementById('btn-sin-limon').classList.contains('selected')) mods.push("Sin Lim√≥n");
            if(document.getElementById('btn-sin-ajonjoli') && document.getElementById('btn-sin-ajonjoli').classList.contains('selected')) mods.push("Sin Ajonjol√≠");
            if(document.getElementById('btn-clamato').classList.contains('selected')) { mods.push("Extra Clamato"); finalPrice += 5; }
            
            const note = document.getElementById('manual-note').value.trim();
            if(note) mods.push(note);
            await addOrderToDb(item, finalPrice, qty, mods);
        }

        window.submitGeneralOrder = async (itemId) => {
            const item = MENU.find(i => i.id === itemId);
            const qty = parseInt(document.getElementById('modal-qty').innerText);
            const mods = Array.from(document.querySelectorAll('.mod-btn.selected')).map(el => el.innerText);
            const note = document.getElementById('manual-note').value.trim();
            if(note) mods.push(note);
            await addOrderToDb(item, item.price, qty, mods);
        }

        async function addOrderToDb(item, price, qty, mods) {
            await addDoc(collection(db, 'orders'), {
                tableId: currentTableId, itemId: item.id, itemName: item.name, category: item.category,
                price: price, quantity: qty, modifiers: mods, status: 'ordered', timestamp: serverTimestamp()
            });
            closeModal();
            switchTab('orders');
        }

        // --- CREAR MESA (ID SECUENCIAL) ---
        window.openNewTableModal = () => { document.getElementById('modal-content').innerHTML = `<div class="p-6 bg-[#fffbeb]"><h3 class="font-black text-xl mb-4 text-amber-900">ABRIR NUEVA MESA</h3><input type="number" id="ntn" placeholder="N√∫mero de Mesa" class="w-full border-2 border-stone-300 p-3 rounded-lg mb-3 text-lg font-bold outline-none focus:border-amber-500"><input type="text" id="ntnm" placeholder="Apodo / Referencia" class="w-full border-2 border-stone-300 p-3 rounded-lg mb-6 outline-none focus:border-amber-500"><div class="flex gap-3"><button onclick="closeModal()" class="flex-1 bg-stone-200 py-3 rounded-lg font-bold text-stone-600 hover:bg-stone-300">CANCELAR</button><button onclick="subNT()" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-bold shadow-lg border-b-4 border-green-800 active:border-b-0 active:translate-y-1 transition">ABRIR</button></div></div>`; document.getElementById('modal-overlay').classList.remove('hidden'); }
        window.subNT = async () => {
            const num = document.getElementById('ntn').value;
            const nick = document.getElementById('ntnm').value || 'Cliente';
            if(!num) return;
            try {
                // Transacci√≥n para ID √∫nico
                await runTransaction(db, async (transaction) => {
                    const counterRef = doc(db, 'config', 'counters_tables');
                    const counterDoc = await transaction.get(counterRef);
                    let newId = 1000;
                    if (counterDoc.exists()) newId = counterDoc.data().current + 1;
                    transaction.set(counterRef, { current: newId });
                    
                    const newTableRef = doc(collection(db, 'tables'));
                    transaction.set(newTableRef, { number: num, nickname: nick, status: 'open', openedAt: serverTimestamp(), uniqueId: newId });
                });
                closeModal();
            } catch (e) { alert("Error al crear mesa."); console.error(e); }
        }

        // --- UTILIDADES ---
        window.adjQty = (d) => { const el=document.getElementById('modal-qty'); let v=parseInt(el.innerText)+d; if(v<1)v=1; el.innerText=v; }
        window.toggleMod = (b) => b.classList.toggle('selected');
        window.switchTab = (t) => {
            if(t==='menu'){ document.getElementById('tab-menu').classList.remove('hidden'); document.getElementById('tab-orders').classList.add('hidden'); document.getElementById('order-footer').classList.add('hidden'); 
                document.getElementById('tab-btn-menu').className="flex-1 py-3 text-blue-600 border-b-2 border-blue-600 bg-blue-50 font-bold"; document.getElementById('tab-btn-orders').className="flex-1 py-3 text-gray-500 font-bold"; }
            else { document.getElementById('tab-menu').classList.add('hidden'); document.getElementById('tab-orders').classList.remove('hidden'); document.getElementById('order-footer').classList.remove('hidden');
                document.getElementById('tab-btn-orders').className="flex-1 py-3 text-blue-600 border-b-2 border-blue-600 bg-blue-50 font-bold"; document.getElementById('tab-btn-menu').className="flex-1 py-3 text-gray-500 font-bold"; }
        }
        window.closeModal = () => document.getElementById('modal-overlay').classList.add('hidden');
        window.logoutToHome = () => renderHome();

        // --- KANBAN ---
        function renderBoard(cat) {
            document.getElementById('header-title').innerText = cat === 'kitchen' ? 'COCINA' : 'BARRA';
            const active = ordersData.filter(o => o.category === cat && ['ordered','preparing'].includes(o.status)).sort((a,b)=>(a.timestamp?.seconds||0)-(b.timestamp?.seconds||0));
            const ready = ordersData.filter(o => o.category === cat && o.status === 'ready');
            
            let html = `<div class="flex h-full p-2 gap-3 overflow-x-auto bg-stone-200">`;
            
            // COLUMNA PENDIENTES
            html += `<div class="flex-1 min-w-[300px] bg-white rounded-xl shadow-md p-3 flex flex-col border-t-8 border-red-500">
                <h3 class="font-black text-stone-700 mb-3 text-lg flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div> PENDIENTES (${active.filter(o=>o.status==='ordered').length})</h3>
                <div class="flex-1 overflow-y-auto space-y-3 p-1">
                    ${active.filter(o=>o.status==='ordered').map(o=>card(o,'ordered')).join('')}
                </div></div>`;
            
            // COLUMNA PREPARANDO
            if(cat==='kitchen') {
                html += `<div class="flex-1 min-w-[300px] bg-white rounded-xl shadow-md p-3 flex flex-col border-t-8 border-yellow-400">
                <h3 class="font-black text-stone-700 mb-3 text-lg flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-yellow-400"></div> COCINANDO (${active.filter(o=>o.status==='preparing').length})</h3>
                <div class="flex-1 overflow-y-auto space-y-3 p-1">
                    ${active.filter(o=>o.status==='preparing').map(o=>card(o,'preparing')).join('')}
                </div></div>`;
            }

            // COLUMNA LISTOS
            html += `<div class="flex-1 min-w-[300px] bg-white rounded-xl shadow-md p-3 flex flex-col border-t-8 border-green-600">
                <h3 class="font-black text-stone-700 mb-3 text-lg flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-green-600"></div> LISTOS (${ready.length})</h3>
                <div class="flex-1 overflow-y-auto space-y-3 p-1">
                    ${ready.map(o=>card(o,'ready')).join('')}
                </div></div>`;
                
            document.getElementById('content-area').innerHTML = html + `</div>`;
        }
        
        function card(o,s) {
            const t = tablesData.find(x=>x.id===o.tableId);
            const timeAgo = Math.floor((new Date()-new Date(o.timestamp?.seconds*1000))/60000);
            
            let btnClass = "bg-stone-500";
            let btnText = "Acci√≥n";
            
            if(s==='ordered') {
                if(o.category==='bar') { btnText="Terminar"; btnClass="bg-green-600 hover:bg-green-700"; }
                else { btnText="Cocinar"; btnClass="bg-yellow-600 hover:bg-yellow-700"; }
            } else if(s==='preparing') {
                btnText="Terminar"; btnClass="bg-green-600 hover:bg-green-700";
            } else {
                btnText="Entregar"; btnClass="bg-stone-400 hover:bg-stone-500";
            }
            
            // Funci√≥n click
            let nextSt = s==='ordered' ? (o.category==='bar'?'ready':'preparing') : (s==='preparing'?'ready':'delivered');
            
            return `<div class="bg-stone-50 p-4 rounded-lg shadow border border-stone-200">
                <div class="flex justify-between font-bold text-lg mb-2">
                    <span class="bg-stone-800 text-white px-2 py-0.5 rounded text-sm">MESA ${t?t.number:'?'}</span>
                    <span class="text-xs font-normal text-stone-500 bg-white border px-2 py-1 rounded flex items-center gap-1"><i class="fa-regular fa-clock"></i> ${timeAgo} min</span>
                </div>
                <div class="text-xl leading-tight text-stone-800 mb-2">
                    <span class="font-black bg-amber-200 px-2 rounded-md mr-1">${o.quantity}</span> ${o.itemName}
                </div>
                ${o.modifiers&&o.modifiers.length?`<div class="text-xs text-red-700 font-bold bg-red-50 p-2 rounded border border-red-100 mb-2 flex items-start gap-1"><i class="fa-solid fa-circle-exclamation mt-0.5"></i> <span>${o.modifiers.join(', ')}</span></div>`:''}
                <button onclick="upd('${o.id}','${nextSt}')" class="w-full ${btnClass} text-white py-3 mt-1 rounded-lg font-bold shadow-md active:translate-y-0.5 transition uppercase tracking-wide">${btnText}</button>
            </div>`;
        }
        window.upd = async(id,s) => await updateDoc(doc(db,'orders',id),{status:s});

        // --- CIERRE ---
        window.openCloseAccountModal = (tid, total) => {
            const t = tablesData.find(x => x.id === tid);
            document.getElementById('modal-content').innerHTML = `<div class="p-6 text-center bg-[#fffbeb]">
                <h3 class="font-black text-2xl text-amber-900 mb-1">MESA ${t.number}</h3>
                <p class="text-stone-500 font-mono text-sm mb-4">Ticket #${t.uniqueId || '---'}</p>
                
                <div class="bg-white p-4 rounded-xl shadow-inner border border-stone-200 mb-6">
                    <span class="block text-stone-400 text-xs uppercase font-bold tracking-widest">Total a Pagar</span>
                    <span class="block text-5xl font-black text-stone-800">$${total}</span>
                </div>
                
                <div class="flex flex-col gap-3">
                    <button onclick="markDebt('${tid}')" class="bg-blue-600 text-white py-3.5 rounded-lg font-bold shadow-md hover:bg-blue-700">Dejar en Deuda / Fiado</button>
                    <button onclick="printR('${tid}')" class="bg-stone-700 text-white py-3.5 rounded-lg font-bold shadow-md hover:bg-stone-800"><i class="fa-solid fa-print"></i> Imprimir Ticket</button>
                    <button onclick="closeFinal('${tid}')" class="bg-green-600 text-white py-3.5 rounded-lg font-bold shadow-lg border-b-4 border-green-800 active:border-b-0 active:translate-y-1 transition text-lg">COBRAR Y CERRAR</button>
                    <button onclick="closeModal()" class="text-stone-400 font-bold py-3 hover:text-stone-600 uppercase text-sm mt-2">Volver</button>
                </div></div>`;
            document.getElementById('modal-overlay').classList.remove('hidden');
        }
        window.markDebt = async(id)=>{ if(confirm("¬øMover a Deudas?")) { await updateDoc(doc(db,'tables',id),{status:'debt',debtDate:serverTimestamp()}); closeModal(); renderWaiterDashboard(); } }
        window.closeFinal = async(id)=>{ if(confirm("¬øCerrar Mesa?")) { await updateDoc(doc(db,'tables',id),{status:'closed', closedAt:serverTimestamp()}); closeModal(); renderWaiterDashboard(); } }
        
        // --- IMPRESI√ìN ---
        window.printR = (tid) => {
            const t = tablesData.find(x=>x.id===tid);
            const ords = ordersData.filter(x=>x.tableId===tid && x.status!=='cancelled');
            const total = ords.reduce((acc,c)=>acc+(c.price*c.quantity),0);
            const date = new Date().toLocaleString();
            
            // Agrupar items id√©nticos para el ticket
            const grouped = {};
            ords.forEach(o => {
                const key = o.itemName + (o.modifiers ? o.modifiers.join('') : '');
                if(!grouped[key]) grouped[key] = { ...o, qty: 0, total: 0 };
                grouped[key].qty += o.quantity;
                grouped[key].total += (o.price * o.quantity);
            });

            const itemsHtml = Object.values(grouped).map(o => `
                <div style="margin-bottom:6px; font-size:12px;">
                    <div style="display:flex; justify-content:space-between; font-weight:bold;">
                        <span>${o.qty} x ${o.itemName}</span>
                        <span>$${o.total}</span>
                    </div>
                    ${o.modifiers&&o.modifiers.length?`<div style="font-size:10px; font-style:italic; margin-left:10px;">- ${o.modifiers.join(', ')}</div>`:''}
                </div>`).join('');

            document.getElementById('receipt-area').innerHTML = `
                <div style="text-align:center; margin-bottom:15px; font-family: monospace;">
                    <img src="https://www.dropbox.com/scl/fi/htapbd4yf4m239y9zv2n1/Picture1.png?rlkey=o8je5uxe95avc9i9od6dmpbqh&raw=1" style="width: 60%; max-width: 150px; display: block; margin: 0 auto 10px auto;" onerror="this.style.display='none'">
                    <h2 style="font-weight:bold; font-size:18px; margin:0;">ALAS DE BARRIL</h2>
                    <p style="margin:0; font-size:10px;">--- COPIA CLIENTE ---</p>
                    <br>
                    <p style="margin:0; font-size:12px;">Ticket #${t.uniqueId||'---'}</p>
                    <p style="margin:0; font-size:12px;">${date}</p>
                </div>
                <div style="border-bottom:1px dashed #000; margin-bottom:10px;"></div>
                <div style="font-weight:bold; margin-bottom:10px; font-size:14px;">Mesa: ${t.number}</div>
                ${itemsHtml}
                <div style="border-top:1px dashed #000; margin-top:15px; padding-top:10px; display:flex; justify-content:space-between; font-weight:bold; font-size:16px;">
                    <span>TOTAL</span><span>$${total}</span>
                </div>
                <div style="text-align:center; margin-top:30px; font-size:10px;">
                    <p>¬°Gracias por su visita!</p>
                    <p>Wifi: AlasInvitado</p>
                </div>
            `;
            window.print();
        }

        initApp();
    </script>
</body>
</html>
