<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GastroApp Pro - A-LAS DE BARRIL</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Fuentes Retro de Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Old+Standard+TT:ital,wght@0,400;0,700;1,400&family=Special+Elite&display=swap" rel="stylesheet">

    <style>
        /* --- ESTILO RETRO GLOBAL --- */
        :root {
            --retro-cream: #f8f1e5;
            --retro-dark: #2c1e16;
            --retro-brown: #5c4033;
            --retro-red: #a63e3e;
            --retro-green: #557b55;
            --retro-yellow: #d4a353;
            --retro-blue: #4a6fa5;
            --retro-gold: #cba135;
            --retro-paper: #fffdf9;
            --retro-shadow: 4px 4px 0px var(--retro-brown);
            --retro-border: 3px double var(--retro-brown);
        }

        body { 
            font-family: 'Old Standard TT', serif; /* Fuente principal con serifa */
            background-color: var(--retro-cream);
            color: var(--retro-dark);
            user-select: none; 
            /* Textura de papel sutil */
            background-image: 
                linear-gradient(to right, rgba(92, 64, 51, 0.05) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(92, 64, 51, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        h1, h2, h3, h4, h5, h6, .font-bold {
            font-family: 'Abril Fatface', cursive; /* Fuente para t√≠tulos */
            letter-spacing: 0.05em;
        }

        .font-mono {
            font-family: 'Special Elite', cursive !important; /* Fuente estilo m√°quina de escribir */
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @media print {
            body * { visibility: hidden; }
            #receipt-area, #receipt-area * { visibility: visible; }
            #receipt-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; color: black; }
            @page { margin: 0; size: auto; }
        }
        
        /* --- ESTILOS PERSONALIZADOS RETRO --- */
        .option-btn { 
            @apply border-2 rounded-sm p-2 text-center cursor-pointer transition-all font-bold text-[#5c4033] bg-[#fffdf9] border-[#a89f91] text-sm; 
            box-shadow: 2px 2px 0 #a89f91;
        }
        .option-btn:active { box-shadow: 1px 1px 0 #a89f91; transform: translate(1px, 1px); }
        .option-btn.clara.selected { background-color: var(--retro-yellow); border-color: var(--retro-brown); color: var(--retro-dark); box-shadow: 2px 2px 0 var(--retro-brown); }
        .option-btn.oscura.selected { background-color: var(--retro-brown); border-color: var(--retro-dark); color: var(--retro-cream); box-shadow: 2px 2px 0 var(--retro-dark); }
        
        .prep-radio { 
            @apply border-2 rounded-sm p-2 text-center cursor-pointer transition-all font-medium text-[#5c4033] bg-[#fffdf9] border-[#a89f91] text-xs;
            box-shadow: 2px 2px 0 #a89f91;
        }
        .prep-radio:active { box-shadow: 1px 1px 0 #a89f91; transform: translate(1px, 1px); }
        .prep-radio.selected { background-color: var(--retro-blue); border-color: var(--retro-brown); color: var(--retro-cream); font-weight: 800; box-shadow: 2px 2px 0 var(--retro-brown); }

        .mod-btn { transition: all 0.1s; border-width: 2px; font-weight: 600; box-shadow: 2px 2px 0 var(--retro-brown); border-style: solid; }
        .mod-btn:active { box-shadow: 1px 1px 0 var(--retro-brown); transform: translate(1px, 1px); }
        .mod-btn.btn-red { color: var(--retro-red); background-color: #fce8e8; border-color: var(--retro-red); }
        .mod-btn.btn-red.selected { background-color: var(--retro-red); color: var(--retro-cream); border-color: var(--retro-brown); }
        .mod-btn.btn-green { color: var(--retro-green); background-color: #e8fce8; border-color: var(--retro-green); }
        .mod-btn.btn-green.selected { background-color: var(--retro-green); color: var(--retro-cream); border-color: var(--retro-brown); }
        .mod-btn.btn-neutral { color: var(--retro-brown); background-color: var(--retro-paper); border-color: var(--retro-brown); }
        .mod-btn.btn-neutral.selected { background-color: var(--retro-brown); color: var(--retro-cream); border-color: var(--retro-dark); }
        
        .cat-header { 
            font-size: 1rem; 
            font-family: 'Abril Fatface', cursive; 
            text-transform: uppercase; 
            color: var(--retro-brown); 
            margin-top: 1.5rem; 
            margin-bottom: 0.8rem; 
            letter-spacing: 0.1em; 
            border-bottom: 3px double var(--retro-brown); 
            padding-bottom: 4px; 
            text-align: center;
        }
        
        .wood-shadow { box-shadow: var(--retro-shadow); }

        /* Estilo para secciones de paquete */
        .pkg-section { @apply mb-4 border-2 border-[#a89f91] rounded-sm p-3 bg-[#fffdf9]; box-shadow: 2px 2px 0 #a89f91; }
        .pkg-title { @apply font-bold text-[#5c4033] mb-2 border-b-2 border-[#a89f91] pb-1 text-sm uppercase; font-family: 'Abril Fatface', cursive; }

        /* Estilos para Inputs y Botones Retro */
        input[type="number"], input[type="text"], select {
            @apply border-2 border-[#a89f91] p-3 rounded-sm text-lg font-bold outline-none bg-[#fffdf9] text-[#5c4033];
            box-shadow: inset 2px 2px 4px rgba(92, 64, 51, 0.1);
            font-family: 'Special Elite', cursive;
        }
        input:focus, select:focus { @apply border-[#5c4033]; }

        .btn-retro {
            @apply py-3 rounded-sm font-bold text-white shadow-md uppercase tracking-wide border-2 border-[#2c1e16] transition-all;
            box-shadow: 3px 3px 0 #2c1e16;
            font-family: 'Abril Fatface', cursive;
        }
        .btn-retro:active { box-shadow: 1px 1px 0 #2c1e16; transform: translate(2px, 2px); }
        .btn-retro-green { background-color: var(--retro-green); }
        .btn-retro-blue { background-color: var(--retro-blue); }
        .btn-retro-red { background-color: var(--retro-red); }
        .btn-retro-yellow { background-color: var(--retro-yellow); color: var(--retro-dark); }
        .btn-retro-dark { background-color: var(--retro-brown); color: var(--retro-cream); }
        .btn-retro-neutral { background-color: #dcdcdc; color: var(--retro-dark); border-color: #999; box-shadow: 3px 3px 0 #999; }
        .btn-retro-neutral:active { box-shadow: 1px 1px 0 #999; }

        .card-retro {
            @apply rounded-sm shadow-sm p-3 border-2 border-[#5c4033] relative cursor-pointer transition bg-[#fffdf9];
            box-shadow: 4px 4px 0 rgba(92, 64, 51, 0.3);
        }
        .card-retro:active { box-shadow: 2px 2px 0 rgba(92, 64, 51, 0.3); transform: translate(2px, 2px); }
        .card-retro-vip { background-color: #fff0e6; border-color: var(--retro-gold); } /* Fondo crema rojizo para VIP */

        .badge-retro {
            @apply text-[10px] font-bold px-2 py-0.5 rounded-sm border-2;
            font-family: 'Special Elite', cursive;
            box-shadow: 1px 1px 0 rgba(0,0,0,0.2);
        }
        
        .modal-retro {
            @apply bg-[#fffdf9] rounded-sm shadow-2xl w-full max-w-md overflow-hidden max-h-[90vh] flex flex-col border-4 border-double border-[#5c4033];
            box-shadow: 8px 8px 0 rgba(44, 30, 22, 0.4);
        }

    </style>
</head>
<body>

    <div id="app" class="h-screen w-full flex flex-col overflow-hidden relative font-serif">
        <!-- Header R√∫stico Retro -->
        <header id="main-header" class="bg-[#2c1e16] text-[#f8f1e5] p-3 shadow-md flex justify-between items-center z-10 shrink-0 relative border-b-[6px] border-double border-[#5c4033]" style="box-shadow: 0 4px 0 rgba(92, 64, 51, 0.5);">
            <div class="flex items-center gap-3">
                <!-- LOGO EN HEADER CON ESTILO DE SELLO -->
                <div class="bg-[#f8f1e5] p-1 rounded-full border-4 border-double border-[#cba135] overflow-hidden w-14 h-14 flex items-center justify-center shadow-sm" style="box-shadow: 2px 2px 0 #cba135;">
                    <img src="https://www.dropbox.com/scl/fi/htapbd4yf4m239y9zv2n1/Picture1.png?rlkey=o8je5uxe95avc9i9od6dmpbqh&raw=1" alt="Logo" class="w-full h-full object-contain sepia" onerror="this.src='https://placehold.co/100x100?text=AB'">
                </div>
                <h1 class="font-bold text-2xl tracking-widest" id="header-title" style="font-family: 'Abril Fatface', cursive; text-shadow: 2px 2px 0 #000;">A-LAS DE BARRIL</h1>
            </div>
            
            <div id="status-indicator" class="hidden absolute left-1/2 transform -translate-x-1/2 px-4 py-1 rounded-sm border-2 border-double text-xs font-bold shadow-[2px_2px_0_#000] flex items-center gap-2 top-14 md:top-auto font-mono">
                <span id="status-text"></span>
            </div>

            <button onclick="logoutToHome()" class="text-xs bg-[#5c4033] border-2 border-[#f8f1e5] px-3 py-1.5 rounded-sm hover:bg-[#4a3328] transition uppercase font-bold tracking-wider text-[#f8f1e5]" style="box-shadow: 2px 2px 0 #f8f1e5; font-family: 'Abril Fatface', cursive;">
                <i class="fa-solid fa-right-from-bracket"></i> Salir
            </button>
        </header>

        <!-- Contenido (Fondo Crema Texturizado) -->
        <main id="content-area" class="flex-1 overflow-y-auto bg-[#f8f1e5] relative flex flex-col p-2" style="background-image: url('data:image/svg+xml,%3Csvg width=\'40\' height=\'40\' viewBox=\'0 0 40 40\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'%235c4033\' fill-opacity=\'0.05\' fill-rule=\'evenodd\'%3E%3Cpath d=\'M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41zM20 18.6l2.83-2.83 1.41 1.41L21.41 20l2.83 2.83-1.41 1.41L20 21.41l-2.83 2.83-1.41-1.41L18.59 20l-2.83-2.83 1.41-1.41L20 18.59z\'/%3E%3C/g%3E%3C/svg%3E');">
            <div class="flex flex-col justify-center items-center h-full text-[#5c4033] opacity-50 gap-4 font-mono">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl"></i>
                <p class="text-sm font-bold animate-pulse">Cargando sistema...</p>
            </div>
        </main>

        <!-- √Årea Ticket (Oculto para impresi√≥n nativa) -->
        <div id="receipt-area" class="hidden bg-[#fffdf9] p-4 text-xs w-[300px] mx-auto font-mono border-4 double border-[#5c4033] text-[#2c1e16]"></div>
    </div>

    <!-- Modales Retro -->
    <div id="modal-overlay" class="fixed inset-0 bg-[#2c1e16] bg-opacity-80 hidden z-50 flex justify-center items-center p-4 backdrop-blur-sm">
        <div id="modal-content" class="modal-retro"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, query, orderBy, serverTimestamp, enableIndexedDbPersistence, runTransaction } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBqrR3FQ7L7KCE5Wg8thRvyA6GpiUV2DPs",
            authDomain: "alasdebarrilwings.firebaseapp.com",
            projectId: "alasdebarrilwings",
            storageBucket: "alasdebarrilwings.firebasestorage.app",
            messagingSenderId: "826542576836",
            appId: "1:826542576836:web:dd1bc6f8bc4fd73d57a591"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app);
            enableIndexedDbPersistence(db).catch(err => console.warn("Offline persistence:", err.code));
        } catch (e) { showError("Error de Configuraci√≥n", e.message); }

        function updateStatusDisplay() {
            const ind = document.getElementById('status-indicator');
            const txt = document.getElementById('status-text');
            if (!navigator.onLine) {
                ind.className = "absolute left-1/2 transform -translate-x-1/2 bg-[#a63e3e] px-4 py-1 rounded-sm border-2 border-double border-[#2c1e16] text-xs font-bold shadow-[2px_2px_0_#2c1e16] animate-pulse flex items-center gap-2 text-[#f8f1e5] top-14 md:top-auto font-mono";
                ind.classList.remove('hidden'); txt.innerHTML = '<i class="fa-solid fa-wifi"></i> MODO OFFLINE';
            } else { ind.classList.add('hidden'); }
        }
        window.addEventListener('online', updateStatusDisplay);
        window.addEventListener('offline', updateStatusDisplay);
        updateStatusDisplay();

        function showError(title, details) { document.getElementById('content-area').innerHTML = `<div class="flex flex-col justify-center items-center h-full p-6 text-center"><h2 class="font-bold text-2xl text-[#a63e3e]" style="font-family: 'Abril Fatface', cursive;">${title}</h2><p class="text-[#5c4033] font-mono mt-2">${details}</p><button onclick="location.reload()" class="mt-6 btn-retro btn-retro-dark px-6 py-2">Reintentar</button></div>`; }

        let currentUser = null, ordersData = [], tablesData = [];
        let currentRole = null, currentTableId = null, showingDebts = false;

        const MODIFIERS = {
            burgers: ["Sin cebolla", "Sin jitomate", "Sin pi√±a", "Sin picante", "Sin catsup", "Sin mayonesa", "Sin queso", "Sin jam√≥n", "Sin carne"],
            hotdogs: ["Sin jitomate", "Sin cebolla", "Sin pi√±a", "Sin picante", "Sin catsup", "Sin mayonesa", "Sin salchicha", "Sin tocino"],
            salsas: ["Bbq", "Mango", "Habanero", "Tamarindo", "Jamaica", "Frutos rojos", "Pi√±a", "Chipotle", "B√∫falo", "Lemon pepper", "A la diabla"],
            snacks: ["Sin queso", "Sin crema", "Sin catsup", "Sin salsa", "Sin vegetales"],
            sodas: ["Coca", "Boing Mango", "Boing Guayaba", "Manzanita", "Jarrito", "Squirt"],
            coolers: ["Durazno", "Fresa", "Vino", "Manzana Kiwi"],
            general_kitchen: ["Para llevar", "Sin cubiertos"],
            general_bar: ["Poca az√∫car", "Sin popote"],
            package_options: ["Con Papas", "Con Aros de Cebolla", "Con Alitas", "Con Boneless", "Salsa BBQ", "Salsa Buffalo", "Salsa Mango", "Salsa Habanero"]
        };

        const MENU = [
            { id: 'b_md', name: 'Barril 1/2 Lt', price: 35, category: 'bar', isBeer: true, type: 'regular', icon: 'fa-beer-mug-empty' },
            { id: 'b_1l', name: 'Barril 1 Lt', price: 70, category: 'bar', isBeer: true, type: 'regular', icon: 'fa-beer-mug-empty' },
            { id: 'b_md_negra', name: 'Barril Negra 1/2 Lt', price: 45, category: 'bar', isBeer: true, type: 'dark', icon: 'fa-beer-mug-empty' },
            { id: 'b_1l_negra', name: 'Barril Negra 1 Lt', price: 90, category: 'bar', isBeer: true, type: 'dark', icon: 'fa-beer-mug-empty' },
            { id: 'b_emb', name: 'Cerveza Embotellada', price: 30, category: 'bar', isBeer: true, type: 'bottled', icon: 'fa-bottle-droplet' },
            { id: 'b_cig', name: 'Cigarro', price: 7, category: 'bar', modGroup: 'general_bar', icon: 'fa-smoking' },
            { id: 'b_ref', name: 'Refresco', price: 25, category: 'bar', modGroup: 'sodas', icon: 'fa-bottle-water' },
            { id: 'b_coo', name: 'Caribe Cooler', price: 30, category: 'bar', modGroup: 'coolers', icon: 'fa-wine-bottle' },
            { id: 'h1', name: 'Hamburguesa Sencilla', price: 55, category: 'kitchen', modGroup: 'burgers', icon: 'fa-burger' },
            { id: 'h2', name: 'Hamburguesa Especial', price: 70, category: 'kitchen', modGroup: 'burgers', icon: 'fa-burger' },
            { id: 'h3', name: 'Hamburguesa Arrachera', price: 90, category: 'kitchen', modGroup: 'burgers', icon: 'fa-burger' },
            { id: 'h4', name: 'Hamburguesa Camar√≥n', price: 80, category: 'kitchen', modGroup: 'burgers', icon: 'fa-shrimp' },
            { id: 'h5', name: 'Hamburguesa Pollo', price: 65, category: 'kitchen', modGroup: 'burgers', icon: 'fa-drumstick-bite' },
            { id: 'c1', name: 'Tenders de Pollo', price: 75, category: 'kitchen', modGroup: 'salsas', icon: 'fa-drumstick-bite' },
            { id: 'c2', name: 'Boneless', price: 70, category: 'kitchen', modGroup: 'salsas', icon: 'fa-drumstick-bite' },
            { id: 'c3', name: 'Alitas', price: 50, category: 'kitchen', modGroup: 'salsas', icon: 'fa-dove' },
            { id: 's1', name: 'Papas a la francesa', price: 40, category: 'kitchen', modGroup: 'snacks', icon: 'fa-utensils' },
            { id: 's2', name: 'Salchipapas', price: 50, category: 'kitchen', modGroup: 'snacks', icon: 'fa-bacon' },
            { id: 's3', name: 'Aros de Cebolla', price: 45, category: 'kitchen', modGroup: 'snacks', icon: 'fa-ring' },
            { id: 'hd1', name: 'Hot Dog Sencillo', price: 25, category: 'kitchen', modGroup: 'hotdogs', icon: 'fa-hotdog' },
            { id: 'hd2', name: 'Hot Dog Especial', price: 40, category: 'kitchen', modGroup: 'hotdogs', icon: 'fa-hotdog' },
            { id: 'p1', name: 'Paquete 1', price: 235, category: 'kitchen', isPackage: true, icon: 'fa-box-open' },
            { id: 'p2', name: 'Paquete 2', price: 255, category: 'kitchen', isPackage: true, icon: 'fa-box-open' },
            { id: 'p3', name: 'Paquete 3', price: 310, category: 'kitchen', isPackage: true, icon: 'fa-box-open' },
        ];

        async function initApp() { try { await signInAnonymously(auth); } catch (e) { console.error(e); showError("Auth Error", e.message); } }
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                onSnapshot(collection(db, 'tables'), s => { tablesData = s.docs.map(d=>({id:d.id, ...d.data()})); refreshCurrentView(); });
                onSnapshot(collection(db, 'orders'), s => { ordersData = s.docs.map(d=>({id:d.id, ...d.data()})); refreshCurrentView(); });
                renderHome();
            }
        });

        function refreshCurrentView() {
            if(!currentRole) return;
            if(currentRole === 'waiter') currentTableId ? renderTableDetail(currentTableId) : renderWaiterDashboard();
            else if(currentRole === 'kitchen') renderBoard('kitchen');
            else if(currentRole === 'bar') renderBoard('bar');
        }

        window.renderHome = () => {
            currentRole = null;
            document.getElementById('header-title').innerText = 'A-LAS DE BARRIL';
            document.getElementById('content-area').innerHTML = `
                <div class="p-6 flex flex-col gap-6 h-full justify-center items-center max-w-md mx-auto">
                    <div class="p-2 bg-[#fffdf9] border-4 border-double border-[#cba135] rounded-full shadow-[4px_4px_0_#5c4033]">
                        <img src="https://www.dropbox.com/scl/fi/jymn0kvgyx9ioqjojwbfw/Picture2.png?rlkey=u4k3ppl3f7vohb07au7bt8tw4&raw=1" class="w-48 rounded-full sepia" alt="Logo" onerror="this.src='https://placehold.co/200x200?text=LOGO'">
                    </div>
                    <h2 class="text-3xl font-bold text-[#5c4033] mb-4 pb-2 border-b-[3px] double border-[#cba135] uppercase tracking-widest" style="font-family: 'Abril Fatface', cursive; text-shadow: 1px 1px 0 #f8f1e5;">Selecciona Perfil</h2>
                    <button onclick="setRole('waiter')" class="w-full btn-retro btn-retro-yellow p-6 text-2xl flex gap-4 items-center"><div class="bg-[#5c4033] p-3 rounded-full text-[#f8f1e5] border-2 border-[#f8f1e5]"><i class="fa-solid fa-mobile-screen"></i></div><span>Mesero</span></button>
                    <button onclick="setRole('bar')" class="w-full btn-retro btn-retro-dark p-6 text-2xl flex gap-4 items-center"><div class="bg-[#cba135] p-3 rounded-full text-[#2c1e16] border-2 border-[#2c1e16]"><i class="fa-solid fa-beer-mug-empty"></i></div><span>Barra</span></button>
                    <button onclick="setRole('kitchen')" class="w-full btn-retro btn-retro-red p-6 text-2xl flex gap-4 items-center"><div class="bg-[#2c1e16] p-3 rounded-full text-[#f8f1e5] border-2 border-[#f8f1e5]"><i class="fa-solid fa-fire-burner"></i></div><span>Cocina</span></button>
                </div>`;
        }
        window.setRole = (r) => { currentRole = r; refreshCurrentView(); }

        window.renderWaiterDashboard = () => {
            currentTableId = null;
            document.getElementById('header-title').innerText = 'Control de Mesas';
            const now = Date.now();
            const eightDaysMs = 8 * 24 * 60 * 60 * 1000;
            const openTables = tablesData.filter(t => t.status === 'open').sort((a,b) => (b.openedAt?.seconds||0) - (a.openedAt?.seconds||0));
            const debtTables = tablesData.filter(t => t.status === 'debt').sort((a,b) => (b.debtDate?.seconds||0) - (a.debtDate?.seconds||0));
            const closedTables = tablesData.filter(t => {
                if (t.status !== 'closed') return false;
                const closedDate = t.closedAt?.seconds * 1000 || 0;
                return (now - closedDate) < eightDaysMs;
            }).sort((a,b) => (b.closedAt?.seconds||0) - (a.closedAt?.seconds||0));
            
            const btnClass = showingDebts ? 'btn-retro-red' : 'btn-retro-dark';
            const sectionTitle = showingDebts ? 'Deudas Pendientes' : 'Mesas Abiertas';

            let html = `
                <div class="p-4 flex flex-col gap-6 pb-24">
                    <div class="flex gap-2 bg-[#fffdf9] p-2 rounded-sm shadow-[2px_2px_0_#5c4033] border-2 border-[#5c4033]">
                        <input type="number" id="search-ticket-id" placeholder="Buscar Ticket #" class="flex-1 border-0 p-2 bg-transparent outline-none text-[#5c4033] placeholder-[#a89f91] font-mono font-bold" style="box-shadow: none;">
                        <button onclick="searchTicket()" class="bg-[#5c4033] text-[#f8f1e5] px-4 rounded-sm hover:bg-[#4a3328] border-2 border-[#2c1e16]" style="font-family: 'Abril Fatface', cursive;"><i class="fa-solid fa-search"></i></button>
                    </div>
                    <div class="flex gap-3"><button onclick="toggleDebtView()" class="flex-1 btn-retro ${btnClass} py-3 text-sm">${showingDebts ? '‚¨Ö Ver Mesas Activas' : 'üìÇ Ver Deudas / Fiado'}</button></div>
                    <div>
                        <div class="flex justify-between items-end mb-3 border-b-[3px] double border-[#5c4033] pb-1">
                            <h3 class="font-black text-[#5c4033] text-xl uppercase tracking-wider" style="font-family: 'Abril Fatface', cursive;">${sectionTitle}</h3>
                            ${!showingDebts ? `<button onclick="openNewTableModal()" class="btn-retro btn-retro-green text-xs px-3 py-2 flex items-center gap-1"><i class="fa-solid fa-plus"></i> NUEVA</button>` : ''}
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            ${!showingDebts && openTables.length === 0 ? '<p class="col-span-2 text-[#a89f91] text-sm text-center italic py-4 bg-[#fffdf9] rounded-sm border-2 border-dashed border-[#a89f91] font-mono">No hay mesas abiertas</p>' : ''}
                            ${showingDebts && debtTables.length === 0 ? '<p class="col-span-2 text-[#a89f91] text-sm text-center italic py-4 bg-[#fffdf9] rounded-sm border-2 border-dashed border-[#a89f91] font-mono">No hay deudas</p>' : ''}
                            ${!showingDebts ? openTables.map(t => createTableCard(t)).join('') : debtTables.map(t => createTableCard(t)).join('')}
                        </div>
                    </div>
                    ${!showingDebts ? `<div class="mt-6 opacity-80"><h3 class="font-bold text-[#5c4033] text-lg uppercase mb-3 border-b-[3px] double border-[#5c4033] pb-1" style="font-family: 'Abril Fatface', cursive;">Cerradas (8 d√≠as)</h3><div class="grid grid-cols-2 gap-4">${closedTables.length ? closedTables.map(t => createTableCard(t)).join('') : '<p class="col-span-2 text-[#a89f91] text-xs text-center font-mono">Historial vac√≠o</p>'}</div></div>` : ''}
                </div>`;
            document.getElementById('content-area').innerHTML = html;
        }

        function createTableCard(t) {
            const ords = ordersData.filter(o => o.tableId === t.id && o.status !== 'cancelled');
            const total = ords.reduce((a,c) => a + (c.price * c.quantity), 0);
            const deposit = t.deposit || 0;
            const remaining = total - deposit;

            let cardBgClass = '', borderColor = 'border-[#5c4033]', badge = '', statusIconColor = 'text-[#5c4033]';
            
            // ESTILOS RETRO PARA ESTADOS
            if (t.isVip) {
                cardBgClass = 'card-retro-vip'; // Fondo crema rojizo
                borderColor = 'border-[#cba135]'; // Borde dorado
            }

            if (t.status === 'open') {
                const pending = ords.some(o => o.status !== 'delivered');
                borderColor = pending ? 'border-[#d4a353]' : 'border-[#557b55]'; // Amarillo / Verde retro
                statusIconColor = pending ? 'text-[#d4a353]' : 'text-[#557b55]';
                badge = pending ? `<i class="fa-solid fa-clock animate-pulse ${statusIconColor}"></i>` : `<i class="fa-solid fa-check ${statusIconColor}"></i>`;
            } else if (t.status === 'debt') { 
                borderColor = 'border-[#a63e3e]'; cardBgClass = 'bg-[#fce8e8]'; // Rojo retro
                statusIconColor = 'text-[#a63e3e]';
                badge = `<i class="fa-solid fa-file-invoice-dollar ${statusIconColor}"></i>`;
            } else { 
                cardBgClass = 'bg-[#e0d8c8]'; // Gris√°ceo retro
                statusIconColor = 'text-[#a89f91]';
                badge = `<i class="fa-solid fa-lock ${statusIconColor}"></i>`; 
            }
            
            // VIP BADGE RETRO
            let vipBadge = t.isVip ? `<span class="absolute -top-3 -left-3 bg-[#cba135] text-[#2c1e16] text-[10px] px-3 py-1 rounded-sm font-bold shadow-[2px_2px_0_#2c1e16] border-2 border-[#2c1e16]" style="font-family: 'Abril Fatface', cursive;"><i class="fa-solid fa-crown"></i> VIP</span>` : '';
            
            let priceDisplay = `$${total}`; if (deposit > 0) priceDisplay = `<span class="text-xs text-[#a63e3e] line-through mr-1 font-mono">$${total}</span> $${remaining}`;
            
            const dateStr = t.openedAt ? new Date(t.openedAt.seconds * 1000).toLocaleString('es-MX', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }).replace(',', '') : '';

            return `<div onclick="renderTableDetail('${t.id}')" class="card-retro ${cardBgClass} ${borderColor}">
                    ${vipBadge}
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[11px] font-mono font-bold text-[#5c4033] bg-[#e0d8c8] px-2 py-0.5 rounded-sm border-2 border-[#a89f91] shadow-[1px_1px_0_#a89f91]">#${t.uniqueId || '---'}</span>
                        <div class="flex flex-col items-end">
                             <span class="text-[10px] text-[#5c4033] font-mono mb-0.5 font-bold">${dateStr}</span>
                             <div class="bg-[#fffdf9] border-2 border-[#a89f91] rounded-full p-1 shadow-[1px_1px_0_#a89f91]">${badge}</div>
                        </div>
                    </div>
                    <div class="text-3xl font-black text-[#2c1e16] leading-none mb-1 text-center" style="font-family: 'Abril Fatface', cursive; text-shadow: 1px 1px 0 #cba135;">${t.number}</div>
                    <div class="text-xs text-[#5c4033] truncate font-semibold mb-3 uppercase tracking-wider text-center font-mono border-b-2 border-dashed border-[#a89f91] pb-1">${t.nickname}</div>
                    <div class="text-xl font-bold text-[#2c1e16] text-right pt-1" style="font-family: 'Special Elite', cursive;">${priceDisplay}</div>
                </div>`;
        }

        window.toggleDebtView = () => { showingDebts = !showingDebts; renderWaiterDashboard(); }
        window.searchTicket = async () => { const id=parseInt(document.getElementById('search-ticket-id').value); if(!id)return; const found=tablesData.find(t=>t.uniqueId===id); if(found)renderTableDetail(found.id); else alert("No encontrado"); }

        window.renderTableDetail = (tid) => {
            currentTableId = tid;
            const t = tablesData.find(x => x.id === tid);
            if(!t) return renderWaiterDashboard();
            const uniqueDisplay = t.uniqueId ? `#${t.uniqueId}` : '';
            const ords = ordersData.filter(o => o.tableId === tid && o.status !== 'cancelled').sort((a,b) => b.timestamp?.seconds - a.timestamp?.seconds);
            const total = ords.reduce((a,c) => a + (c.price * c.quantity), 0);
            const deposit = t.deposit || 0;
            const remaining = total - deposit;

            const isClosed = t.status === 'closed';
            let closeBtnText = t.status === 'debt' ? "Liquidar Deuda" : "Cerrar Cuenta";
            let closeBtnColorClass = t.status === 'debt' ? "btn-retro-blue" : "btn-retro-green";
            
            let totalDisplay = `<div class="flex justify-between mb-3 font-black text-2xl text-[#2c1e16] px-2" style="font-family: 'Special Elite', cursive;"><span style="font-family: 'Abril Fatface', cursive;">Total</span><span>$${total}</span></div>`;
            
            if (deposit > 0) {
                 totalDisplay = `<div class="flex justify-between text-sm text-[#5c4033] font-mono"><span>Subtotal</span><span>$${total}</span></div>
                                 <div class="flex justify-between text-sm text-[#a63e3e] font-mono"><span>A cuenta</span><span>-$${deposit}</span></div>
                                 <div class="flex justify-between font-black text-2xl text-[#2c1e16] border-t-4 double border-[#5c4033] pt-2 mt-2" style="font-family: 'Special Elite', cursive;"><span style="font-family: 'Abril Fatface', cursive;">Restante</span><span>$${remaining}</span></div>`;
            }
            
            let footerHtml = '';
            
            if (isClosed) {
                 footerHtml = `
                <div id="order-footer" class="fixed bottom-0 w-full bg-[#e0d8c8] p-4 shadow-[0_-4px_0_rgba(92,64,51,0.8)] z-30 border-t-[3px] double border-[#5c4033]">
                     <div class="flex justify-between mb-3 font-bold text-2xl text-[#2c1e16] px-2" style="font-family: 'Special Elite', cursive;"><span style="font-family: 'Abril Fatface', cursive;">Total Final</span><span>$${total}</span></div>
                     <div class="flex gap-3">
                        <button onclick="printR('${tid}')" class="flex-1 btn-retro btn-retro-dark py-3"><i class="fa-solid fa-print"></i> Ticket</button>
                        <button onclick="downloadPDF('${tid}')" class="flex-1 btn-retro btn-retro-red py-3"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                     </div>
                     <div class="text-center text-xs text-[#a63e3e] mt-3 font-bold uppercase tracking-[0.2em] font-mono border-t-2 border-dashed border-[#a63e3e] pt-2">MESA CERRADA - ARCHIVO</div>
                </div>`;
            } else {
                footerHtml = `<div id="order-footer" class="fixed bottom-0 w-full bg-[#fffdf9] p-4 shadow-[0_-4px_0_rgba(92,64,51,0.3)] z-30 border-t-[3px] double border-[#cba135]">${totalDisplay}<button onclick="openCloseAccountModal('${tid}', ${total})" class="w-full btn-retro ${closeBtnColorClass} py-4 text-lg mt-2">${closeBtnText}</button></div>`;
            }
            
            const pageBgClass = t.isVip ? 'bg-[#fff0e6]' : 'bg-[#fffdf9]';
            const vipHeader = t.isVip ? `<span class="ml-3 bg-[#cba135] text-[#2c1e16] text-[11px] px-3 py-1 rounded-sm font-bold shadow-[2px_2px_0_#2c1e16] border-2 border-[#2c1e16]" style="font-family: 'Abril Fatface', cursive;"><i class="fa-solid fa-crown"></i> VIP</span>` : '';

            let html = `<div class="flex flex-col h-full ${pageBgClass}">
                <div class="bg-[#2c1e16] text-[#f8f1e5] p-3 flex items-center justify-between shadow-[0_4px_0_rgba(92,64,51,0.5)] shrink-0 border-b-[4px] double border-[#cba135]">
                    <button onclick="renderWaiterDashboard()" class="text-[#f8f1e5] font-bold text-sm flex items-center gap-2 hover:text-[#cba135] transition" style="font-family: 'Abril Fatface', cursive;"><i class="fa-solid fa-chevron-left"></i> Volver</button>
                    <div class="text-center"><div class="font-black text-xl leading-none flex items-center justify-center tracking-wider" style="font-family: 'Abril Fatface', cursive; text-shadow: 1px 1px 0 #cba135;">MESA ${t.number} ${vipHeader}</div><div class="text-[11px] font-mono text-[#cba135] opacity-90 mt-1 font-bold">Ticket ${uniqueDisplay}</div></div><div class="w-14"></div>
                </div>
                <div class="bg-[#fffdf9] shadow-[0_2px_0_#a89f91] flex border-b-2 border-[#a89f91] shrink-0">
                    <button onclick="switchTab('menu')" id="tab-btn-menu" class="flex-1 py-3 text-[#2c1e16] border-b-4 border-[#cba135] bg-[#fff0e6] font-bold tracking-wide" style="font-family: 'Abril Fatface', cursive;">MEN√ö</button>
                    <button onclick="switchTab('orders')" id="tab-btn-orders" class="flex-1 py-3 text-[#a89f91] font-bold hover:bg-[#fff0e6] transition tracking-wide" style="font-family: 'Abril Fatface', cursive;">CUENTA</button>
                </div>
                <div id="tab-menu" class="flex-1 overflow-y-auto p-4 pb-32 ${isClosed ? 'hidden' : ''} bg-[#f8f1e5]" style="background-image: url('data:image/svg+xml,%3Csvg width=\'40\' height=\'40\' viewBox=\'0 0 40 40\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'%235c4033\' fill-opacity=\'0.05\' fill-rule=\'evenodd\'%3E%3Cpath d=\'M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41zM20 18.6l2.83-2.83 1.41 1.41L21.41 20l2.83 2.83-1.41 1.41L20 21.41l-2.83 2.83-1.41-1.41L18.59 20l-2.83-2.83 1.41-1.41L20 18.59z\'/%3E%3C/g%3E%3C/svg%3E');">
                    <h3 class="cat-header">Cocina</h3><div class="grid gap-3 mb-8">${renderMenuSection('kitchen')}</div>
                    <h3 class="cat-header">Barra</h3><div class="grid gap-3">${renderMenuSection('bar')}</div>
                </div>
                <div id="tab-orders" class="${isClosed ? '' : 'hidden'} flex-1 overflow-y-auto p-4 pb-52 ${t.isVip ? 'bg-[#fff0e6]' : 'bg-[#fffdf9]'}" style="background-image: url('data:image/svg+xml,%3Csvg width=\'20\' height=\'20\' viewBox=\'0 0 20 20\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'%23a89f91\' fill-opacity=\'0.1\' fill-rule=\'evenodd\'%3E%3Ccircle cx=\'3\' cy=\'3\' r=\'3\'/%3E%3Ccircle cx=\'13\' cy=\'13\' r=\'3\'/%3E%3C/g%3E%3C/svg%3E');">
                    ${ords.length === 0 ? '<div class="text-center py-10 text-[#a89f91] italic font-mono border-2 border-dashed border-[#a89f91] p-4 rounded-sm m-4 bg-[#fffdf9]">Mesa vac√≠a - Sin pedidos</div>' : ''}
                    ${ords.map(o => {
                        let stClass = "bg-[#e0d8c8] text-[#5c4033] border-[#a89f91]", stIcon = "fa-clock";
                        if(o.status === 'preparing') { stClass = "bg-[#fff9c4] text-[#d4a353] border-[#d4a353]"; stIcon = "fa-fire animate-bounce"; }
                        if(o.status === 'ready') { stClass = "bg-[#e8fce8] text-[#557b55] border-[#557b55]"; stIcon = "fa-bell animate-pulse"; }
                        if(o.status === 'delivered') { stClass = "bg-[#d0e0ff] text-[#4a6fa5] border-[#4a6fa5]"; stIcon = "fa-thumbs-up"; }
                        
                        const itemBgClass = t.isVip ? 'bg-[#fff5ee] border-[#cba135]' : 'bg-[#fffdf9] border-[#a89f91]';
                        
                        return `<div class="${itemBgClass} p-3 rounded-sm shadow-[2px_2px_0_#a89f91] mb-3 border-2 relative overflow-hidden">
                        ${t.isVip ? '<div class="absolute top-0 right-0 w-0 h-0 border-t-[30px] border-r-[30px] border-t-transparent border-r-[#cba135]/30"></div>' : ''}
                        <div class="flex justify-between items-start relative z-10">
                            <div><div class="font-bold text-[#2c1e16] text-xl leading-tight" style="font-family: 'Abril Fatface', cursive;"><span class="text-[#a63e3e] mr-1">${o.quantity}x</span> ${o.itemName}</div>
                                ${o.modifiers&&o.modifiers.length?`<div class="text-[11px] text-[#a63e3e] font-bold mt-2 bg-[#fce8e8] p-1.5 rounded-sm inline-block border-2 border-[#a63e3e] font-mono shadow-[1px_1px_0_#a63e3e]"><i class="fa-solid fa-pen-to-square mr-1"></i> ${o.modifiers.join(', ')}</div>`:''}
                                <div class="text-[10px] text-[#a89f91] mt-1 font-mono font-bold flex items-center gap-1"><i class="fa-regular fa-clock"></i> ${new Date(o.timestamp?.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div></div>
                            <div class="text-right flex flex-col items-end gap-2">
                                <div class="font-black text-[#5c4033] text-xl" style="font-family: 'Special Elite', cursive;">$${o.price*o.quantity}</div>
                                <span class="text-[10px] font-bold px-2 py-1 rounded-sm flex items-center gap-1 justify-end border-2 uppercase tracking-wider shadow-[1px_1px_0_rgba(0,0,0,0.2)] ${stClass}" style="font-family: 'Abril Fatface', cursive;"><i class="fa-solid ${stIcon}"></i> ${o.status}</span>
                            </div>
                        </div></div>`;
                    }).join('')}
                </div>
                ${footerHtml}</div>`;
            document.getElementById('content-area').innerHTML = html;
        }

        function renderMenuSection(cat) {
            return MENU.filter(i => i.category === cat).map(i => `
                <button onclick="openCustomizeModal('${i.id}')" class="bg-[#fffdf9] p-3 rounded-sm shadow-[2px_2px_0_#a89f91] flex justify-between items-center text-left active:bg-[#fff0e6] border-2 border-[#a89f91] active:border-[#cba135] transition group relative overflow-hidden active:translate-x-[1px] active:translate-y-[1px] active:shadow-[1px_1px_0_#a89f91]">
                    <div class="flex items-center gap-4 relative z-10">
                        <div class="w-12 h-12 bg-[#e0d8c8] rounded-full flex items-center justify-center text-[#5c4033] group-active:scale-110 transition border-2 border-[#a89f91] shadow-[1px_1px_0_#a89f91] text-xl"><i class="fa-solid ${i.icon}"></i></div>
                        <div><div class="font-bold text-lg text-[#2c1e16] group-active:text-[#a63e3e]" style="font-family: 'Abril Fatface', cursive;">${i.name}</div><div class="text-sm text-[#5c4033] font-mono font-bold">$${i.price}</div></div>
                    </div>
                    <div class="bg-[#cba135] text-[#2c1e16] w-10 h-10 rounded-full flex items-center justify-center font-bold shadow-[2px_2px_0_#2c1e16] group-active:bg-[#2c1e16] group-active:text-[#cba135] transition border-2 border-[#2c1e16] text-lg relative z-10"><i class="fa-solid fa-plus"></i></div>
                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-transparent to-[#fff0e6]/50 opacity-0 group-active:opacity-100 transition"></div>
                </button>`).join('');
        }

        window.openCustomizeModal = function(itemId) {
            const item = MENU.find(i => i.id === itemId);
            if (item.isPackage) { openPackageModal(item); return; }
            const modal = document.getElementById('modal-content');
            
            // Header y Footer del Modal (Com√∫n)
            const modalHeader = `<div class="p-4 border-b-[3px] double border-[#cba135] bg-[#f8f1e5] flex justify-between items-center shadow-[0_2px_0_#a89f91]"><div><h3 class="font-black text-2xl text-[#2c1e16] uppercase tracking-wide" style="font-family: 'Abril Fatface', cursive; text-shadow: 1px 1px 0 #cba135;">${item.name}</h3><p class="text-[#a63e3e] font-bold font-mono text-lg">$${item.price}</p></div><button onclick="closeModal()" class="text-[#5c4033] text-2xl hover:text-[#a63e3e] transition bg-[#fffdf9] rounded-full w-10 h-10 flex items-center justify-center border-2 border-[#5c4033] shadow-[2px_2px_0_#5c4033]"><i class="fa-solid fa-times"></i></button></div>`;
            const modalFooter = (submitFunc) => `<div class="p-4 border-t-[3px] double border-[#cba135] bg-[#fffdf9] flex gap-4 shadow-[0_-2px_0_#a89f91]"><button onclick="closeModal()" class="flex-1 btn-retro btn-retro-neutral py-4 text-[#5c4033]">CANCELAR</button><button onclick="${submitFunc}('${item.id}')" class="flex-1 btn-retro btn-retro-green py-4 text-lg">AGREGAR PEDIDO</button></div>`;

            if (item.isBeer && item.category === 'bar') {
                const isGeneric = item.type === 'regular'; 
                modal.innerHTML = `<div class="flex-1 flex flex-col h-full max-h-[85vh] bg-[#f8f1e5]">${modalHeader}
                        <div class="p-5 overflow-y-auto flex-1 space-y-6" style="background-image: url('data:image/svg+xml,%3Csvg width=\'20\' height=\'20\' viewBox=\'0 0 20 20\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'%23a89f91\' fill-opacity=\'0.1\' fill-rule=\'evenodd\'%3E%3Ccircle cx=\'3\' cy=\'3\' r=\'3\'/%3E%3Ccircle cx=\'13\' cy=\'13\' r=\'3\'/%3E%3C/g%3E%3C/svg%3E');">
                            <div class="flex justify-center items-center gap-8 bg-[#fffdf9] p-4 rounded-sm shadow-[inset_2px_2px_4px_rgba(92,64,51,0.1)] border-2 border-[#a89f91]"><button onclick="adjQty(-1)" class="w-14 h-14 rounded-full bg-[#e0d8c8] text-[#5c4033] text-3xl font-bold border-2 border-[#a89f91] shadow-[2px_2px_0_#a89f91] active:shadow-[1px_1px_0_#a89f91] active:translate-x-[1px] active:translate-y-[1px] transition">-</button><span id="modal-qty" class="text-5xl font-black text-[#2c1e16]" style="font-family: 'Special Elite', cursive;">1</span><button onclick="adjQty(1)" class="w-14 h-14 rounded-full bg-[#cba135] text-[#2c1e16] text-3xl font-bold border-2 border-[#2c1e16] shadow-[2px_2px_0_#2c1e16] active:shadow-[1px_1px_0_#2c1e16] active:translate-x-[1px] active:translate-y-[1px] transition">+</button></div>
                            ${isGeneric ? `<div><h4 class="text-sm font-bold text-[#5c4033] uppercase mb-3 font-mono tracking-wider border-b-2 border-dashed border-[#a89f91] pb-1">Tipo de Cerveza</h4><div class="grid grid-cols-2 gap-4" id="beer-type-group"><div onclick="selectBeerType(this)" class="option-btn clara selected" data-val="Clara" style="font-family: 'Abril Fatface', cursive;">CLARA</div><div onclick="selectBeerType(this)" class="option-btn oscura" data-val="Oscura" style="font-family: 'Abril Fatface', cursive;">OSCURA</div></div></div>` : ''}
                            <div><h4 class="text-sm font-bold text-[#5c4033] uppercase mb-3 font-mono tracking-wider border-b-2 border-dashed border-[#a89f91] pb-1">Preparaci√≥n</h4><div class="grid grid-cols-1 gap-3" id="beer-prep-group"><div onclick="selectBeerPrep(this)" class="prep-radio" data-val="Escarchado Sal">Escarchado Sal</div><div onclick="selectBeerPrep(this)" class="prep-radio selected" data-val="Escarchado Chamoy">Escarchado Chamoy</div><div onclick="selectBeerPrep(this)" class="prep-radio" data-val="Sin Escarchar">Sin Escarchar</div></div></div>
                            <div class="flex gap-3"><button onclick="toggleMod(this)" class="mod-btn btn-red flex-1 py-4 rounded-sm font-bold shadow-sm text-sm tracking-wider uppercase" id="btn-sin-limon" style="font-family: 'Abril Fatface', cursive;">SIN LIM√ìN</button><button onclick="toggleMod(this)" class="mod-btn btn-red flex-1 py-4 rounded-sm font-bold shadow-sm hidden text-sm tracking-wider uppercase" id="btn-sin-ajonjoli" style="font-family: 'Abril Fatface', cursive;">SIN AJONJOL√ç</button></div>
                            <div onclick="toggleMod(this)" class="mod-btn btn-green p-4 rounded-sm flex justify-between items-center cursor-pointer mt-4 shadow-sm border-2" id="btn-clamato"><span class="font-bold flex items-center gap-2 uppercase tracking-wide" style="font-family: 'Abril Fatface', cursive;"><i class="fa-solid fa-droplet animate-bounce"></i> EXTRA CLAMATO</span><span class="font-black bg-[#557b55] text-[#f8f1e5] px-3 py-1 rounded-sm text-sm border-2 border-[#2c1e16] shadow-[2px_2px_0_#2c1e16] font-mono">+$5</span></div>
                            <input type="text" id="manual-note" placeholder="Nota extra para barra..." class="w-full mt-4">
                        </div>
                        ${modalFooter('submitBeerOrder')}</div>`;
                checkChamoy();
            } else {
                let mods = item.modGroup ? MODIFIERS[item.modGroup] : (MODIFIERS['general_' + item.category] || []);
                modal.innerHTML = `<div class="flex-1 flex flex-col h-full max-h-[85vh] bg-[#f8f1e5]">${modalHeader}
                        <div class="p-5 overflow-y-auto flex-1" style="background-image: url('data:image/svg+xml,%3Csvg width=\'20\' height=\'20\' viewBox=\'0 0 20 20\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'%23a89f91\' fill-opacity=\'0.1\' fill-rule=\'evenodd\'%3E%3Ccircle cx=\'3\' cy=\'3\' r=\'3\'/%3E%3Ccircle cx=\'13\' cy=\'13\' r=\'3\'/%3E%3C/g%3E%3C/svg%3E');">
                            <div class="flex justify-center items-center gap-8 mb-8 bg-[#fffdf9] p-4 rounded-sm shadow-[inset_2px_2px_4px_rgba(92,64,51,0.1)] border-2 border-[#a89f91]"><button onclick="adjQty(-1)" class="w-14 h-14 rounded-full bg-[#e0d8c8] text-[#5c4033] text-3xl font-bold border-2 border-[#a89f91] shadow-[2px_2px_0_#a89f91] active:shadow-[1px_1px_0_#a89f91] active:translate-x-[1px] active:translate-y-[1px] transition">-</button><span id="modal-qty" class="text-5xl font-black text-[#2c1e16]" style="font-family: 'Special Elite', cursive;">1</span><button onclick="adjQty(1)" class="w-14 h-14 rounded-full bg-[#cba135] text-[#2c1e16] text-3xl font-bold border-2 border-[#2c1e16] shadow-[2px_2px_0_#2c1e16] active:shadow-[1px_1px_0_#2c1e16] active:translate-x-[1px] active:translate-y-[1px] transition">+</button></div>
                            ${mods.length > 0 ? `<h4 class="text-sm font-bold text-[#5c4033] uppercase mb-3 font-mono tracking-wider border-b-2 border-dashed border-[#a89f91] pb-1">Modificadores</h4><div class="flex flex-wrap gap-3 mb-6">${mods.map(m => {
                                let cls = m.startsWith("Sin") ? "btn-red" : (m.startsWith("Con")||m.includes("+") ? "btn-green" : "btn-neutral");
                                return `<button onclick="toggleMod(this)" class="mod-btn px-4 py-3 rounded-sm text-sm shadow-sm font-bold tracking-wide ${cls}" style="font-family: 'Abril Fatface', cursive;">${m}</button>`;
                            }).join('')}</div>` : ''}
                            <input type="text" id="manual-note" placeholder="Nota especial para cocina..." class="w-full">
                        </div>
                        ${modalFooter('submitGeneralOrder')}</div>`;
            }
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        // --- CONSTRUCTOR DE PAQUETES ---
        window.openPackageModal = function(item) {
            const modal = document.getElementById('modal-content');
            let content = '';
            
            const salsaSection = (title, name) => `<div class="pkg-section"><h4 class="pkg-title">${title}</h4><div class="grid grid-cols-3 gap-3">${MODIFIERS.salsas.map(s => `<label class="flex items-center gap-2 text-xs border-2 border-[#a89f91] p-3 rounded-sm cursor-pointer bg-[#fffdf9] hover:bg-[#e0d8c8] transition font-bold shadow-[2px_2px_0_#a89f91]"><input type="radio" name="${name}" value="${s}" class="accent-[#cba135] w-4 h-4"> ${s}</label>`).join('')}</div></div>`;
            const beerSection = (num) => `<div class="pkg-section"><h4 class="pkg-title">Tarro ${num} (¬Ω Litro)</h4><div class="grid grid-cols-2 gap-3 mb-3"><select id="p_beer_type_${num}" class="w-full"><option value="Clara">Clara</option><option value="Oscura">Oscura</option></select><select id="p_beer_prep_${num}" class="w-full"><option value="Escarchado Chamoy">Chamoy</option><option value="Escarchado Sal">Sal</option><option value="Sin Escarchar">Sin</option></select></div><label class="flex items-center gap-2 text-sm font-bold text-[#5c4033] bg-[#e0d8c8] p-2 rounded-sm border-2 border-[#a89f91] shadow-[1px_1px_0_#a89f91] w-fit"><input type="checkbox" id="p_beer_nolimon_${num}" class="accent-[#a63e3e] w-4 h-4"> Sin Lim√≥n</label></div>`;
            
            const radioGroup = (name, options) => `<div class="flex gap-4 bg-[#e0d8c8] p-3 rounded-sm border-2 border-[#a89f91] shadow-[inset_1px_1px_2px_rgba(0,0,0,0.1)]">${options.map((opt, i) => `<label class="flex items-center gap-2 font-bold text-[#5c4033]"><input type="radio" name="${name}" value="${opt}" ${i===0?'checked':''} class="accent-[#cba135] w-5 h-5"> ${opt}</label>`).join('')}</div>`;
            const checkGroup = (cls, options) => `<div class="grid grid-cols-3 gap-2 bg-[#fffdf9] p-2 rounded-sm border-2 border-[#a89f91]">${options.map(m=>`<label class="text-xs font-bold flex items-center gap-1 text-[#5c4033] p-1 hover:bg-[#e0d8c8] rounded-sm transition"><input type="checkbox" class="${cls} accent-[#a63e3e] w-3.5 h-3.5" value="${m}"> ${m}</label>`).join('')}</div>`;

            if(item.id === 'p1') {
                content = `${salsaSection('Salsa Alitas', 'p1_salsa_alitas')}${salsaSection('Salsa Boneless', 'p1_salsa_boneless')}<div class="pkg-section"><h4 class="pkg-title">Guarnici√≥n</h4>${radioGroup('p1_side', ['Media Papas', 'Media Aros'])}</div>${beerSection(1)} ${beerSection(2)}`;
            } else if(item.id === 'p2') {
                content = `<div class="pkg-section"><h4 class="pkg-title">Elecci√≥n Principal</h4>${radioGroup('p2_main', ['Alitas', 'Boneless'])}${salsaSection('Salsa (Para elecci√≥n)', 'p2_salsa_main').replace('<div class="pkg-section">','<div class="mt-3">')}</div><div class="pkg-section"><h4 class="pkg-title">Hamburguesa 1</h4>${checkGroup('p2_h1_mod', MODIFIERS.burgers)}</div><div class="pkg-section"><h4 class="pkg-title">Hamburguesa 2</h4>${checkGroup('p2_h2_mod', MODIFIERS.burgers)}</div><div class="pkg-section"><h4 class="pkg-title">Guarnici√≥n</h4>${radioGroup('p2_side', ['Media Papas', 'Media Aros'])}<div class="mt-3">${checkGroup('p2_side_mod', MODIFIERS.snacks)}</div></div>${beerSection(1)} ${beerSection(2)}`;
            } else if(item.id === 'p3') {
                content = `${salsaSection('Salsa Alitas', 'p3_salsa_alitas')}${salsaSection('Salsa Boneless', 'p3_salsa_boneless')}<div class="pkg-section"><h4 class="pkg-title">Aros de Cebolla (Orden Completa)</h4>${checkGroup('p3_aros_mod', MODIFIERS.snacks)}</div><div class="pkg-section"><h4 class="pkg-title">3 Hot Dogs (Iguales)</h4>${checkGroup('p3_hd_mod', MODIFIERS.hotdogs)}</div><div class="pkg-section"><h4 class="pkg-title">3 Tarros Peque√±os (Iguales)</h4><div class="grid grid-cols-2 gap-3 mb-3"><select id="p3_beer_type" class="w-full"><option>Clara</option><option>Oscura</option></select><select id="p3_beer_prep" class="w-full"><option>Chamoy</option><option>Sal</option><option>Sin</option></select></div><label class="flex items-center gap-2 text-sm font-bold text-[#5c4033] bg-[#e0d8c8] p-2 rounded-sm border-2 border-[#a89f91] shadow-[1px_1px_0_#a89f91] w-fit"><input type="checkbox" id="p3_beer_nolimon" class="accent-[#a63e3e] w-4 h-4"> Sin Lim√≥n</label></div>`;
            }

            modal.innerHTML = `<div class="flex-1 flex flex-col h-full max-h-[90vh] bg-[#f8f1e5]">
                <div class="p-4 border-b-[3px] double border-[#cba135] bg-[#f8f1e5] flex justify-between items-center shadow-[0_2px_0_#a89f91]"><div><h3 class="font-black text-2xl text-[#2c1e16] uppercase tracking-wide" style="font-family: 'Abril Fatface', cursive; text-shadow: 1px 1px 0 #cba135;">${item.name}</h3><p class="text-[#a63e3e] font-bold font-mono text-lg">$${item.price}</p></div><button onclick="closeModal()" class="text-[#5c4033] text-2xl hover:text-[#a63e3e] transition bg-[#fffdf9] rounded-full w-10 h-10 flex items-center justify-center border-2 border-[#5c4033] shadow-[2px_2px_0_#5c4033]"><i class="fa-solid fa-times"></i></button></div>
                <div class="p-5 overflow-y-auto flex-1 space-y-4" style="background-image: url('data:image/svg+xml,%3Csvg width=\'20\' height=\'20\' viewBox=\'0 0 20 20\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'%23a89f91\' fill-opacity=\'0.1\' fill-rule=\'evenodd\'%3E%3Ccircle cx=\'3\' cy=\'3\' r=\'3\'/%3E%3Ccircle cx=\'13\' cy=\'13\' r=\'3\'/%3E%3C/g%3E%3C/svg%3E');">${content}</div>
                <div class="p-4 border-t-[3px] double border-[#cba135] bg-[#fffdf9] flex gap-4 shadow-[0_-2px_0_#a89f91]"><button onclick="closeModal()" class="flex-1 btn-retro btn-retro-neutral py-4 text-[#5c4033]">CANCELAR</button><button onclick="submitPackageOrder('${item.id}')" class="flex-1 btn-retro btn-retro-green py-4 text-lg">AGREGAR PAQUETE</button></div>
            </div>`;
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        window.submitPackageOrder = async (itemId) => {
            const item = MENU.find(i => i.id === itemId);
            let kitchenMods = [], barMods = [];
            const getRadio = (name) => document.querySelector(`input[name="${name}"]:checked`)?.value || 'Sin elecci√≥n';
            const getChecks = (cls) => Array.from(document.querySelectorAll(`.${cls}:checked`)).map(c => c.value).join(', ');
            const getBeer = (n) => `T${n}: ${document.getElementById(`p_beer_type_${n}`).value}, ${document.getElementById(`p_beer_prep_${n}`).value}` + (document.getElementById(`p_beer_nolimon_${n}`).checked ? ' (Sin Lim√≥n)' : '');

            if(itemId === 'p1') {
                kitchenMods.push(`Alitas: ${getRadio('p1_salsa_alitas')}`); kitchenMods.push(`Boneless: ${getRadio('p1_salsa_boneless')}`); kitchenMods.push(`Guarnici√≥n: ${getRadio('p1_side')}`);
                barMods.push(getBeer(1)); barMods.push(getBeer(2));
            } else if(itemId === 'p2') {
                kitchenMods.push(`Principal: ${getRadio('p2_main')} (${getRadio('p2_salsa_main')})`); kitchenMods.push(`Burg 1: ${getChecks('p2_h1_mod') || 'Sencilla'}`); kitchenMods.push(`Burg 2: ${getChecks('p2_h2_mod') || 'Sencilla'}`); kitchenMods.push(`Guarnici√≥n: ${getRadio('p2_side')} (${getChecks('p2_side_mod')})`);
                barMods.push(getBeer(1)); barMods.push(getBeer(2));
            } else if(itemId === 'p3') {
                kitchenMods.push(`Alitas: ${getRadio('p3_salsa_alitas')}`); kitchenMods.push(`Boneless: ${getRadio('p3_salsa_boneless')}`); kitchenMods.push(`Aros: ${getChecks('p3_aros_mod')}`); kitchenMods.push(`3 HotDogs: ${getChecks('p3_hd_mod')}`);
                barMods.push(`3 Tarros: ${document.getElementById('p3_beer_type').value}, ${document.getElementById('p3_beer_prep').value}` + (document.getElementById('p3_beer_nolimon').checked ? ' (Sin Lim√≥n)' : ''));
            }

            await addDoc(collection(db, 'orders'), { tableId: currentTableId, itemId: item.id, itemName: `${item.name} (Cocina)`, category: 'kitchen', price: item.price, quantity: 1, modifiers: kitchenMods, status: 'ordered', timestamp: serverTimestamp() });
            await addDoc(collection(db, 'orders'), { tableId: currentTableId, itemId: item.id, itemName: `${item.name} (Barra)`, category: 'bar', price: 0, quantity: 1, modifiers: barMods, status: 'ordered', timestamp: serverTimestamp() });
            closeModal(); switchTab('orders');
        }

        window.selectRadio = (el, groupId) => { const group = document.getElementById(groupId); if(group) { group.querySelectorAll('.beer-radio, .prep-radio').forEach(d => d.classList.remove('selected')); el.classList.add('selected'); } }
        window.selectBeerType = (el) => { document.querySelectorAll('#beer-type-group .option-btn').forEach(d => d.classList.remove('selected')); el.classList.add('selected'); }
        window.selectBeerPrep = (el) => { document.querySelectorAll('#beer-prep-group .prep-radio').forEach(d => d.classList.remove('selected')); el.classList.add('selected'); checkChamoy(); }
        window.checkChamoy = () => { const sel = document.querySelector('#beer-prep-group .prep-radio.selected')?.dataset.val; const btn = document.getElementById('btn-sin-ajonjoli'); if (btn) { if(sel === 'Escarchado Chamoy') btn.classList.remove('hidden'); else { btn.classList.add('hidden'); btn.classList.remove('selected'); } } }

        window.submitBeerOrder = async (itemId) => {
            const item = MENU.find(i => i.id === itemId);
            const qty = parseInt(document.getElementById('modal-qty').innerText);
            let finalPrice = item.price;
            let mods = [];
            const typeEl = document.querySelector('#beer-type-group .option-btn.selected'); if(typeEl) mods.push(typeEl.dataset.val);
            const prepEl = document.querySelector('#beer-prep-group .prep-radio.selected'); if(prepEl) mods.push(prepEl.dataset.val);
            if(document.getElementById('btn-sin-limon').classList.contains('selected')) mods.push("Sin Lim√≥n");
            if(document.getElementById('btn-sin-ajonjoli') && document.getElementById('btn-sin-ajonjoli').classList.contains('selected')) mods.push("Sin Ajonjol√≠");
            if(document.getElementById('btn-clamato').classList.contains('selected')) { mods.push("Extra Clamato"); finalPrice += 5; }
            const note = document.getElementById('manual-note').value.trim(); if(note) mods.push(note);
            await addOrderToDb(item, finalPrice, qty, mods);
        }

        window.submitGeneralOrder = async (itemId) => {
            const item = MENU.find(i => i.id === itemId);
            const qty = parseInt(document.getElementById('modal-qty').innerText);
            const mods = Array.from(document.querySelectorAll('.mod-btn.selected')).map(el => el.innerText);
            const note = document.getElementById('manual-note').value.trim();
            if(note) mods.push(note);
            await addOrderToDb(item, item.price, qty, mods);
        }

        async function addOrderToDb(item, price, qty, mods) {
            await addDoc(collection(db, 'orders'), {
                tableId: currentTableId, itemId: item.id, itemName: item.name, category: item.category,
                price: price, quantity: qty, modifiers: mods, status: 'ordered', timestamp: serverTimestamp()
            });
            closeModal();
            switchTab('orders');
        }

        window.openNewTableModal = () => { document.getElementById('modal-content').innerHTML = `<div class="p-6 bg-[#f8f1e5] modal-retro border-0 shadow-none"><h3 class="font-black text-2xl mb-6 text-[#2c1e16] border-b-[3px] double border-[#cba135] pb-2 uppercase tracking-widest" style="font-family: 'Abril Fatface', cursive; text-shadow: 1px 1px 0 #cba135;">ABRIR NUEVA MESA</h3><input type="number" id="ntn" placeholder="N√∫mero de Mesa" class="w-full mb-4"><input type="text" id="ntnm" placeholder="Apodo / Referencia" class="w-full mb-6"><label class="flex items-center gap-3 mb-8 p-4 border-2 border-[#cba135] bg-[#fff0e6] rounded-sm cursor-pointer shadow-[3px_3px_0_#cba135] hover:bg-[#ffe8d6] transition w-fit mx-auto"><input type="checkbox" id="ntvip" class="w-6 h-6 accent-[#cba135] border-2 border-[#2c1e16]"> <span class="font-bold text-[#2c1e16] text-lg" style="font-family: 'Abril Fatface', cursive;"><i class="fa-solid fa-crown text-[#cba135] mr-2 drop-shadow-[1px_1px_0_#2c1e16]"></i> Cliente Distinguido (VIP)</span></label><div class="flex gap-4"><button onclick="closeModal()" class="flex-1 btn-retro btn-retro-neutral py-4 text-[#5c4033]">CANCELAR</button><button onclick="subNT()" class="flex-1 btn-retro btn-retro-green py-4 text-lg">ABRIR MESA</button></div></div>`; document.getElementById('modal-overlay').classList.remove('hidden'); }
        window.subNT = async () => {
            const num = document.getElementById('ntn').value;
            const nick = document.getElementById('ntnm').value || 'Cliente';
            const isVip = document.getElementById('ntvip').checked;
            if(!num) return;
            try {
                await runTransaction(db, async (transaction) => {
                    const counterRef = doc(db, 'config', 'counters_tables');
                    const counterDoc = await transaction.get(counterRef);
                    let newId = 1000;
                    if (counterDoc.exists()) newId = counterDoc.data().current + 1;
                    transaction.set(counterRef, { current: newId });
                    const newTableRef = doc(collection(db, 'tables'));
                    transaction.set(newTableRef, { number: num, nickname: nick, status: 'open', openedAt: serverTimestamp(), uniqueId: newId, isVip: isVip });
                });
                closeModal();
            } catch (e) { alert("Error al crear mesa."); console.error(e); }
        }

        window.adjQty = (d) => { const el=document.getElementById('modal-qty'); let v=parseInt(el.innerText)+d; if(v<1)v=1; el.innerText=v; }
        window.toggleMod = (b) => b.classList.toggle('selected');
        window.switchTab = (t) => {
            if(t==='menu'){ 
                document.getElementById('tab-menu').classList.remove('hidden'); document.getElementById('tab-orders').classList.add('hidden'); document.getElementById('order-footer').classList.add('hidden'); 
                document.getElementById('tab-btn-menu').className="flex-1 py-3 text-[#2c1e16] border-b-4 border-[#cba135] bg-[#fff0e6] font-bold tracking-wide";
                document.getElementById('tab-btn-orders').className="flex-1 py-3 text-[#a89f91] font-bold hover:bg-[#fff0e6] transition tracking-wide";
            } else { 
                document.getElementById('tab-menu').classList.add('hidden'); document.getElementById('tab-orders').classList.remove('hidden'); document.getElementById('order-footer').classList.remove('hidden');
                document.getElementById('tab-btn-orders').className="flex-1 py-3 text-[#2c1e16] border-b-4 border-[#cba135] bg-[#fff0e6] font-bold tracking-wide";
                document.getElementById('tab-btn-menu').className="flex-1 py-3 text-[#a89f91] font-bold hover:bg-[#fff0e6] transition tracking-wide";
            }
        }
        window.closeModal = () => document.getElementById('modal-overlay').classList.add('hidden');
        window.logoutToHome = () => renderHome();

        function renderBoard(cat) {
            document.getElementById('header-title').innerText = cat === 'kitchen' ? 'COCINA' : 'BARRA';
            const active = ordersData.filter(o => o.category === cat && ['ordered','preparing'].includes(o.status)).sort((a,b) => {
                const ta = a.timestamp?.seconds || Date.now()/1000;
                const tb = b.timestamp?.seconds || Date.now()/1000;
                return ta - tb; 
            });
            const ready = ordersData.filter(o => o.category === cat && o.status === 'ready');
            
            const colStyle = (borderCol, titleCol, icon) => `flex-1 min-w-[320px] bg-[#fffdf9] rounded-sm shadow-[4px_4px_0_#5c4033] p-4 flex flex-col border-4 double border-[${borderCol}] relative overflow-hidden`;
            const titleStyle = (textCol) => `font-black text-[${textCol}] mb-4 text-xl flex items-center gap-3 border-b-2 border-dashed border-[${textCol}] pb-2 tracking-wider`;

            let html = `<div class="flex h-full p-4 gap-6 overflow-x-auto bg-[#f8f1e5]" style="background-image: url('data:image/svg+xml,%3Csvg width=\'40\' height=\'40\' viewBox=\'0 0 40 40\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'%235c4033\' fill-opacity=\'0.05\' fill-rule=\'evenodd\'%3E%3Cpath d=\'M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41zM20 18.6l2.83-2.83 1.41 1.41L21.41 20l2.83 2.83-1.41 1.41L20 21.41l-2.83 2.83-1.41-1.41L18.59 20l-2.83-2.83 1.41-1.41L20 18.59z\'/%3E%3C/g%3E%3C/svg%3E');">`;
            
            html += `<div class="${colStyle('#a63e3e', '#a63e3e')}"><div class="absolute top-0 right-0 opacity-10"><i class="fa-solid fa-clipboard-list text-6xl text-[#a63e3e]"></i></div><h3 class="${titleStyle('#a63e3e')}"><i class="fa-solid fa-inbox animate-bounce"></i> PENDIENTES (${active.filter(o=>o.status==='ordered').length})</h3><div class="flex-1 overflow-y-auto space-y-4 p-1">${active.filter(o=>o.status==='ordered').map(o=>card(o,'ordered')).join('')}</div></div>`;
            if(cat==='kitchen') html += `<div class="${colStyle('#d4a353', '#d4a353')}"><div class="absolute top-0 right-0 opacity-10"><i class="fa-solid fa-fire-burner text-6xl text-[#d4a353]"></i></div><h3 class="${titleStyle('#d4a353')}"><i class="fa-solid fa-fire animate-pulse"></i> COCINANDO (${active.filter(o=>o.status==='preparing').length})</h3><div class="flex-1 overflow-y-auto space-y-4 p-1">${active.filter(o=>o.status==='preparing').map(o=>card(o,'preparing')).join('')}</div></div>`;
            html += `<div class="${colStyle('#557b55', '#557b55')}"><div class="absolute top-0 right-0 opacity-10"><i class="fa-solid fa-bell-concierge text-6xl text-[#557b55]"></i></div><h3 class="${titleStyle('#557b55')}"><i class="fa-solid fa-check-double"></i> LISTOS (${ready.length})</h3><div class="flex-1 overflow-y-auto space-y-4 p-1">${ready.map(o=>card(o,'ready')).join('')}</div></div>`;
            document.getElementById('content-area').innerHTML = html + `</div>`;
        }
        
        function card(o,s) {
            const t = tablesData.find(x=>x.id===o.tableId);
            const timeAgo = Math.floor((new Date()-new Date(o.timestamp?.seconds*1000))/60000);
            let btnClass = "btn-retro-neutral", btnText = "Acci√≥n", btnIcon = "fa-arrow-right";
            if(s==='ordered') { if(o.category==='bar') { btnText="Terminar"; btnClass="btn-retro-green"; btnIcon="fa-check"; } else { btnText="Cocinar"; btnClass="btn-retro-yellow"; btnIcon="fa-fire"; } }
            else if(s==='preparing') { btnText="Terminar"; btnClass="btn-retro-green"; btnIcon="fa-check"; } 
            else { btnText="Entregar"; btnClass="btn-retro-blue"; btnIcon="fa-thumbs-up"; }
            let nextSt = s==='ordered' ? (o.category==='bar'?'ready':'preparing') : (s==='preparing'?'ready':'delivered');
            
            const isVip = t?.isVip;
            const cardBg = isVip ? "bg-[#fff0e6] border-[#cba135]" : "bg-[#fffdf9] border-[#a89f91]";
            const vipBadge = isVip ? `<span class="bg-[#cba135] text-[#2c1e16] text-[10px] px-2 py-0.5 rounded-sm ml-2 border border-[#2c1e16] shadow-[1px_1px_0_#2c1e16] font-bold" style="font-family: 'Abril Fatface', cursive;"><i class="fa-solid fa-crown"></i> VIP</span>` : '';
            
            return `<div class="${cardBg} p-4 rounded-sm shadow-[3px_3px_0_rgba(92,64,51,0.3)] border-2 relative overflow-hidden">
                ${isVip ? '<div class="absolute top-0 right-0 w-0 h-0 border-t-[40px] border-r-[40px] border-t-transparent border-r-[#cba135]/40 z-0"></div>' : ''}
                <div class="relative z-10">
                <div class="flex justify-between font-bold text-xl mb-3 pb-2 border-b-2 border-dashed border-[#a89f91]"><span class="bg-[#2c1e16] text-[#f8f1e5] px-3 py-1 rounded-sm text-base flex items-center shadow-[2px_2px_0_#a89f91]" style="font-family: 'Abril Fatface', cursive;">MESA ${t?t.number:'?'}${vipBadge}</span><span class="text-xs font-normal text-[#5c4033] bg-[#e0d8c8] border-2 border-[#a89f91] px-2 py-1 rounded-sm flex items-center gap-2 font-mono font-bold shadow-[1px_1px_0_#a89f91]"><i class="fa-regular fa-clock"></i> ${timeAgo} min</span></div>
                <div class="text-2xl leading-tight text-[#2c1e16] mb-3" style="font-family: 'Abril Fatface', cursive;"><span class="font-black text-[#a63e3e] mr-2 text-3xl">${o.quantity}x</span> ${o.itemName}</div>
                ${o.modifiers&&o.modifiers.length?`<div class="text-xs text-[#a63e3e] font-bold bg-[#fce8e8] p-3 rounded-sm border-2 border-[#a63e3e] mb-4 flex flex-col gap-1 items-start font-mono shadow-[2px_2px_0_rgba(166,62,62,0.3)]"><i class="fa-solid fa-clipboard-check mb-1 text-base"></i> <span>${o.modifiers.join(', ')}</span></div>`:''}
                <button onclick="upd('${o.id}','${nextSt}')" class="w-full btn-retro ${btnClass} py-4 text-lg flex justify-center items-center gap-3"><i class="fa-solid ${btnIcon}"></i> ${btnText}</button></div></div>`;
        }
        window.upd = async(id,s) => await updateDoc(doc(db,'orders',id),{status:s});

        window.openCloseAccountModal = (tid, total) => {
            const t = tablesData.find(x => x.id === tid);
            document.getElementById('modal-content').innerHTML = `<div class="p-6 text-center bg-[#f8f1e5] modal-retro border-0 shadow-none">
                    <h3 class="font-black text-4xl text-[#2c1e16] mb-2 uppercase tracking-widest" style="font-family: 'Abril Fatface', cursive; text-shadow: 2px 2px 0 #cba135;">MESA ${t.number}</h3>
                    <p class="text-[#5c4033] font-mono text-lg mb-6 font-bold border-b-2 border-dashed border-[#a89f91] pb-4 inline-block px-6">Ticket #${t.uniqueId || '---'}</p>
                    
                    <!-- PAYMENT TOGGLE -->
                    <label class="flex items-center justify-center gap-4 mb-6 cursor-pointer bg-[#fffdf9] p-4 rounded-sm shadow-[3px_3px_0_#a89f91] border-2 border-[#a89f91] hover:bg-[#e0d8c8] transition w-fit mx-auto">
                        <input type="checkbox" id="close-card-check" onchange="calcCloseTotal(${total})" class="w-6 h-6 accent-[#4a6fa5] border-2 border-[#2c1e16]">
                        <span class="font-bold text-[#2c1e16] flex items-center gap-3 text-lg" style="font-family: 'Abril Fatface', cursive;"><i class="fa-solid fa-credit-card text-[#4a6fa5] text-2xl drop-shadow-[1px_1px_0_#2c1e16]"></i> Pago con Tarjeta (+4%)</span>
                    </label>

                    <div class="bg-[#fffdf9] p-6 rounded-sm shadow-[inset_2px_2px_4px_rgba(92,64,51,0.1)] border-4 double border-[#5c4033] mb-8 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-2 bg-repeat-x" style="background-image: url('data:image/svg+xml,%3Csvg width=\'20\' height=\'10\' viewBox=\'0 0 20 10\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M0 10L10 0L20 10H0Z\' fill=\'%235c4033\'/%3E%3C/svg%3E');"></div>
                         <div id="close-breakdown" class="hidden text-base mb-4 space-y-2 font-mono text-[#5c4033] border-b-2 border-dashed border-[#a89f91] pb-4">
                            <div class="flex justify-between"><span>Subtotal:</span><span>$${total}</span></div>
                            <div class="flex justify-between text-[#a63e3e] font-bold"><span>Comisi√≥n (4%):</span><span id="close-comm-val">$0</span></div>
                        </div>
                        <span class="block text-[#a89f91] text-sm uppercase font-bold tracking-[0.3em] mb-2 font-mono">Total a Pagar</span>
                        <span class="block text-7xl font-black text-[#2c1e16]" id="close-total-val" style="font-family: 'Special Elite', cursive; text-shadow: 2px 2px 0 rgba(92,64,51,0.2);">$${total}</span>
                        <div class="absolute bottom-0 left-0 w-full h-2 bg-repeat-x transform rotate-180" style="background-image: url('data:image/svg+xml,%3Csvg width=\'20\' height=\'10\' viewBox=\'0 0 20 10\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M0 10L10 0L20 10H0Z\' fill=\'%235c4033\'/%3E%3C/svg%3E');"></div>
                    </div>
                    
                    <div class="flex flex-col gap-4">
                        <button onclick="openDebtModal('${tid}')" class="btn-retro btn-retro-blue py-4 text-lg">Dejar en Deuda / Fiado</button>
                        <div class="flex gap-4"><button onclick="printR('${tid}')" class="flex-1 btn-retro btn-retro-dark py-4 text-lg"><i class="fa-solid fa-print"></i> Ticket</button><button onclick="downloadPDF('${tid}')" class="flex-1 btn-retro btn-retro-red py-4 text-lg"><i class="fa-solid fa-file-pdf"></i> PDF</button></div>
                        <button onclick="closeFinal('${tid}')" class="btn-retro btn-retro-green py-5 text-2xl shadow-[4px_4px_0_#2c1e16]">COBRAR Y CERRAR</button>
                        <button onclick="closeModal()" class="text-[#a89f91] font-bold py-3 hover:text-[#5c4033] uppercase text-sm mt-2 font-mono tracking-widest border-b-2 border-transparent hover:border-[#5c4033] transition w-fit mx-auto">Volver</button>
                    </div>
                </div>`;
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        window.calcCloseTotal = (total) => {
            const checked = document.getElementById('close-card-check').checked;
            const breakdown = document.getElementById('close-breakdown');
            const commEl = document.getElementById('close-comm-val');
            const finalEl = document.getElementById('close-total-val');

            if (checked) {
                const comm = total * 0.04;
                const final = total + comm;
                commEl.innerText = `$${comm.toFixed(2)}`;
                finalEl.innerText = `$${final.toFixed(2)}`;
                breakdown.classList.remove('hidden');
            } else {
                finalEl.innerText = `$${total}`;
                breakdown.classList.add('hidden');
            }
        }

        window.openDebtModal = (tid) => {
            document.getElementById('modal-content').innerHTML = `<div class="p-6 text-center bg-[#f8f1e5] modal-retro border-0 shadow-none">
                    <h3 class="font-black text-3xl mb-4 text-[#a63e3e] uppercase tracking-widest" style="font-family: 'Abril Fatface', cursive; text-shadow: 1px 1px 0 #2c1e16;">DEJAR EN DEUDA</h3>
                    <p class="mb-4 text-[#5c4033] font-bold text-lg font-mono">¬øCu√°nto dinero dejaron a cuenta?</p>
                    
                    <input type="number" id="debt-deposit" value="0" oninput="calcDebtTotal()" class="w-full p-4 text-center text-4xl border-4 double border-[#5c4033] rounded-sm font-black mb-6 outline-none focus:border-[#4a6fa5] transition bg-[#fffdf9] text-[#2c1e16] shadow-[inset_2px_2px_4px_rgba(92,64,51,0.1)]" style="font-family: 'Special Elite', cursive;">
                    
                    <label class="flex items-center justify-center gap-3 mb-6 cursor-pointer bg-[#fffdf9] p-3 rounded-sm shadow-[3px_3px_0_#a89f91] border-2 border-[#a89f91] hover:bg-[#e0d8c8] transition w-fit mx-auto">
                        <input type="checkbox" id="debt-card-check" onchange="calcDebtTotal()" class="w-5 h-5 accent-[#4a6fa5] border-2 border-[#2c1e16]">
                        <span class="font-bold text-[#2c1e16] text-base" style="font-family: 'Abril Fatface', cursive;">Pago con Tarjeta (+4%)</span>
                    </label>

                    <div id="debt-breakdown" class="hidden bg-[#e0d8c8] p-4 rounded-sm mb-6 text-base font-mono border-2 border-[#a89f91] shadow-[2px_2px_0_#a89f91]">
                        <div class="flex justify-between text-[#5c4033]"><span>Monto a Cuenta:</span><span id="debt-base-val">$0</span></div>
                        <div class="flex justify-between text-[#a63e3e] font-bold"><span>Comisi√≥n (4%):</span><span id="debt-comm-val">$0</span></div>
                        <div class="border-t-2 border-dashed border-[#a89f91] my-3"></div>
                        <div class="flex justify-between font-black text-2xl text-[#2c1e16]" style="font-family: 'Special Elite', cursive;"><span>Total a Cobrar:</span><span id="debt-total-val">$0</span></div>
                    </div>

                    <div class="flex gap-4">
                        <button onclick="openCloseAccountModal('${tid}', 0)" class="flex-1 btn-retro btn-retro-neutral py-4 text-[#5c4033]">Cancelar</button>
                        <button onclick="confirmDebt('${tid}')" class="flex-1 btn-retro btn-retro-blue py-4 text-lg">Confirmar Deuda</button>
                    </div>
                </div>`;
        }

        window.calcDebtTotal = () => {
            const val = parseFloat(document.getElementById('debt-deposit').value) || 0;
            const checked = document.getElementById('debt-card-check').checked;
            const breakdown = document.getElementById('debt-breakdown');
            
            if (val > 0 && checked) {
                const comm = val * 0.04;
                const total = val + comm;
                document.getElementById('debt-base-val').innerText = `$${val}`;
                document.getElementById('debt-comm-val').innerText = `$${comm.toFixed(2)}`;
                document.getElementById('debt-total-val').innerText = `$${total.toFixed(2)}`;
                breakdown.classList.remove('hidden');
            } else {
                breakdown.classList.add('hidden');
            }
        }

        window.confirmDebt = async(id) => {
            const deposit = parseFloat(document.getElementById('debt-deposit').value) || 0;
            await updateDoc(doc(db,'tables',id), { status:'debt', debtDate: serverTimestamp(), deposit: deposit });
            closeModal();
            renderWaiterDashboard();
        }

        window.closeFinal = async(id)=>{ if(confirm("¬øEst√°s seguro de cerrar esta mesa?")) { await updateDoc(doc(db,'tables',id),{status:'closed', closedAt:serverTimestamp()}); closeModal(); renderWaiterDashboard(); } }
        
        window.printR = (tid) => {
            const t = tablesData.find(x=>x.id===tid);
            const ords = ordersData.filter(x=>x.tableId===tid && x.status!=='cancelled');
            const total = ords.reduce((acc,c)=>acc+(c.price*c.quantity),0);
            const deposit = t.deposit || 0;
            const remaining = total - deposit;
            const date = new Date().toLocaleString();
            const grouped = {};
            ords.forEach(o => { const key = o.itemName + (o.modifiers ? o.modifiers.join('') : ''); if(!grouped[key]) grouped[key] = { ...o, qty: 0, total: 0 }; grouped[key].qty += o.quantity; grouped[key].total += (o.price * o.quantity); });
            const itemsHtml = Object.values(grouped).map(o => `<div style="margin-bottom:6px; font-size:12px;"><div style="display:flex; justify-content:space-between; font-weight:bold;"><span>${o.qty} x ${o.itemName}</span><span>$${o.total}</span></div>${o.modifiers&&o.modifiers.length?`<div style="font-size:10px; font-style:italic; margin-left:10px;">- ${o.modifiers.join(', ')}</div>`:''}</div>`).join('');
            
            let totalHtml = `<div style="border-top:1px dashed #000; margin-top:15px; padding-top:10px; display:flex; justify-content:space-between; font-weight:bold; font-size:16px;"><span>TOTAL</span><span>$${total}</span></div>`;
            if (deposit > 0) {
                totalHtml = `
                    <div style="border-top:1px dashed #000; margin-top:10px; padding-top:5px; display:flex; justify-content:space-between; font-size:12px;"><span>Subtotal</span><span>$${total}</span></div>
                    <div style="display:flex; justify-content:space-between; font-size:12px;"><span>A Cuenta</span><span>-$${deposit}</span></div>
                    <div style="margin-top:5px; padding-top:5px; border-top:1px solid #000; display:flex; justify-content:space-between; font-weight:bold; font-size:16px;"><span>RESTANTE</span><span>$${remaining}</span></div>
                `;
            }

            document.getElementById('receipt-area').innerHTML = `<div style="text-align:center; margin-bottom:15px; font-family: monospace;"><img src="https://www.dropbox.com/scl/fi/htapbd4yf4m239y9zv2n1/Picture1.png?rlkey=o8je5uxe95avc9i9od6dmpbqh&raw=1" style="width: 60%; max-width: 150px; display: block; margin: 0 auto 10px auto;" onerror="this.style.display='none'"><h2 style="font-weight:bold; font-size:18px; margin:0;">A-LAS DE BARRIL</h2><p style="margin:0; font-size:10px;">--- COPIA CLIENTE ---</p><br><p style="margin:0; font-size:12px;">Ticket #${t.uniqueId||'---'}</p><p style="margin:0; font-size:12px;">${date}</p></div><div style="border-bottom:1px dashed #000; margin-bottom:10px;"></div><div style="font-weight:bold; margin-bottom:10px; font-size:14px;">Mesa: ${t.number}</div>${itemsHtml}${totalHtml}<div style="text-align:center; margin-top:30px; font-size:10px;"><p>¬°Gracias por su visita!</p><p>Wifi: AlasInvitado</p></div>`;
            window.print();
        }

        window.downloadPDF = (tid) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: [80, 200] }); 
            const t = tablesData.find(x=>x.id===tid);
            const ords = ordersData.filter(x=>x.tableId===tid && x.status!=='cancelled');
            const total = ords.reduce((acc,c)=>acc+(c.price*c.quantity),0);
            const deposit = t.deposit || 0;
            const remaining = total - deposit;
            doc.setFontSize(14); doc.text("A-LAS DE BARRIL", 40, 10, { align: "center" });
            doc.setFontSize(10); doc.text("Ticket #" + (t.uniqueId || '---'), 40, 18, { align: "center" });
            doc.text(new Date().toLocaleString(), 40, 23, { align: "center" });
            doc.line(5, 26, 75, 26); doc.text(`Mesa: ${t.number}`, 5, 32);
            let y = 38; doc.setFontSize(9);
            ords.forEach(o => {
                doc.text(`${o.quantity}x ${o.itemName}`, 5, y);
                doc.text(`$${o.price * o.quantity}`, 75, y, { align: "right" });
                y += 5;
                if(o.modifiers && o.modifiers.length) { doc.setFontSize(7); doc.text(`(${o.modifiers.join(', ')})`, 10, y); doc.setFontSize(9); y += 4; }
            });
            doc.line(5, y, 75, y); y += 5;
            if (deposit > 0) {
                doc.text("Subtotal:", 5, y); doc.text(`$${total}`, 75, y, { align: "right" }); y += 5;
                doc.text("A Cuenta:", 5, y); doc.text(`-$${deposit}`, 75, y, { align: "right" }); y += 5;
                doc.setFontSize(12); doc.text("RESTANTE:", 5, y); doc.text(`$${remaining}`, 75, y, { align: "right" });
            } else { doc.setFontSize(12); doc.text("TOTAL:", 5, y); doc.text(`$${total}`, 75, y, { align: "right" }); }
            y += 10; doc.setFontSize(8); doc.text("¬°Gracias por su visita!", 40, y, { align: "center" });
            doc.save(`Ticket_Mesa_${t.number}.pdf`);
        }

        initApp();
    </script>
</body>
</html>
